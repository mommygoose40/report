<!DOCTYPE html>
<html>
<head>
    <title>災情回報</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        body { font-family: Arial; padding: 20px; max-width: 500px; margin: 0 auto; }
        button { padding: 10px; margin: 5px; background-color: #4a86e8; color: white; border: none; border-radius: 5px; }
        #audio-playback { margin-top: 15px; width: 100%; }
        input, textarea { width: 100%; padding: 8px; margin: 5px 0; box-sizing: border-box; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        .required::after { content: " *"; color: red; }
    </style>
</head>
<body>
    <h1>災情回報系統</h1>
    
    <div class="form-group">
        <label class="required">觀測位置</label>
        <input type="text" id="location" placeholder="請輸入詳細位置" required>
    </div>
    
    <div class="form-group">
        <label class="required">巡視類型</label>
        <select id="inspection-type" required>
            <option value="">請選擇</option>
            <option value="例行巡查">例行巡查</option>
            <option value="緊急巡查">緊急巡查</option>
            <option value="民眾通報">民眾通報</option>
        </select>
    </div>
    
    <div class="form-group">
        <label class="required">災害類型</label>
        <select id="disaster-type" required>
            <option value="">請選擇</option>
            <option value="積水">積水</option>
            <option value="道路損壞">道路損壞</option>
            <option value="樹木倒塌">樹木倒塌</option>
            <option value="其他">其他</option>
        </select>
    </div>
    
    <div class="form-group">
        <label>緊急程度</label>
        <select id="urgency">
            <option value="低">低</option>
            <option value="中" selected>中</option>
            <option value="高">高</option>
        </select>
    </div>
    
    <div class="form-group">
        <label>相片上傳</label>
        <input type="file" id="photo-upload" accept="image/*">
    </div>
    
    <div class="form-group">
        <label>語音說明</label>
        <button id="record-btn">開始錄音</button>
        <div id="audio-status">（尚未錄音）</div>
        <audio id="audio-playback" controls style="display:none; width:100%;"></audio>
    </div>
    
    <div class="form-group">
        <label class="required">文字摘要</label>
        <textarea id="summary" rows="3" placeholder="請簡要描述災情狀況（至少20字）" required></textarea>
    </div>
    
    <div class="form-group">
        <label>備註</label>
        <textarea id="note" rows="2" placeholder="其他補充說明"></textarea>
    </div>
    
    <div class="form-group">
        <label class="required">回報者</label>
        <input type="text" id="reporter" placeholder="您的姓名" required>
    </div>
    
    <button id="submit-btn" style="background-color: #e74c3c; width: 100%; padding: 12px;">提交災情回報</button>

    <script>
        // 初始化LIFF
        liff.init({ liffId: '2007934728-xN6aOL3D' })
            .then(() => {
                if (!liff.isLoggedIn()) {
                    liff.login();
                } else {
                    setupUI();
                }
            })
            .catch(err => {
                console.error('LIFF初始化失敗:', err);
                alert('系統初始化失敗，請稍後再試');
            });

        let audioBlob = null;
        
        function setupUI() {
            // 獲取用戶資料
            liff.getProfile()
                .then(profile => {
                    document.getElementById('reporter').value = profile.displayName || '';
                });
            
            // 錄音按鈕
            document.getElementById('record-btn').addEventListener('click', async () => {
                try {
                    const recording = await liff.recordAudio({
                        maxDuration: 30, // 最長30秒
                        title: '災情語音說明',
                        message: '請描述災情狀況'
                    });
                    
                    // 顯示錄音結果
                    document.getElementById('audio-status').textContent = '✓ 已錄音 (' + recording.duration + '秒)';
                    const audioPlayer = document.getElementById('audio-playback');
                    audioPlayer.src = recording.url;
                    audioPlayer.style.display = 'block';
                    audioBlob = recording.blob;
                    
                } catch (err) {
                    console.error('錄音失敗:', err);
                    alert(`錄音失敗: ${err.message}`);
                }
            });

            // 提交按鈕
            document.getElementById('submit-btn').addEventListener('click', async () => {
                try {
                    // 驗證必填欄位
                    if (!validateForm()) return;
                    
                    // 顯示載入中
                    const btn = document.getElementById('submit-btn');
                    btn.disabled = true;
                    btn.textContent = '提交中...';
                    
                    // 處理相片上傳
                    let photoUrl = null;
                    const photoFile = document.getElementById('photo-upload').files[0];
                    if (photoFile) {
                        photoUrl = await uploadFile(photoFile);
                    }
                    
                    // 處理音檔上傳
                    let voiceUrl = null;
                    if (audioBlob) {
                        voiceUrl = await uploadFile(audioBlob, 'audio.mp3');
                    }
                    
                    // 準備提交數據
                    const formData = {
                        觀測位置: document.getElementById('location').value,
                        巡視類型: document.getElementById('inspection-type').value,
                        災害類型: document.getElementById('disaster-type').value,
                        緊急程度: document.getElementById('urgency').value,
                        photoUrl: photoUrl,
                        voiceUrl: voiceUrl,
                        備註: document.getElementById('note').value,
                        回報者: document.getElementById('reporter').value,
                        最新資訊: document.getElementById('summary').value
                    };
                    
                    // 提交到Google Apps Script
                    const response = await fetch('YOUR_APPS_SCRIPT_WEB_APP_URL', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(formData)
                    });
                    
                    const result = await response.json();
                    if (result.status === 'success') {
                        alert('災情回報成功！');
                        liff.closeWindow();
                    } else {
                        throw new Error(result.message);
                    }
                } catch (err) {
                    console.error('提交失敗:', err);
                    alert('提交失敗: ' + err.message);
                    document.getElementById('submit-btn').disabled = false;
                    document.getElementById('submit-btn').textContent = '提交災情回報';
                }
            });
        }
        
        function validateForm() {
            const requiredFields = [
                'location', 'inspection-type', 'disaster-type', 
                'summary', 'reporter'
            ];
            
            for (const fieldId of requiredFields) {
                const element = document.getElementById(fieldId);
                if (!element.value.trim()) {
                    alert(`請填寫「${element.previousElementSibling.textContent}」欄位`);
                    element.focus();
                    return false;
                }
            }
            
            if (document.getElementById('summary').value.length < 20) {
                alert('文字摘要請至少輸入20字');
                document.getElementById('summary').focus();
                return false;
            }
            
            return true;
        }
        
        async function uploadFile(file, fileName = null) {
            try {
                const formData = new FormData();
                formData.append('file', file, fileName || file.name);
                
                // 這裡需要替換為您的文件上傳端點
                const response = await fetch('YOUR_FILE_UPLOAD_ENDPOINT', {
                    method: 'POST',
                    body: formData
                });
                
                if (!response.ok) {
                    throw new Error('文件上傳失敗');
                }
                
                const result = await response.json();
                return result.url;
            } catch (err) {
                console.error('文件上傳錯誤:', err);
                return null;
            }
        }
    </script>
</body>
</html>