<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>ç½æƒ…å›å ±ç³»çµ±</title>
<script src="https://static.line-scdn.net/liff/edge/versions/2.22.3/sdk.js"></script>
<!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-analytics.js";
    import { getStorage, ref, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-storage.js";

    // Firebase è¨­å®š
    const firebaseConfig = {
  apiKey: "AIzaSyA4IZ6yZxlOuIjarWmUtIHGyLk84056K2Q",
  authDomain: "reportsystem-c5fc7.firebaseapp.com",
  projectId: "reportsystem-c5fc7",
  storageBucket: "reportsystem-c5fc7.firebasestorage.app",
  messagingSenderId: "845064058181",
  appId: "1:845064058181:web:31d2f0fa6dfed084befa2c",
  measurementId: "G-EDQM0LWQWH"
};

    // åˆå§‹åŒ– Firebase
    const app = initializeApp(firebaseConfig);
    const storage = getStorage(app);

    // å°‡ Firebase åŠŸèƒ½æš´éœ²çµ¦å…¨å±€ä½¿ç”¨
    window.firebaseStorage = { getStorage, ref, uploadBytesResumable, getDownloadURL, storage };
  </script>
<style>
/* === åŸºæœ¬æ’ç‰ˆè¨­å®š === */
body {
  font-family: Arial, sans-serif;
  background-color: #f5f8ff;  /* èƒŒæ™¯é¡è‰² */
  color: #000;                /* æ–‡å­—é¡è‰² */
  margin: 0;
  padding: 0;
}

/* å…§å®¹å€åŸŸçš„æœ€å¤§å¯¬åº¦ */
.container {
  max-width: 800px;
  margin: 0 auto;   /* å±…ä¸­ */
  padding: 20px;
}

/* é é¢æ¨™é¡Œæ¨£å¼ */
.header {
  text-align: center;
  color: #000;
  border-bottom: 2px solid #0b5ed7; /* åº•éƒ¨è—è‰²é‚Šæ¡† */
  padding-bottom: 10px;
  margin-bottom: 20px;
}

/* æ­¥é©Ÿæ¨™é¡Œæ¨£å¼ */
.step-title {
  font-weight: 700;
  font-size: 22px;
  color: #000;
  margin-bottom: 14px;
}

/* è¡¨å–®å€å¡Šæ¨£å¼ */
.form-section {
  background: white;
  border-radius: 8px;
  border: 2px solid #d0d7e2;  /* è¼•ç°è‰²é‚Šæ¡† */
  padding: 20px;
  margin-bottom: 20px;
}

/* === æŒ‰éˆ•æ¨£å¼çµ±ä¸€è¨­å®š === */
.ui-btn {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  padding: 10px 18px;          /* èˆ‡ç›¸æ©Ÿ/ç›¸ç°¿æŒ‰éˆ•ä¸€è‡´çš„é–“è· */
  margin: 6px 4px;             /* æŒ‰éˆ•å¤–é‚Šè· */
  background: #0b5ed7;         /* æŒ‰éˆ•èƒŒæ™¯é¡è‰² */
  color: #fff;                 /* æ–‡å­—é¡è‰² */
  border: none;                /* å»é™¤é‚Šæ¡† */
  border-radius: 6px;          /* åœ“è§’è¨­è¨ˆ */
  font-size: 21px;             /* å­—é«”å¤§å° */
  line-height: 1.2;            /* è¡Œé«˜è¨­ç½®ï¼Œé¿å…å­—å¤ªæ“  */
  text-align: center;          /* æ–‡å­—å±…ä¸­ */
  cursor: pointer;
  
  /* ç”¨æ–¼è§¸æ§è¨­å‚™çš„å„ªåŒ– */
  -webkit-tap-highlight-color: transparent; 
  -webkit-user-select: none;  /* ç¦æ­¢æ–‡å­—é¸æ“‡ */
  user-select: none;          /* ç¦æ­¢æ–‡å­—é¸æ“‡ */
  
  /* ä¿è­‰å’Œæ•´é«”é é¢ä¸€è‡´ */
  font-family: inherit;  
  box-sizing: border-box;     /* ä¿è­‰é‚Šæ¡†å’Œå…§é‚Šè·ä¸æœƒå½±éŸ¿å°ºå¯¸è¨ˆç®— */
}

/* --- å¯é¸ï¼šæŒ‰éˆ•çš„å…¶ä»–ç‹€æ…‹æ¨£å¼ --- */
.ui-btn:active {
  filter: brightness(0.7);  /* æŒ‰éˆ•è¢«æŒ‰ä¸‹æ™‚çš„äº®åº¦è®Šæš—æ•ˆæœ */
}

/* ç´…è‰²å‹ */
.ui-btn.red {
  background: #dc3545;
}

/* ç°è‰²å‹ */
.ui-btn.gray {
  background: #60748f !important;
}

/* è—è‰²å‹ */
.ui-btn.blue {
  background: #0b5ed7;
}

/* === ç¸®åœ– === */
.thumbs {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
  margin-top: 10px;
  align-items: flex-start;
}
.thumb {
  position: relative;
  width: 90px;
  height: 90px;
  flex: 0 0 auto;
  border-radius: 6px;
  overflow: hidden;
  border: 1px solid #ccc;
  background: #f9f9f9;
}
.thumb img {
  width: 100%;
  height: 100%;
  object-fit: cover;
  display: block;
}

/* ç¸®åœ–å°å‰å‰ */
.thumb .delete-btn {
  position: absolute;
  top: 4px;
  right: 4px;
  background: rgba(220, 53, 69, 0.9);
  color: #fff;
  border: none;
  border-radius: 50%;
  font-size: 18px;
  width: 24px;
  height: 24px;
  line-height: 22px;
  text-align: center;
  cursor: pointer;
  padding: 0;
  -webkit-tap-highlight-color: transparent;
  transition: none;
  display: flex;
  align-items: center;
  justify-content: center;
}

/* åŠ è™ŸæŒ‰éˆ• */
.add-photo {
  width: 90px;
  height: 90px;
  flex: 0 0 auto;
  border: 2px dashed #9bb4e9;
  border-radius: 6px;
  display: flex;
  align-items: center;
  justify-content: center;
  color: #0b5ed7;
  font-size: 36px;
  cursor: pointer;
  background: #f0f4ff;
  transition: none;
}
.add-photo:active {
  background: #c0d2ff;
  filter: brightness(0.7);
}

/* === Modal === */
.modal {
  display: none;
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: rgba(0,0,0,0.7);
  justify-content: center;
  align-items: center;
  z-index: 2000;
}

/* Modalå…§å®¹ */
.modal-content {
  background: #fff;
  border-radius: 8px;
  padding: 20px;
  width: 90%;
  max-width: 500px;
  max-height: 85vh;
  position: relative;
  overflow: hidden;
  text-align: center;
}

/* æ¨™é¡Œèˆ‡å‰å‰æ°´å¹³å°é½Š */
.header-line {
  display: flex;
  align-items: center;
  justify-content: center;
  position: relative;
  width: 100%;
  margin-bottom: 10px;
}
#modalTitle {
  font-size: 22px;
  font-weight: bold;
  color: #000;
  flex: 1;
  text-align: center;
}

/* é—œé–‰å‰å‰ */
#closeModalBtn {
  position: absolute;
  right: 10px;
  top: 50%;
  transform: translateY(-50%);
  font-size: 40px;
  background: none;
  border: none;
  color: #000;
  cursor: pointer;
  -webkit-tap-highlight-color: transparent;
  transition: none;
  width: 40px;
  height: 40px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 50%;
}

/* === é è¦½åœ–ç‰‡è‡ªé©æ‡‰ï¼‹ç°åº•ï¼‹é‚Šæ¡† === */
.preview-image-container {
  position: relative;
  display: flex;
  justify-content: center;
  align-items: center;
  width: 100%;
  max-width: 90vw;
  height: 70vh;
  margin: 15px auto;
  background: #f0f0f0;    /* ç°åº• */
  border: 2px solid #d0d7e2; /* æ·ºç°é‚Šæ¡† */
  border-radius: 8px;
  overflow: hidden;
}

/* åœ–ç‰‡å®Œæ•´é¡¯ç¤ºã€ç½®ä¸­ä¸è£åˆ‡ */
.preview-image {
  max-width: 100%;
  max-height: 100%;
  width: auto;
  height: auto;
  object-fit: contain;
  display: block;
  margin: 0 auto;
  /*transition: opacity 0.3s ease;*/
}

/* å·¦å³ç®­é ­ */
.nav-btn {
  position: absolute;
  top: 50%;
  transform: translateY(-50%);
  background: rgba(0,0,0,0.45);
  border: none;
  color: #fff;
  font-size: 28px;
  padding: 10px 16px;
  cursor: pointer;
  border-radius: 8px;
  -webkit-tap-highlight-color: transparent;
  transition: none;
}
.nav-btn:active {
  background: rgba(0,0,0,0.35);
  filter: brightness(0.7);
}
.nav-btn.disabled {
  opacity: 0.35;
  pointer-events: none;
}
.nav-left { left: 10px; }
.nav-right { right: 10px; }

/* å›ºå®šèƒŒæ™¯ */
body.modal-open {
  overflow: hidden;
}

/* æ“ä½œæŒ‰éˆ•å€åŸŸ */
.action-buttons {
  margin-top: 15px;
  display: flex;
  justify-content: center;
  gap: 15px;
}

.action-buttons button {
  min-width: 100px;
  font-size: 21px;
}



/* === çµ±ä¸€äº’å‹•ç°æš—å›é¥‹ === */

/* ç¢ºä¿æ‰€æœ‰æŒ‰éˆ•éƒ½æœ‰ç›¸åŒçš„äº’å‹•æ•ˆæœ */
button,
label.ui-btn,
.add-photo,
.nav-btn,
#closeModalBtn,
.thumb .delete-btn {
  -webkit-tap-highlight-color: transparent;
  -webkit-user-select: none;
  user-select: none;
  transition: none !important;
}

/* ç§»é™¤ hover æ•ˆæœï¼Œåªä¿ç•™ active æ•ˆæœ */
button:hover,
label.ui-btn:hover,
.add-photo:hover,
.nav-btn:hover,
#closeModalBtn:hover,
.thumb .delete-btn:hover {
  filter: none !important;
}

/* å³æ™‚ç°æš—æ•ˆæœï¼ˆæ‰€æœ‰äº’å‹•å…ƒç´ å…±ç”¨ï¼‰ */
.temp-active {
  filter: brightness(0.7) !important;
  transition: none !important;
}

/* å…¶ä»–è¡¨å–®å…ƒç´  */
input[type="text"] {
  padding: 12px;
  width: 95%;
  border: 2px solid #ccc;
  border-radius: 6px;
  font-size: 16px;
  transition: all 0.2s ease;
  color: #000;
}
input[type="text"]:focus {
  border-color: #0b5ed7;
  box-shadow: 0 0 5px rgba(11,94,215,0.4);
  outline: none;
}
.form-section label {
  font-size: 21px;
  margin-bottom: 6px;
  display: inline-block;
}
/* === è¼‰å…¥åœˆæ¨£å¼ === */
.spinner-circle {
  border: 5px solid #d0d7e2;
  border-top: 5px solid #0b5ed7;
  border-radius: 50%;
  width: 50px;
  height: 50px;
  animation: spin 1s linear infinite;
  margin: 0 auto 10px auto;
}
.spinner-text {
  color: #666;
  font-size: 18px;
}
@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}
@keyframes fadeOut {
  0% { opacity: 1; }
  80% { opacity: 1; }
  100% { opacity: 0; }
}

/* === éŒ„éŸ³å½ˆçª—å°ˆç”¨æ¨£å¼ === */
#recordModal .modal-content {
  width: 85%;
  max-width: 400px;
  background: #fff;
  border-radius: 12px;
  padding: 24px 20px;
  text-align: center;
  color: #000;
  box-shadow: 0 4px 20px rgba(0,0,0,0.3);
}

#recordModal .modal-content button {
  padding: 10px 24px;
  font-size: 18px;
  border-radius: 6px;
  border: none;
  color: #fff;
  cursor: pointer;
}

#recordModal .modal-content .red-text {
  color: #d32f2f;
  font-size: 22px;
  font-weight: bold;
  margin-bottom: 15px;
}

#recordModal audio {
  width: 100%;
  max-width: 350px;
  margin: 10px auto;
  display: block;
}

.record-status {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 10px;
  margin-bottom: 18px;
  line-height: 1;
}

.record-dot {
  width: 14px;
  height: 14px;
  background: #d32f2f;
  border-radius: 50%;
  animation: blink 1s infinite;
}

.red-text {
  font-size: 24px;
  font-weight: 600;
  position: relative;
  top: 6px; /* ğŸ”¹åªç§»æ–‡å­—ï¼Œä¸å‹•ç´…é» */
}

@keyframes blink {
  0%, 50%, 100% { opacity: 1; }
  25%, 75% { opacity: 0; }
}
</style>
</head>

<body>
<!-- é è¦½ Modal -->
<div id="imgModal" class="modal">
  <div class="modal-content">
    <div class="header-line">
      <div id="modalTitle">è«‹ç¢ºèªç…§ç‰‡</div>
      <label id="closeModalBtn" class="ui-btn" onclick="closePreviewModal()">Ã—</label>
    </div>

    <div class="preview-image-container">
      <img id="previewImage" class="preview-image" src="">
      <label class="ui-btn nav-btn nav-left" id="navLeft" onclick="changePreview(-1)">&#10094;</label>
      <label class="ui-btn nav-btn nav-right" id="navRight" onclick="changePreview(1)">&#10095;</label>
    </div>

    <div class="action-buttons">
      <label id="deleteCurrentBtn" class="ui-btn red" onclick="deletePreviewPhoto()">åˆªé™¤é€™å¼µ</label>
      <label id="confirmBtn" class="ui-btn blue" onclick="handleConfirm()">ç¢ºèªå®Œæˆ</label>
    </div>
  </div>
</div>

<div class="container">
  <div class="header"><h1>é€šå ±å¹³å°</h1></div>

  <!-- Step 0 -->
<div class="form-section">
  <div class="step-title">â‘  é€šå ±é¡å‹(å¿…å¡«)</div>
  <label><input type="radio" name="patrolType" value="å¹³æ™‚"> å¹³æ™‚</label>
  <label style="margin-left:25px;"><input type="radio" name="patrolType" value="ç½ä¸­"> ç½ä¸­</label>
  <label style="margin-left:25px;"><input type="radio" name="patrolType" value="å…¶ä»–"> å…¶ä»–</label>
</div>

<!-- Step 1 -->
<style>
  .tight-row { display:flex; align-items:center; gap:16px; line-height:1.4; margin-top:6px; }
  .tight-group { display:flex; flex-wrap:wrap; gap:12px 20px; line-height:1.4; margin-top:6px; }
  .tight-group label, .tight-row label { margin:0; }
</style>

<div class="form-section">
  <div class="step-title">â‘¡ åŒè¡Œå¿—å·¥</div>

  <div class="tight-group">
    <label><input type="checkbox" name="companions" value="å¿—å·¥A"> å¿—å·¥A</label>
    <label><input type="checkbox" name="companions" value="å¿—å·¥B"> å¿—å·¥B</label>
    <label><input type="checkbox" name="companions" value="å¿—å·¥C"> å¿—å·¥C</label>
    <label>
      <input type="checkbox" id="otherCompanion" name="companions" value="å…¶ä»–">
      å…¶ä»–
      <span id="otherCompanionWrap" style="display:none;">
        ï¼š<input type="text" id="otherCompanionName" name="otherCompanionName" placeholder="è¼¸å…¥å§“å" style="width:150px;">
      </span>
    </label>
  </div>
</div>

<!-- Step 2 -->
<div class="form-section">
  <div class="step-title">â‘¢ æ–°å¢ç…§ç‰‡(1~20å¼µ)(å¿…å¡«)</div>

  <label id="openCameraBtn" class="ui-btn" onclick="openCamera()">é–‹ç›¸æ©Ÿ</label>
  <input id="fileCamera" type="file" accept="image/*" capture="environment" style="display:none;">

  <label id="openGalleryBtn" class="ui-btn" onclick="openGallery()">é–‹ç›¸ç°¿</label>
  <input id="fileGallery" type="file" accept="image/*" multiple style="display:none;">

  <div class="thumbs" id="thumbs"></div>
</div>

<!-- Step 3 -->
<div class="form-section">
  <div class="step-title">â‘£ ç…§ç‰‡èªªæ˜</div>

  <label id="recordBtn" class="ui-btn" onclick="startRecording()">é–‹å§‹éŒ„éŸ³</label>
  <div style="margin:0 0 6px 0;color:#d32f2f;font-weight:700;font-size:20px;">
    â€» è«‹å…è¨±ä½¿ç”¨éº¥å…‹é¢¨
  </div>

  <audio id="audioPlayback" controls style="display:none;width:100%;max-width:400px;"></audio>

  <div style="margin-top:20px;">
    <input type="text" id="summary" placeholder="è¼¸å…¥ç…§ç‰‡èªªæ˜æ–‡å­—" maxlength="50"/>
  </div>
</div>

<!-- éŒ„éŸ³å½ˆçª— -->
<div id="recordModal" class="modal" style="
  display:none;
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.6);
  align-items:center;
  justify-content:center;
  z-index:9999;
  pointer-events:auto;">
</div>

<!-- Step 4 -->
<style>
  .tight-row {
    display: flex;
    align-items: center;
    gap: 16px;
    line-height: 1.4;
    margin-top: 6px;
  }
  .tight-group {
    display: flex;
    flex-wrap: wrap;
    gap: 12px 20px;
    line-height: 1.4;
  }
  .tight-group label,
  .tight-row label {
    margin: 0;
  }
  /* é—œéµï¼šæ¨™é¡Œèˆ‡ä¸Šæ–¹å€å¡Šä¿æŒåŒè·é›¢ */
  .tight-title {
    font-weight: 700;
    font-size: 21px;
    margin-top: 18px; /* èˆ‡ä¸»æ¨™é¡Œè·é›¢ä¸€è‡´ */
    margin-bottom: 12px; /* åŠ å¤§èˆ‡ checkbox çš„é–“è· */
  }
  .bottom-group {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-top: 10px; /* èª¿æ•´å›æ­£å¸¸æ¬„è·ï¼Œèˆ‡ä¸Šæ–¹ä¸€è‡´ */
  }
</style>

<div class="form-section">
  <div class="step-title">â‘¤ æ˜¯å¦æœ‰ç½æƒ…æˆ–ç•°å¸¸æƒ…æ³ï¼Ÿ</div>

  <div class="tight-row">
    <label><input type="radio" name="disaster" value="æ­£å¸¸" onchange="toggleDisasterTypes()"> æ­£å¸¸</label>
    <label><input type="radio" name="disaster" value="ç•°å¸¸" onchange="toggleDisasterTypes()"> ç•°å¸¸</label>
  </div>

  <div id="disasterTypes" style="display:none;">
    <div class="tight-title">- è«‹å‹¾é¸ç•°å¸¸é¡å‹ï¼š</div>

    <div class="tight-group">
      <label><input type="checkbox" name="disasterType" value="è¨­æ–½æå£"> è¨­æ–½æå£</label>
      <label><input type="checkbox" name="disasterType" value="ç©æ·¹æ°´ã€æ°´æƒ…ç•°å¸¸"> ç©æ·¹æ°´ã€æ°´æƒ…ç•°å¸¸</label>
      <label><input type="checkbox" name="disasterType" value="æ°´æºç’°å¢ƒæ±™æŸ“"> æ°´æºç’°å¢ƒæ±™æŸ“</label>
      <label><input type="checkbox" name="disasterType" value="å±±å´©ã€åœ°å±¤ä¸‹é™·"> å±±å´©ã€åœ°å±¤ä¸‹é™·</label>
    </div>

    <div class="bottom-group">
      <label>
        <input type="checkbox" id="otherDisaster" name="disasterType" value="å…¶ä»–">
        å…¶ä»–
        <span id="otherDisasterWrap" style="display:none;">
          ï¼š<input type="text" id="otherDisasterText" name="otherDisasterText" placeholder="è¼¸å…¥é¡å‹
          èªªæ˜" style="width:150px;">
        </span>
      </label>
    </div>
  </div>
</div>

  <!-- Submit -->
  <div class="form-section" style="text-align:center;">
    <label id="submitBtn" class="ui-btn" onclick="submitForm()">æäº¤å›å ±</label>
    <div id="serverStatus">ä¼ºæœå™¨ç‹€æ…‹ï¼šæª¢æŸ¥ä¸­...</div>
  </div>
</div>

<script>
const WEB_APP_URL='https://script.google.com/macros/s/AKfycbzW8WPXwSdadEgob2fyBs3u5rbVnv_O2Xv26jhdX4stdCbWYIRgV59Yj4EW9UoNjtA68A/exec';

// åˆå§‹åŒ– LIFF
liff.init({liffId:'2007934728-xN6aOL3D'}).then(async()=>{
  if(!liff.isLoggedIn()) liff.login();
  try {
  const r = await fetch(WEB_APP_URL);
  if (!r.ok) throw new Error(r.status);
  document.getElementById('serverStatus').textContent='ä¼ºæœå™¨ç‹€æ…‹ï¼šå·²é€£ç·š';
  document.getElementById('serverStatus').style.color='#0b5ed7';
} catch (err) {
  document.getElementById('serverStatus').textContent='ä¼ºæœå™¨ç‹€æ…‹ï¼šç„¡æ³•é€£ç·š (' + err.message + ')';
  document.getElementById('serverStatus').style.color='red';
}
});

const otherCheck = document.getElementById('otherCompanion');
  const wrap = document.getElementById('otherCompanionWrap');
  const input = document.getElementById('otherCompanionName');
  otherCheck.addEventListener('change', () => {
    wrap.style.display = otherCheck.checked ? 'inline' : 'none';
    if (!otherCheck.checked) input.value = '';
  });

// === ç…§ç‰‡è®Šæ•¸ ===
const photos = [];
const thumbs = document.getElementById("thumbs");
const imgModal = document.getElementById("imgModal");
const fileCamera = document.getElementById("fileCamera");
const fileGallery = document.getElementById("fileGallery");
const MAX_TOTAL = 20;
const MAX_PER_BATCH = 20;
// åµæ¸¬ iPhone è£ç½®
const isiPhone = /iPhone|iPad|iPod/i.test(navigator.userAgent);

// === é è¦½ç‹€æ…‹ ===
let previewMode = ""; // confirm | preview
let previewFiles = [];
let previewIndex = 0;
let skipNextAddTip = false; // â† æ–°å¢è®Šæ•¸
let isSelectingSource = false; // iPhone é¸æ“‡ä¾†æºä¸­æ¨™è¨˜

async function makePreviewURLs(files) {
  const urls = [];
  for (const f of files) {
    const reader = new FileReader();
    const url = await new Promise(res => {
      reader.onload = () => res(reader.result);
      reader.readAsDataURL(f);
    });
    urls.push({ file: f, url });
  }
  return urls;
}

function safeCreateURL(file) {
  try {
    return URL.createObjectURL(file);
  } catch {
    const reader = new FileReader();
    return new Promise(resolve => {
      reader.onload = () => resolve(reader.result);
      reader.readAsDataURL(file);
    });
  }
}

function disableAddButtons() {
  document.querySelectorAll(".add-photo, #openCameraBtn, #openGalleryBtn").forEach(btn => {
    if (!btn) return;

    // ä¿æŒå¯é»ï¼Œä½†è®Šæ·¡
    btn.style.opacity = "0.4";
    btn.style.filter = "grayscale(50%)";
    btn.style.pointerEvents = ""; // ä¸ç¦ç”¨ï¼Œä»å¯è§¸ç™¼æç¤º
    btn.onclick = () => showMessage("ç„¡æ³•æ–°å¢ï¼Œå·²é” 20 å¼µä¸Šé™");
  });

  fileCamera.disabled = false;
  fileGallery.disabled = false;
}

function enableAddButtons() {
  document.querySelectorAll(".add-photo, #openCameraBtn, #openGalleryBtn").forEach(btn => {
    if (!btn) return;

    // æ¢å¾©æ­£å¸¸æ¨£å¼
    btn.style.opacity = "1";
    btn.style.filter = "none";
    btn.style.pointerEvents = "";

    // é‡æ–°ç¶å›åŸæœ‰è¡Œç‚º
    if (btn.classList.contains("add-photo")) {
      btn.onclick = () => showAddLimitMessage(() => fileGallery.click());
    } else if (btn.id === "openCameraBtn") {
      btn.onclick = openCamera;
    } else if (btn.id === "openGalleryBtn") {
      btn.onclick = openGallery;
    }
  });

  fileCamera.disabled = false;
  fileGallery.disabled = false;
}

function showAddLimitMessage(openAction) {
  if (photos.length >= MAX_TOTAL) {
    showMessage("ç„¡æ³•æ–°å¢ï¼Œå·²é” 20 å¼µä¸Šé™");
    return;
  }

  // iPhoneï¼šç›´æ¥é–‹é¸å–®ï¼Œé¸å®Œå¾Œå†è·³æç¤º
  if (isiPhone) {
    fileGallery.click();

    const handleBlur = () => {
      fileGallery.removeEventListener("blur", handleBlur);
      setTimeout(() => {
        const remainAfter = MAX_TOTAL - photos.length;
        if (remainAfter <= 0) return;
        if (remainAfter < MAX_TOTAL)
          showMessage(`æ‚¨é‚„å¯ä»¥æ–°å¢ <b>${remainAfter}</b> å¼µç…§ç‰‡`);
      }, 400);
    };
    fileGallery.addEventListener("blur", handleBlur);
    return;
  }

  // å…¶ä»–è£ç½®ç¶­æŒåŸæœ¬è¡Œç‚º
  if (skipNextAddTip) {
    skipNextAddTip = false;
    if (typeof openAction === "function") openAction();
    return;
  }

  const remain = MAX_TOTAL - photos.length;
  showMessage(`æ‚¨é‚„å¯ä»¥æ–°å¢ <b>${remain}</b> å¼µç…§ç‰‡`, openAction);
}

function openGallery() {
  const remain = MAX_TOTAL - photos.length;
  if (remain <= 0) {
    showMessage("ç„¡æ³•æ–°å¢ï¼Œå·²é” 20 å¼µä¸Šé™");
    return;
  }

  // iPhoneï¼šå…ˆé–‹é¸å–®ï¼Œé¸å®Œå†è·³æç¤º
  if (isiPhone) {
    fileGallery.click();

    const handleBlur = () => {
      fileGallery.removeEventListener("blur", handleBlur);
      setTimeout(() => {
        const remainAfter = MAX_TOTAL - photos.length;
        if (remainAfter <= 0) return;
        if (remainAfter < MAX_TOTAL)
          showMessage(`æ‚¨é‚„å¯ä»¥æ–°å¢ <b>${remainAfter}</b> å¼µç…§ç‰‡`);
      }, 400);
    };
    fileGallery.addEventListener("blur", handleBlur);
    return;
  }

  // å…¶ä»–è£ç½®ï¼šç¶­æŒèˆŠé‚è¼¯
  if (skipNextAddTip) {
    skipNextAddTip = false;
    fileGallery.click();
    return;
  }

  if (remain === MAX_TOTAL) {
    fileGallery.click();
    return;
  }

  showMessage(`æ‚¨é‚„å¯ä»¥æ–°å¢ <b>${remain}</b> å¼µç…§ç‰‡`, () => {
    fileGallery.click();
  });
}

function openCamera() {
  const remain = MAX_TOTAL - photos.length;
  if (remain <= 0) {
    showMessage("ç„¡æ³•æ–°å¢ï¼Œå·²é” 20 å¼µä¸Šé™");
    return;
  }
  fileCamera.click();
}

fileCamera.addEventListener("change", () => {
  if (fileCamera.files[0]) confirmUpload([fileCamera.files[0]]);
  fileCamera.value = "";
});

fileGallery.addEventListener("change", () => {
  document.getElementById("customModal")?.remove(); // â† é–‹ç›¸ç°¿å¾Œå›ä¾†æ™‚ç§»é™¤èˆŠæç¤º
  if (!fileGallery.files.length) return;

  const remaining = MAX_TOTAL - photos.length;
  const selected = fileGallery.files.length;

  if (selected > MAX_PER_BATCH) {
  showMessage(
    `è¶…é <span style="color:red;font-weight:bold;">${MAX_PER_BATCH}</span> å¼µä¸Šé™ï¼Œè«‹é‡æ–°é¸æ“‡`
  );
  fileGallery.value = "";
  return;
}

  if (selected > remaining) {
  showMessage(
    `åªèƒ½æ–°å¢ <span style="color:red;font-weight:bold;">${remaining}</span> å¼µï¼Œè«‹é‡æ–°é¸æ“‡`
  );
  skipNextAddTip = true; // ä¸‹ä¸€æ¬¡é–‹ç›¸ç°¿ä¸è·³æç¤º

  // å»¶é²æ¸…ç©ºé¿å…é–ƒçˆ
  setTimeout(() => {
    fileGallery.value = "";
  }, 300);
  return;
}

  confirmUpload([...fileGallery.files]);
  fileGallery.value = "";
});

// === iPhone: é¸å–®å½ˆå‡ºå¾Œé¡¯ç¤ºæç¤ºçª—ï¼ˆè¦–è¦ºåŒæ­¥ï¼‰ ===
fileGallery.addEventListener("focus", () => {
  if (!isiPhone) return;

  const remain = MAX_TOTAL - photos.length;
  if (remain <= 0) {
    fileGallery.blur();
    showMessage("ç„¡æ³•æ–°å¢ï¼Œå·²é” 20 å¼µä¸Šé™");
    return;
  }

  // ç­‰ iOS é¸å–®å½ˆå‡ºå¾Œå†é¡¯ç¤ºæç¤ºï¼ˆä¸æ¶ç„¦é»ï¼‰
  setTimeout(() => {
    const active = document.activeElement === fileGallery;
    if (active) {
      showMessage(`æ‚¨é‚„å¯ä»¥æ–°å¢ <b>${remain}</b> å¼µç…§ç‰‡`);
    }
  }, 600); // 0.6 ç§’å»¶é²æœ€è‡ªç„¶
});

function renderThumbs() {
  thumbs.innerHTML = "";  // æ¸…ç©ºç¸®åœ–å€åŸŸ

// ğŸ”¹ è‹¥æœ‰ç…§ç‰‡ï¼Œå…ˆé¡¯ç¤ºæç¤ºï¼ˆå‡ºç¾åœ¨ç¸®åœ–ä¸Šæ–¹ï¼‰
if (photos.length > 0) {
  const hint = document.createElement("div");
  hint.style.cssText = `
    width:100%;
    display:block;
    text-align:center;
    margin:0 0 5px 0;
    order:-1;             /* ğŸ”¹ç¢ºä¿å‡ºç¾åœ¨æœ€ä¸Šé¢ */
    flex-basis:100%;      /* ğŸ”¹å¼·åˆ¶ç¨ä½”ä¸€æ•´è¡Œ */
  `;
  hint.innerHTML = `
    <div style="
      color:#d32f2f;
      font-weight:700;
      font-size:20px;
      display:inline-block;
    ">
      â€» é»æ“Š
      <span style="
        display:inline-flex;
        align-items:center;
        justify-content:center;
        background:#dc3545;
        color:#fff;
        border-radius:50%;
        font-size:18px;
        width:24px;
        height:24px;
        line-height:22px;
        vertical-align:middle;
        margin:0 4px;
      ">Ã—</span>
    å¯åˆªé™¤ç…§ç‰‡
    </div>
  `;
  thumbs.appendChild(hint);
}

// æ¸²æŸ“æ‰€æœ‰ç…§ç‰‡ç¸®åœ–
photos.forEach((p, i) => {
  const div = createThumbnail(p.url, i);
  thumbs.appendChild(div);
});

  // é åŠ è¼‰åœ–ç‰‡ï¼ˆæ‡¶åŠ è¼‰ï¼‰
  lazyLoadImages();

  // å¦‚æœé‚„æœ‰ç©ºé–“ï¼Œé¡¯ç¤ºæ–°å¢ç…§ç‰‡æŒ‰éˆ•
  if (photos.length < MAX_TOTAL) {
    const addBtn = createAddPhotoButton();
    thumbs.appendChild(addBtn);
    enableAddButtons();
  } else {
    disableAddButtons();
  }

  // é¡¯ç¤ºå·²ä¸Šå‚³çš„ç…§ç‰‡æ•¸é‡ä»¥åŠé è¦½æŒ‰éˆ•
  if (photos.length > 0) {
    const row = createPhotoCountRow();
    thumbs.appendChild(row);
  }
}

// å‰µå»ºå–®å¼µåœ–ç‰‡ç¸®åœ–
function createThumbnail(url, index) {
  const div = document.createElement("div");
  div.className = "thumb";

  const img = document.createElement("img");
  img.dataset.src = url;
  img.onerror = () => handleImageError(img);  // åœ–ç‰‡éŒ¯èª¤è™•ç†

  div.appendChild(img);
  const del = createDeleteButton(index);  // å‰µå»ºåˆªé™¤æŒ‰éˆ•
  div.appendChild(del);

  return div;
}

// åœ–ç‰‡éŒ¯èª¤è™•ç†ï¼šæ›¿æ›åœ–ç‰‡ç‚ºéŒ¯èª¤è¨Šæ¯
function handleImageError(img) {
  img.replaceWith(Object.assign(document.createElement("div"), {
    textContent: "âš ï¸",
    style: "color:#d32f2f;font-size:18px;text-align:center;padding:10px;"
  }));
}

// å‰µå»ºåˆªé™¤æŒ‰éˆ•
function createDeleteButton(index) {
  const del = document.createElement("button");
  del.className = "delete-btn";
  del.textContent = "Ã—";
  del.onclick = () => showConfirmDialog("ç¢ºå®šè¦åˆªé™¤é€™å¼µç…§ç‰‡ï¼Ÿ", () => removePhoto(index));
  return del;
}

// æ‡¶åŠ è¼‰åœ–ç‰‡ï¼šä½¿ç”¨ IntersectionObserver
function lazyLoadImages() {
  const imgs = thumbs.querySelectorAll("img[data-src]");
  const observer = new IntersectionObserver(
    entries => {
      entries.forEach(entry => {
        if (entry.isIntersecting) {
          const img = entry.target;
          img.src = img.dataset.src;  // è¨­å®šåœ–ç‰‡æº
          observer.unobserve(img);  // åœæ­¢ç›£æ§å·²é¡¯ç¤ºçš„åœ–ç‰‡
        }
      });
    },
    { rootMargin: "200px" }  // é åŠ è¼‰çš„ç¯„åœè¨­ç‚º 200px
  );
  imgs.forEach(img => observer.observe(img));  // é–‹å§‹ç›£æ§åœ–ç‰‡
}

// å‰µå»ºæ–°å¢ç…§ç‰‡æŒ‰éˆ•
function createAddPhotoButton() {
  const addBtn = document.createElement("div");
  addBtn.className = "add-photo";
  addBtn.innerHTML = "+";
  addBtn.onclick = () => showAddLimitMessage(() => fileGallery.click());
  return addBtn;
}

// é¡¯ç¤ºå·²ä¸Šå‚³çš„ç…§ç‰‡æ•¸é‡ã€åˆ†éš”ç·šå’Œé è¦½æŒ‰éˆ•
function createPhotoCountRow() {
  const row = document.createElement("div");
  row.style.textAlign = "center";
  row.style.width = "100%";

  const hr = createDivider();  // å‰µå»ºåˆ†éš”ç·š
  row.appendChild(hr);

  const countInfo = createPhotoCountInfo();  // é¡¯ç¤ºç…§ç‰‡æ•¸é‡ä¿¡æ¯
  row.appendChild(countInfo);

  const previewBtn = createPreviewButton();  // é è¦½æŒ‰éˆ•
  row.appendChild(previewBtn);

  return row;
}

// å‰µå»ºåˆ†éš”ç·š
function createDivider() {
  const hr = document.createElement("div");
  Object.assign(hr.style, {
    width: "90%",
    height: "1px",
    background: "#ccc",
    margin: "16px auto 12px auto",
    border: "none",
  });
  return hr;
}

// é¡¯ç¤ºç…§ç‰‡æ•¸é‡çš„è¨Šæ¯
function createPhotoCountInfo() {
  const countInfo = document.createElement("div");
  countInfo.id = "photoCountInfo";
  countInfo.style.marginBottom = "8px";
  countInfo.style.fontSize = "20px";
  countInfo.style.color = "#555";

  const remain = MAX_TOTAL - photos.length;
  countInfo.innerHTML = `ç›®å‰å…± <b>${photos.length}</b> å¼µï¼Œå¯å†æ–°å¢ <b>${remain}</b> å¼µ`;

  return countInfo;
}

// å‰µå»ºé è¦½æŒ‰éˆ•
function createPreviewButton() {
  const previewBtn = document.createElement("button");
  previewBtn.className = "preview-all-btn ui-btn gray";
  previewBtn.textContent = "é è¦½ç…§ç‰‡";
  previewBtn.onclick = () => showImage(0);  // é è¦½ç…§ç‰‡çš„ç¬¬ä¸€å¼µ
  return previewBtn;
}

function removePhoto(index) {
  URL.revokeObjectURL(photos[index].url);
  photos.splice(index, 1);
  renderThumbs();
  enableAddButtons(); // â† åŠ é€™è¡Œ
}

async function confirmUpload(files) {
  if (!files?.length) return;
  if (photos.length + files.length > MAX_TOTAL) {
    showMessage("è¶…éä¸Šé™ 20 å¼µï¼Œè«‹é‡æ–°ä¸Šå‚³");
    return;
  }

  const img = document.getElementById("previewImage");
  const title = document.getElementById("modalTitle");
  const container = document.querySelector(".preview-image-container");
  const deleteBtn = document.getElementById("deleteCurrentBtn");
  const confirmBtn = document.getElementById("confirmBtn");

  // 1ï¸âƒ£ é¡¯ç¤ºè¼‰å…¥ä¸­ç•«é¢ + æŒ‰éˆ•é–å®š
  title.textContent = "è«‹ç¢ºèªç…§ç‰‡";
  imgModal.style.display = "flex";
  document.body.style.overflow = "hidden";
  img.removeAttribute("src");
  img.style.opacity = "0";

  // ğŸ”¹ é–ä½æ“ä½œæŒ‰éˆ•
  [deleteBtn, confirmBtn].forEach(btn => {
    btn.style.opacity = "0.4";
    btn.style.filter = "grayscale(50%)";
    btn.style.pointerEvents = "none";
  });

  // ğŸ”¹ å»ºç«‹è¼‰å…¥åœˆ
  const overlay = document.createElement("div");
  overlay.id = "loadingSpinner";
  overlay.innerHTML = `
    <div class="spinner-circle"></div>
    <div class="spinner-text" style="font-size:22px;">ç…§ç‰‡è¼‰å…¥ä¸­...</div>
  `;
  Object.assign(overlay.style, {
    display: "flex",
    flexDirection: "column",
    alignItems: "center",
    justifyContent: "center",
    position: "absolute",
    inset: "0",
    background: "rgba(255,255,255,0.95)",
    zIndex: "10",
    borderRadius: "8px"
  });
  container.appendChild(overlay);

  await new Promise(r => setTimeout(r, 50));

  requestAnimationFrame(async () => {
    previewMode = "confirm";

    // 2ï¸âƒ£ å£“ç¸®æ‰€æœ‰åœ–ç‰‡
    previewFiles = await Promise.all(
      files.map(async f => {
        const small = await compressImage(f);
        return { file: small, url: URL.createObjectURL(small) };
      })
    );

    overlay.remove();
    setupPreviewModal();
    updatePreviewImage();
    updateNavButtons();

    // 3ï¸âƒ£ è§£é–æ“ä½œæŒ‰éˆ•
    [deleteBtn, confirmBtn].forEach(btn => {
      btn.style.opacity = "1";
      btn.style.filter = "none";
      btn.style.pointerEvents = "auto";
    });

    img.onload = () => {
      img.style.transition = "opacity 0.3s ease";
      img.style.opacity = "1";
    };
  });
}

function updateNavButtons() {
  const leftBtn = document.getElementById("navLeft");
  const rightBtn = document.getElementById("navRight");
  const total = previewFiles.length;
  leftBtn.classList.toggle("disabled", previewIndex <= 0);
  rightBtn.classList.toggle("disabled", previewIndex >= total - 1);
  leftBtn.style.pointerEvents = leftBtn.classList.contains("disabled") ? "none" : "";
  rightBtn.style.pointerEvents = rightBtn.classList.contains("disabled") ? "none" : "";
}

function setupPreviewModal() {
  document.getElementById("closeModalBtn").onclick = closePreviewModal;
  document.getElementById("navLeft").onclick = () => changePreview(-1);
  document.getElementById("navRight").onclick = () => changePreview(1);
  document.getElementById("confirmBtn").onclick = handleConfirm;
  document.getElementById("deleteCurrentBtn").onclick = deletePreviewPhoto;
  document.body.style.overflow = "hidden";
}

function showImage(index = 0) {
  if (photos.length === 0) return;
  const img = document.getElementById("previewImage");
  const leftBtn = document.getElementById("navLeft");
  const rightBtn = document.getElementById("navRight");
  const deleteBtn = document.getElementById("deleteCurrentBtn");
  const confirmBtn = document.getElementById("confirmBtn");

  previewMode = "preview";
  previewFiles = photos.map(p => ({ file: p.file, url: p.url }));
  previewIndex = index;

  img.removeAttribute("src");
  img.style.opacity = "0";
  imgModal.style.display = "flex";
  document.body.style.overflow = "hidden";

  setupPreviewModal();
  updatePreviewImage();
  updateNavButtons();

  [deleteBtn, confirmBtn].forEach(btn => {
    btn.classList.remove("disabled");
    btn.style.pointerEvents = "";
  });

  confirmBtn.style.display = "none";

  img.onload = () => {
    img.style.transition = "opacity 0.3s ease";
    img.style.opacity = "1";
  };
}

function closePreviewModal() {
  imgModal.style.display = "none";
  previewFiles = [];
  previewIndex = 0;
  document.body.style.overflow = "auto";
}

function updatePreviewImage() {
  const img = document.getElementById("previewImage");
  const title = document.getElementById("modalTitle");
  const container = document.querySelector(".preview-image-container");
  const leftBtn = document.getElementById("navLeft");
  const rightBtn = document.getElementById("navRight");

  document.getElementById("errorMessage")?.remove();
  if (previewFiles.length === 0) return;

  const total = previewFiles.length;
  const current = previewIndex + 1;
  title.textContent =
    previewMode === "confirm"
      ? `è«‹ç¢ºèªç…§ç‰‡ (${current}/${total})`
      : `é è¦½ç…§ç‰‡ (${current}/${total})`;

  const newSrc = previewFiles[previewIndex].url;
  img.onerror = () => {
    img.removeAttribute("src");
    showPhotoError(container);
  };
  img.style.opacity = "0";
  img.src = newSrc;
  requestAnimationFrame(() => {
    img.style.transition = "opacity 0.3s ease";
    img.style.opacity = "1";
  });

  const confirmBtn = document.getElementById("confirmBtn");
  confirmBtn.style.display = previewMode === "confirm" ? "inline-block" : "none";
  if (previewMode === "confirm") confirmBtn.textContent = "ç¢ºèªå®Œæˆ";

  document.getElementById("deleteCurrentBtn").textContent = "åˆªé™¤é€™å¼µ";
  leftBtn.classList.toggle("disabled", previewIndex === 0);
  rightBtn.classList.toggle("disabled", previewIndex === total - 1);
}

function showPhotoError(container) {
  if (document.getElementById("errorMessage")) return;

  const errBox = document.createElement("div");
  errBox.id = "errorMessage";
  errBox.innerHTML = `
    <div style="font-size:48px;line-height:1;color:#d32f2f;">âš ï¸</div>
    <div style="color:#d32f2f;font-size:22px;font-weight:600;margin-top:10px;">
      éŒ¯èª¤ï¼Œè«‹é‡æ–°ä¸Šå‚³é€™å¼µç…§ç‰‡
    </div>
  `;

  Object.assign(errBox.style, {
    position: "absolute",
    top: "50%",
    left: "50%",
    transform: "translate(-50%, -50%)",
    background: "rgba(255,255,255,0.92)",
    border: "2px solid #d32f2f",
    borderRadius: "10px",
    padding: "20px 28px",
    textAlign: "center",
    zIndex: "15",
    pointerEvents: "none",
    boxShadow: "0 2px 8px rgba(0,0,0,0.25)"
  });

  container.appendChild(errBox);
}

function deletePreviewPhoto() {
  showConfirmDialog("ç¢ºå®šè¦åˆªé™¤é€™å¼µç…§ç‰‡ï¼Ÿ", () => {
    const removed = previewFiles.splice(previewIndex, 1)[0];
    if (removed.url?.startsWith("blob:")) URL.revokeObjectURL(removed.url);

    if (previewMode === "preview") {
      const idx = photos.findIndex(x => x.url === removed.url);
      if (idx >= 0) photos.splice(idx, 1);
      renderThumbs();
      enableAddButtons(); // â† åŠ é€™è¡Œ
    }

    if (previewFiles.length === 0) {
      closePreviewModal();
    } else {
      if (previewIndex >= previewFiles.length) previewIndex = previewFiles.length - 1;
      updatePreviewImage();
      updateNavButtons();
    }
  });
}

// === é€šç”¨è‡ªè¨‚ç¢ºèªæç¤ºçª— ===
function showConfirmDialog(message, onConfirm) {
  document.getElementById("confirmDialog")?.remove();

  const overlay = document.createElement("div");
  overlay.id = "confirmDialog";
  Object.assign(overlay.style, {
    position: "fixed",
    inset: "0",
    background: "rgba(0,0,0,0.6)",
    display: "flex",
    alignItems: "center",
    justifyContent: "center",
    zIndex: "9999",
  });

  const box = document.createElement("div");
  Object.assign(box.style, {
    background: "#fff",
    color: "#000",
    borderRadius: "12px",
    padding: "32px 44px",
    fontSize: "22px",
    textAlign: "center",
    maxWidth: "80%",
    boxShadow: "0 4px 20px rgba(0,0,0,0.3)",
  });
  box.innerHTML = message;

  const btnRow = document.createElement("div");
  Object.assign(btnRow.style, {
    display: "flex",
    justifyContent: "center",
    gap: "30px",
    marginTop: "28px",
  });

  const cancelBtn = document.createElement("button");
  cancelBtn.textContent = "å–æ¶ˆ";
  Object.assign(cancelBtn.style, {
    padding: "10px 26px",
    fontSize: "20px",
    borderRadius: "8px",
    border: "1px solid #999",
    background: "#eee",
    color: "#333",
  });
  cancelBtn.onclick = () => overlay.remove();

  const confirmBtn = document.createElement("button");
  confirmBtn.textContent = "åˆªé™¤";
  Object.assign(confirmBtn.style, {
    padding: "10px 26px",
    fontSize: "20px",
    borderRadius: "8px",
    border: "none",
    background: "#d32f2f",
    color: "#fff",
  });
  confirmBtn.onclick = () => {
    overlay.remove();
    if (typeof onConfirm === "function") onConfirm();
  };

  btnRow.append(cancelBtn, confirmBtn);
  box.appendChild(btnRow);
  overlay.appendChild(box);
  document.body.appendChild(overlay);
}

function handleConfirm() {
  if (previewMode === "confirm") {
    previewFiles.forEach(p => {
      if (photos.length < MAX_TOTAL) photos.push({ file: p.file, url: p.url });
    });
    renderThumbs();
    enableAddButtons(); // â† åŠ é€™è¡Œ
  }
  closePreviewModal();
  previewFiles.forEach(p => {
    if (p.url?.startsWith("blob:")) URL.revokeObjectURL(p.url);
  });
}

function changePreview(dir) {
  const next = previewIndex + dir;
  if (next < 0 || next >= previewFiles.length) return;
  previewIndex = next;
  updatePreviewImage();
  updateNavButtons();
}

function showMessage(text, onConfirm) {
  document.getElementById("customModal")?.remove();
  const overlay = document.createElement("div");
  overlay.id = "customModal";
  Object.assign(overlay.style, {
    position: "fixed",
    inset: "0",
    background: "rgba(0,0,0,0.6)",
    display: "flex",
    alignItems: "center",
    justifyContent: "center",
    zIndex: "9999",
  });
  const box = document.createElement("div");
  Object.assign(box.style, {
    background: "#fff",
    color: "#000",
    borderRadius: "12px",
    padding: "30px 40px",
    fontSize: "22px",
    textAlign: "center",
    maxWidth: "80%",
    boxShadow: "0 4px 20px rgba(0,0,0,0.3)",
  });
  box.innerHTML = text;

  const btn = document.createElement("button");
  btn.textContent = "ç¢ºå®š";
  Object.assign(btn.style, {
    marginTop: "24px",
    fontSize: "20px",
    padding: "10px 28px",
    borderRadius: "8px",
    border: "none",
    background: "#0b5ed7",
    color: "#fff",
  });

  // â† åªæ”¹é€™æ®µï¼šå…ˆç§»é™¤è¦–çª—ï¼Œé€£çºŒå…©æ¬¡ rAF ç¢ºä¿å®Œæˆé‡ç¹ªï¼Œå†åŸ·è¡Œ onConfirmï¼ˆé–‹ç›¸ç°¿ï¼‰
  btn.onclick = () => {
    overlay.remove();
    requestAnimationFrame(() => {
      requestAnimationFrame(() => {
        if (typeof onConfirm === "function") onConfirm();
      });
    });
  };

  box.appendChild(document.createElement("br"));
  box.appendChild(btn);
  overlay.appendChild(box);
  document.body.appendChild(overlay);
}

window.addEventListener("beforeunload", () => {
  photos.forEach(p => URL.revokeObjectURL(p.url));
});

async function compressImage(file, maxWidth = 1280, maxHeight = 1280) {
  return new Promise(resolve => {
    const img = new Image();
    img.onload = () => {
      const canvas = document.createElement("canvas");
      let { width, height } = img;
      const ratio = Math.min(maxWidth / width, maxHeight / height, 1);
      canvas.width = width * ratio;
      canvas.height = height * ratio;
      const ctx = canvas.getContext("2d");
      ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
      canvas.toBlob(
        blob => resolve(new File([blob], file.name, { type: "image/jpeg" })),
        "image/jpeg",
        0.8
      );
    };
    img.src = URL.createObjectURL(file);
  });
}

/* === é–å®šå…¨è¢å¹•ç°å±¤ === */
function showScreenLock() {
  let lock = document.getElementById('screenLock');
  if (!lock) {
    lock = document.createElement('div');
    lock.id = 'screenLock';
    Object.assign(lock.style, {
      position: 'fixed',
      inset: '0',
      background: 'rgba(0,0,0,0.45)',
      zIndex: '9998',
      pointerEvents: 'none',   // ğŸ”¹ ä¸é˜»æ“‹å‰æ™¯æŒ‰éˆ•
      touchAction: 'none',     // ğŸ”¹ ç¦æ­¢è§¸æ§æ»¾å‹•
      overflow: 'hidden',
    });
    document.body.appendChild(lock);
  } else lock.style.display = 'block';

  // ğŸ”¹ ç¦æ­¢æ•´é«”æ»¾å‹•
  document.body.style.overflow = 'hidden';
  document.body.style.touchAction = 'none';
}

function hideScreenLock() {
  const lock = document.getElementById('screenLock');
  if (lock) lock.style.display = 'none';

  // ğŸ”¹ æ¢å¾©æ»¾å‹•
  document.body.style.overflow = '';
  document.body.style.touchAction = '';
}

/* === å°å‹è¼‰å…¥è¦–çª— === */
let micLoadingTimer = null;

function showMicLoading(delay = 1000) {
  // ğŸ”¹ ä¸€é–‹å§‹å°±é–ç°å±¤
  showScreenLock();

  micLoadingTimer = setTimeout(() => {
    let box = document.getElementById('micLoading');
    if (!box) {
      box = document.createElement('div');
      box.id = 'micLoading';
      Object.assign(box.style, {
        position: 'fixed',
        left: '50%',
        top: '50%',
        transform: 'translate(-50%, -50%)',
        background: 'rgba(255,255,255,0.96)',
        borderRadius: '12px',
        padding: '18px 26px',
        boxShadow: '0 2px 12px rgba(0,0,0,0.25)',
        display: 'flex',
        alignItems: 'center',
        justifyContent: 'center',
        gap: '10px',
        zIndex: '9999',   // ğŸ”¹ é«˜æ–¼ç°å±¤
        fontSize: '21px',
        color: '#333',
        pointerEvents: 'auto'
      });
      box.innerHTML = `
        <div class="spinner" style="
          width:22px;height:22px;
          border:3px solid #ccc;
          border-top:3px solid #0b5ed7;
          border-radius:50%;
          animation:spin 1s linear infinite;"></div>
        <span>æº–å‚™ä¸­...</span>
      `;
      const style = document.createElement('style');
      style.textContent = `
        @keyframes spin { from{transform:rotate(0deg);} to{transform:rotate(360deg);} }
      `;
      document.head.appendChild(style);
      document.body.appendChild(box);
    } else box.style.display = 'flex';
  }, delay);
}

function hideMicLoading() {
  clearTimeout(micLoadingTimer);
  const box = document.getElementById('micLoading');
  if (box) box.style.display = 'none';
}

/* === å…¨åŸŸè®Šæ•¸ === */
let mediaRecorder = null;
let audioChunks = [];
let audioBlob = null;
let currentStream = null;
let currentAudioContext = null;

/* === åœæ­¢éŒ„éŸ³ === */
function stopRecording() {
  try {
    if (mediaRecorder && mediaRecorder.state === 'recording') {
      mediaRecorder.stop();
    }
  } catch (err) {
    console.warn('åœæ­¢éŒ„éŸ³éŒ¯èª¤:', err);
  }
}

/* === éŒ„éŸ³é–‹å§‹ === */
async function startRecording(isRedo = false) {
  const minVisible = 400;
  const startTime = Date.now();

  // æª¢æŸ¥æ¬Šé™ç‹€æ…‹
  let micState = 'prompt';
  if (navigator.permissions) {
    try {
      const status = await navigator.permissions.query({ name: 'microphone' });
      micState = status.state;
    } catch {}
  }

  // é‡éŒ„æˆ–å·²æˆæ¬Šç«‹å³é¡¯ç¤ºï¼›ç¬¬ä¸€æ¬¡å¯èƒ½å»¶é²
  const delay = isRedo || micState === 'granted' ? 0 : 1000;
  showMicLoading(delay);

  try {
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    currentStream = stream; // ğŸ”¹ ä¿ç•™ä»¥ä¾› stop ä½¿ç”¨

    const elapsed = Date.now() - startTime;
    if (elapsed < minVisible) {
      await new Promise(r => setTimeout(r, minVisible - elapsed));
    }
    hideMicLoading();

    showScreenLock();

    const mimeType = MediaRecorder.isTypeSupported('audio/mp4')
      ? 'audio/mp4'
      : 'audio/webm';
    mediaRecorder = new MediaRecorder(stream, { mimeType });
    audioChunks = [];

    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
    currentAudioContext = audioContext;
    const source = audioContext.createMediaStreamSource(stream);
    const analyser = audioContext.createAnalyser();
    analyser.fftSize = 256;
    source.connect(analyser);
    const dataArray = new Uint8Array(analyser.frequencyBinCount);

    recordModal.innerHTML = `
  <div class="modal-content" style="
    position:relative;
    padding-top:40px;
    background:#fff;
    border-radius:12px;
    pointer-events:auto;
    z-index:10000;
  ">
    <div class="record-status" style="
      display:flex;align-items:center;justify-content:center;gap:10px;">
      <span class="record-dot" style="
        display:inline-block;width:14px;height:14px;
        background:#d32f2f;border-radius:50%;animation:blink 1s infinite;"></span>
      <span class="red-text" style="font-size:24px;font-weight:600;">éŒ„éŸ³ä¸­</span>
    </div>

    <!-- ğŸ”¹ ç§’æ•¸ -->
    <div id="recordTimer" style="text-align:center;font-size:21px;color:#555;margin:8px 0 16px 0;">0:00</div>

    <div id="volumeBar" style="
      width:100%;height:22px;background:#eee;
      border-radius:12px;margin:0 0 26px 0;overflow:hidden;">
      <div id="volumeFill" style="
        width:0%;height:100%;background:#0b5ed7;transition:width 0.05s linear;"></div>
    </div>

    <div style="display:flex;justify-content:center;gap:20px;">
      <button class="ui-btn gray" style="font-size:21px;" onclick="cancelRecording()">è¿”å›</button>
      <button class="ui-btn blue" style="font-size:21px;" onclick="stopRecording()">å®Œæˆ</button>
    </div>
  </div>
  <style>
    @keyframes blink { 50% { opacity: 0; } }
  </style>`;
    recordModal.style.display = 'flex';
    recordModal.style.zIndex = '9999';

    let animId;
    function drawVolume() {
      analyser.getByteFrequencyData(dataArray);
      const avg = dataArray.reduce((a, b) => a + b, 0) / dataArray.length;
      const percent = Math.min(100, Math.max(8, avg / 2));
      const bar = document.getElementById('volumeFill');
      if (bar) bar.style.width = percent + '%';
      animId = requestAnimationFrame(drawVolume);
    }
    drawVolume();

    mediaRecorder.ondataavailable = e => {
      if (e.data.size > 0) audioChunks.push(e.data);
    };

    let recordStart = Date.now();
const timerEl = document.getElementById('recordTimer');
const timerId = setInterval(() => {
  const t = Math.floor((Date.now() - recordStart) / 1000);
  const m = Math.floor(t / 60);
  const s = (t % 60).toString().padStart(2, '0');
  if (timerEl) timerEl.textContent = `${m}:${s}`;
}, 1000);

    mediaRecorder.onstop = () => {
      cancelAnimationFrame(animId);
      try {
        if (currentAudioContext) currentAudioContext.close();
        if (currentStream) currentStream.getTracks().forEach(t => t.stop());
      } catch {}
      audioBlob = new Blob(audioChunks, { type: mimeType });
      showPlaybackModal();
    };

    mediaRecorder.start();
  } catch (e) {
    hideMicLoading();
    hideScreenLock();
    recordModal.style.display = 'none';
    if (e.name === 'NotAllowedError' || e.name === 'SecurityError') {
      showCustomAlert('æœªé–‹å•Ÿéº¥å…‹é¢¨', 'è«‹åœ¨é–‹å§‹éŒ„éŸ³æ™‚<b style="color:#0b5ed7;">å…è¨±éº¥å…‹é¢¨</b>');
    } else if (e.name === 'NotFoundError') {
      showCustomAlert('æ‚¨çš„æ‰‹æ©Ÿä¸æ”¯æ´éŒ„éŸ³');
    } else {
      showCustomAlert('ç„¡æ³•ä½¿ç”¨éº¥å…‹é¢¨');
    }
  }
}

function cancelRecording() {
  // åœæ­¢éº¥å…‹é¢¨èˆ‡éŸ³è¨Šè™•ç†
  try {
    if (mediaRecorder && mediaRecorder.state !== 'inactive') mediaRecorder.stop();
    if (currentStream) currentStream.getTracks().forEach(t => t.stop());
    if (currentAudioContext) currentAudioContext.close();
  } catch {}
  // é—œé–‰ç•«é¢èˆ‡ç°å±¤
  hideScreenLock();
  recordModal.style.display = 'none';
  hideMicLoading();
}

/* === é‡éŒ„ === */
function redoAudio() {
  recordModal.style.display = 'none';
  audioBlob = null;
  startRecording(true); // ğŸ”¹ é‡éŒ„ç«‹å³é¡¯ç¤ºã€Œæº–å‚™ä¸­ã€
}

/* === æ’­æ”¾ç¢ºèªç•«é¢ === */
function showPlaybackModal() {
  const lock = document.getElementById('screenLock');
  if (lock) lock.style.zIndex = '9998';
  recordModal.style.zIndex = '9999';

  const url = URL.createObjectURL(audioBlob);
  recordModal.innerHTML = `
  <div class="modal-content">
    <div style="margin-bottom:15px;font-size:22px;font-weight:bold;">è«‹ç¢ºèªéŒ„éŸ³</div>

    <div id="customPlayer" style="
      display:flex;align-items:center;justify-content:center;
      gap:14px;margin:20px 0;">
      <button id="playBtn" style="
        width:56px;height:56px;border-radius:50%;
        border:none;background:#0b5ed7;color:#fff;
        cursor:pointer;display:flex;align-items:center;justify-content:center;">
        <div id="playIcon" style="
          width:0;height:0;border-top:9px solid transparent;
          border-bottom:9px solid transparent;border-left:16px solid #fff;margin-left:3px;">
        </div>
      </button>
      <span id="timeLabel" style="font-size:19px;color:#333;">0:00</span>
    </div>

    <div id="waveBar" style="width:100%;height:12px;background:#eee;border-radius:8px;overflow:hidden;">
      <div id="waveFill" style="width:0%;height:100%;background:#0b5ed7;"></div>
    </div>

    <div style="margin-top:22px;display:flex;justify-content:center;gap:20px;">
      <button class="ui-btn gray" style="font-size:20px;" onclick="redoAudio()">é‡éŒ„</button>
      <button class="ui-btn blue" style="font-size:20px;" onclick="confirmAudio()">ç¢ºå®š</button>
    </div>
  </div>`;

  // === æ’­æ”¾æ§åˆ¶ ===
  const audio = new Audio(url);
  const ctx = new (window.AudioContext || window.webkitAudioContext)();
  const src = ctx.createMediaElementSource(audio);
  src.connect(ctx.destination);

  const btn = document.getElementById('playBtn');
  const label = document.getElementById('timeLabel');
  const bar = document.getElementById('waveFill');
  let playing = false;
  let rafId;
  let startAt = 0;

  btn.onclick = async () => {
    if (!playing) {
      if (ctx.state === 'suspended') await ctx.resume();
      audio.play();
      setPauseIcon();
      playing = true;
      startAt = ctx.currentTime - audio.currentTime;
      smoothProgress();
    } else pauseAudio();
  };

  audio.onended = () => {
    setPlayIcon();
    playing = false;
    cancelAnimationFrame(rafId);
    bar.style.width = '100%';
  };

  function smoothProgress() {
    if (!playing) return;
    const now = ctx.currentTime - startAt;
    if (audio.duration > 0) {
      const pct = Math.min(100, (now / audio.duration) * 100);
      bar.style.width = pct + '%';
      const min = Math.floor(now / 60);
      const sec = Math.floor(now % 60).toString().padStart(2, '0');
      label.textContent = `${min}:${sec}`;
    }
    rafId = requestAnimationFrame(smoothProgress);
  }

  function pauseAudio() {
    if (!playing) return;
    audio.pause();
    setPlayIcon();
    playing = false;
    cancelAnimationFrame(rafId);
  }

  function setPauseIcon() {
  btn.innerHTML = `
    <div style="
      display:flex;
      align-items:center;
      justify-content:center;
      gap:5px;
    ">
      <div style="width:5px;height:19px;background:#fff;"></div>
      <div style="width:5px;height:19px;background:#fff;"></div>
    </div>`;
}

  function setPlayIcon() {
    btn.innerHTML = `<div style="
      width:0;height:0;border-top:9px solid transparent;
      border-bottom:9px solid transparent;border-left:16px solid #fff;margin-left:3px;
    "></div>`;
  }

  window._stopPreviewAudio = () => {
    if (!audio.paused) audio.pause();
    setPlayIcon();
    playing = false;
    cancelAnimationFrame(rafId);
  };
}

/* === ç¢ºèªå¾Œåœ¨è¡¨å–®é¡¯ç¤ºè‡ªè¨‚ player === */
function confirmAudio() {
  if (window._stopPreviewAudio) window._stopPreviewAudio();
  hideScreenLock();
  recordModal.style.display = 'none';

  const playback = document.getElementById('audioPlayback');
  playback.style.display = 'none';

  let box = document.getElementById('audioPlayerBox');
  if (!box) {
    box = document.createElement('div');
    box.id = 'audioPlayerBox';
    playback.insertAdjacentElement('afterend', box);
  }

  box.innerHTML = `
    <div style="display:flex;align-items:center;gap:10px;margin-top:12px;">
      <button id="formPlayBtn" style="
        width:48px;height:48px;border-radius:50%;
        border:none;background:#0b5ed7;color:#fff;
        cursor:pointer;display:flex;align-items:center;justify-content:center;">
        <div id="formPlayIcon" style="
          width:0;height:0;border-top:8px solid transparent;
          border-bottom:8px solid transparent;border-left:14px solid #fff;margin-left:3px;">
        </div>
      </button>

      <span id="formTime" style="font-size:18px;color:#333;">0:00</span>

      <div style="flex:1;height:10px;background:#eee;border-radius:6px;overflow:hidden;">
        <div id="formBar" style="width:0%;height:100%;background:#0b5ed7;"></div>
      </div>

      <!-- ğŸ”¹ åˆªé™¤æŒ‰éˆ• -->
      <button id="deleteAudioBtn" title="åˆªé™¤éŒ„éŸ³" style="
        width:42px;height:42px;
        border:none;border-radius:50%;
        background:#d32f2f;
        cursor:pointer;display:flex;align-items:center;justify-content:center;
      ">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"
          width="20" height="20" stroke="#fff" stroke-width="3" stroke-linecap="round">
          <line x1="5" y1="5" x2="19" y2="19"/>
          <line x1="19" y1="5" x2="5" y2="19"/>
        </svg>
      </button>
    </div>`;

  // === æ’­æ”¾æ§åˆ¶ ===
  const objectUrl = URL.createObjectURL(audioBlob);
  const audio = new Audio(objectUrl);
  const ctx = new (window.AudioContext || window.webkitAudioContext)();
  const src = ctx.createMediaElementSource(audio);
  src.connect(ctx.destination);

  const btn = document.getElementById('formPlayBtn');
  const time = document.getElementById('formTime');
  const bar = document.getElementById('formBar');
  const del = document.getElementById('deleteAudioBtn');

  let playing = false, rafId = 0, startAt = 0;

  btn.onclick = async () => {
    if (!playing) {
      if (ctx.state === 'suspended') await ctx.resume();
      audio.play();
      setPause();
      playing = true;
      startAt = ctx.currentTime - audio.currentTime;
      smooth();
    } else {
      audio.pause();
      setPlay();
      playing = false;
      cancelAnimationFrame(rafId);
    }
  };

  audio.onended = () => {
    setPlay();
    playing = false;
    cancelAnimationFrame(rafId);
    bar.style.width = '100%';
  };

  function smooth() {
    if (!playing) return;
    const now = ctx.currentTime - startAt;
    if (audio.duration > 0) {
      const pct = Math.min(100, (now / audio.duration) * 100);
      bar.style.width = pct + '%';
      const min = Math.floor(now / 60);
      const sec = Math.floor(now % 60).toString().padStart(2, '0');
      time.textContent = `${min}:${sec}`;
    }
    rafId = requestAnimationFrame(smooth);
  }

  function setPause() {
    btn.innerHTML = `<div style="
      width:14px;height:16px;background:#fff;
      clip-path: polygon(
        0 0,0 100%,35% 100%,35% 0,65% 0,65% 100%,100% 100%,100% 0
      );
    "></div>`;
  }

  function setPlay() {
    btn.innerHTML = `<div style="
      width:0;height:0;border-top:8px solid transparent;
      border-bottom:8px solid transparent;border-left:14px solid #fff;margin-left:3px;
    "></div>`;
  }

  // ğŸ”¹ åˆªé™¤æŒ‰éˆ•é‚è¼¯
  del.onclick = () =>
    showConfirmDeleteAudio(() => {
      try { audio.pause(); } catch {}
      cancelAnimationFrame(rafId);
      bar.style.width = '0%';
      time.textContent = '0:00';
      URL.revokeObjectURL(objectUrl);
      window.audioBlob = null;
      box.innerHTML = '';
    });
}

/* === åˆªé™¤éŒ„éŸ³ç¢ºèª === */
function showConfirmDeleteAudio(onConfirm) {
  document.getElementById('customConfirm')?.remove();

  const overlay = document.createElement('div');
  overlay.id = 'customConfirm';
  Object.assign(overlay.style, {
    position: 'fixed',
    inset: '0',
    background: 'rgba(0,0,0,0.6)',
    display: 'flex',
    alignItems: 'center',
    justifyContent: 'center',
    zIndex: '10001'
  });

  const modal = document.createElement('div');
  Object.assign(modal.style, {
    background: '#fff',
    borderRadius: '12px',
    padding: '34px 44px 30px',
    textAlign: 'center',
    fontSize: '20px',
    color: '#333',
    lineHeight: '1.8',
    boxShadow: '0 4px 18px rgba(0,0,0,0.25)',
    maxWidth: '80%'
  });

  modal.innerHTML = `
    <div style="font-size:21px;margin-bottom:24px;">ç¢ºå®šè¦åˆªé™¤éŒ„éŸ³ï¼Ÿ</div>
    <div style="display:flex;justify-content:center;gap:20px;">
      <button id="cancelDeleteBtn" style="
        font-size:20px;padding:10px 26px;border:none;border-radius:8px;
        background:#888;color:#fff;cursor:pointer;">å–æ¶ˆ</button>
      <button id="confirmDeleteBtn" style="
        font-size:20px;padding:10px 26px;border:none;border-radius:8px;
        background:#d32f2f;color:#fff;cursor:pointer;">åˆªé™¤</button>
    </div>
  `;

  overlay.appendChild(modal);
  document.body.appendChild(overlay);

  document.getElementById('cancelDeleteBtn').onclick = () => overlay.remove();

  document.getElementById('confirmDeleteBtn').onclick = () => {
    if (typeof onConfirm === 'function') onConfirm();
    if (window._stopPreviewAudio) window._stopPreviewAudio();
    overlay.remove();
  };
}

function showCustomAlert(title, message = '') {
  document.getElementById('customAlert')?.remove();
  const overlay = document.createElement('div');
  overlay.id = 'customAlert';
  Object.assign(overlay.style, {
  position: 'fixed', inset: '0',
  background: 'rgba(0,0,0,0.6)',
  display: 'flex',
  alignItems: 'center',
  justifyContent: 'center',
  zIndex: '10000',       // ğŸ”¹ é«˜æ–¼ç°å±¤
  pointerEvents: 'auto', // ğŸ”¹ å¯æ“ä½œ
});

  const box = document.createElement('div');
  Object.assign(box.style, {
    background: '#fff',
    color: '#000',
    borderRadius: '12px',
    padding: '36px 50px 28px',
    fontSize: '20px',
    textAlign: 'center',
    maxWidth: '80%',
    lineHeight: '1.9',
    boxShadow: '0 4px 18px rgba(0,0,0,0.25)',
  });
  box.innerHTML = `
    <div style="display:flex;align-items:center;justify-content:center;gap:10px;margin-bottom:12px;">
      <span style="font-size:26px;color:#d32f2f;">âš ï¸</span>
      <span style="font-weight:bold;font-size:23px;">${title}</span>
    </div>
    <div style="font-size:19px;color:#333;margin-top:10px;">${message}</div>
  `;

  const btn = document.createElement('button');
  btn.textContent = 'ç¢ºå®š';
  Object.assign(btn.style, {
    marginTop: '22px',
    fontSize: '21px',
    padding: '10px 26px',
    borderRadius: '8px',
    border: 'none',
    background: '#0b5ed7',
    color: '#fff',
    cursor: 'pointer'
  });
  btn.onclick = () => overlay.remove();

  box.appendChild(btn);
  overlay.appendChild(box);
  document.body.appendChild(overlay);
}

/* === ç½æƒ…é¸æ“‡ === */
function toggleDisasterTypes() {
    const val = document.querySelector('input[name="disaster"]:checked')?.value;
    const disasterDiv = document.getElementById('disasterTypes');

    if (val === 'ç•°å¸¸') {
      disasterDiv.style.display = 'block';
    } else {
      // åˆ‡å›ã€Œæ­£å¸¸ã€æ™‚æ¸…ç©ºç•°å¸¸å‹¾é¸
      disasterDiv.style.display = 'none';
      document.querySelectorAll('input[name="disasterType"]').forEach(cb => cb.checked = false);
      document.getElementById('otherDisasterWrap').style.display = 'none';
      document.getElementById('otherDisasterText').value = '';
    }
  }

  document.addEventListener('DOMContentLoaded', () => {
    const otherDisaster = document.getElementById('otherDisaster');
    const wrap = document.getElementById('otherDisasterWrap');
    const input = document.getElementById('otherDisasterText');

    otherDisaster.addEventListener('change', () => {
      wrap.style.display = otherDisaster.checked ? 'inline' : 'none';
      if (!otherDisaster.checked) input.value = '';
    });
  });

/* === Firebase ä¸Šå‚³ === */
async function compressImage(file){
  return new Promise(res=>{
    const img=new Image();
    img.onload=()=>{
      const c=document.createElement('canvas');
      const scale=Math.min(1,1280/img.width);
      c.width=img.width*scale;c.height=img.height*scale;
      c.getContext('2d').drawImage(img,0,0,c.width,c.height);
      c.toBlob(b=>res(new File([b],'photo.jpg',{type:'image/jpeg'})),'image/jpeg',0.7);
    };
    img.src=URL.createObjectURL(file);
  });
}

async function uploadToFirebase(file,path){
  const {ref,uploadBytesResumable,getDownloadURL}=window.firebaseStorage;
  const storageRef=ref(window.firebaseStorage.storage,path);
  const task=uploadBytesResumable(storageRef,file);
  return new Promise((res,rej)=>{
    task.on('state_changed',snap=>{
      const p=(snap.bytesTransferred/snap.totalBytes)*100;
      document.getElementById('uploadProgress').style.display='block';
      document.getElementById('uploadProgress').value=p;
      document.getElementById('uploadStatus').textContent=`ä¸Šå‚³ä¸­ ${Math.round(p)}%`;
    },rej,async()=>res(await getDownloadURL(task.snapshot.ref)));
  });
}

async function transcribeAudio(blob,reportId){
  const buf=await blob.arrayBuffer();
  const arr=new Uint8Array(buf);
  let s='';for(let i=0;i<arr.length;i++)s+=String.fromCharCode(arr[i]);
  const b64=btoa(s);
  const fd=new FormData();
  fd.append('action','transcribe');
  fd.append('audioData',b64);
  fd.append('reportId',reportId);
  const r=await fetch(WEB_APP_URL,{method:'POST',body:fd});
  const t=await r.text();try{const j=JSON.parse(t);return j.transcription||'';}catch{return'';}
}

/* === æäº¤è¡¨å–® === */
async function submitForm() {
  const summary = document.getElementById('summary').value.trim();
  const abnormal = document.querySelector('input[name="disaster"]:checked')?.value === 'ç•°å¸¸';
  const types = Array.from(document.querySelectorAll('input[name="disasterType"]:checked'))
    .map(e => e.value).join(',');

  // âœ… æ–°å¢ï¼šé€šå ±é¡å‹èˆ‡åŒè¡Œå¿—å·¥
  const reportType = document.querySelector('input[name="reportType"]:checked')?.value || '';
  const companionsChecked = Array.from(document.querySelectorAll('input[name="companions"]:checked'))
    .map(e => e.value);
  const otherCompanionName = document.getElementById('otherCompanionName')?.value.trim() || '';

  // âœ… é©—è­‰ã€ŒåŒè¡Œå¿—å·¥ã€å…¶ä»–å¿…å¡«
  if (companionsChecked.includes('å…¶ä»–') && !otherCompanionName) {
    alert('è«‹è¼¸å…¥åŒè¡Œå¿—å·¥çš„ã€Œå…¶ä»–ã€å§“å');
    return;
  }

  document.getElementById('submitBtn').disabled = true;
  const ts = Date.now(), rid = `report_${ts}`, photoUrls = [];

  try {
    // ä¸Šå‚³ç…§ç‰‡
    for (let i = 0; i < photos.length; i++) {
      const comp = await compressImage(photos[i].file);
      const url = await uploadToFirebase(comp, `reports/${rid}/photo_${i}.jpg`);
      photoUrls.push(url);
    }

    // ä¸Šå‚³éŸ³æª”
    let audioUrl = '', txt = '';
    if (audioBlob) {
      audioUrl = await uploadToFirebase(audioBlob, `reports/${rid}/recording.webm`);
      if (abnormal) txt = await transcribeAudio(audioBlob, rid);
    }

    // === çµ„åˆå‚³é€è³‡æ–™ ===
    const fd = new FormData();
    fd.append('summary', summary);
    fd.append('disasterType', types);
    fd.append('photoUrl', photoUrls.join(','));
    if (audioUrl) fd.append('audioUrl', audioUrl);
    fd.append('timestamp', ts.toString());
    fd.append('reportId', rid);

    // âœ… æ–°å¢çš„ä¸‰å€‹æ¬„ä½
    fd.append('reportType', reportType);
    fd.append('companions', companionsChecked.join(','));
    fd.append('otherCompanionName', otherCompanionName);

    // é€å‡º
    const res = await fetch(WEB_APP_URL, { method: 'POST', body: fd });
    const rj = await res.json();

    if (rj.result === 'success') {
      alert('å›å ±æäº¤æˆåŠŸ');
      location.reload();
    } else {
      alert('æäº¤å¤±æ•—ï¼š' + (rj.message || ''));
    }
  } catch (e) {
    alert('éŒ¯èª¤: ' + e.message);
  }
  document.getElementById('submitBtn').disabled = false;
}
</script>
</body>