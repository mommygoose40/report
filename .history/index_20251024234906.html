<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>災情回報系統</title>
<script src="https://static.line-scdn.net/liff/edge/versions/2.22.3/sdk.js"></script>
<!-- Firebase SDK -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-analytics.js";
import { getStorage, ref, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-storage.js";

const firebaseConfig = {
  apiKey: "AIzaSyA4IZ6yZxlOuIjarWmUtIHGyLk84056K2Q",
  authDomain: "reportsystem-c5fc7.firebaseapp.com",
  projectId: "reportsystem-c5fc7",
  storageBucket: "reportsystem-c5fc7.firebasestorage.app",
  messagingSenderId: "845064058181",
  appId: "1:845064058181:web:31d2f0fa6dfed084befa2c",
  measurementId: "G-EDQM0LWQWH"
};

const app = initializeApp(firebaseConfig);
const analytics = getAnalytics(app);
const storage = getStorage(app);
window.firebaseStorage = { getStorage, ref, uploadBytesResumable, getDownloadURL, storage };
</script>

<style>
body {
  font-family: Arial, sans-serif;
  margin: 0;
  padding: 0;
  background-color: #f5f8ff;
}
.container {
  max-width: 800px;
  margin: 0 auto;
  padding: 20px;
}
.header {
  text-align: center;
  margin-bottom: 20px;
  padding-bottom: 10px;
  border-bottom: 2px solid #0b5ed7;
  color: #0b5ed7;
}
.form-section {
  background: white;
  padding: 20px;
  border-radius: 8px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  margin-bottom: 20px;
}
button {
  padding: 12px 20px;
  margin: 8px 5px;
  background: #0b5ed7;
  color: #fff;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  font-size: 16px;
}
#stopRecordBtn { background: #6c757d; }
input[type="text"] {
  padding: 12px;
  margin: 10px 0;
  width: 95%;
  border: 1px solid #ccc;
  border-radius: 8px;
  font-size: 16px;
}
.row { margin: 10px 0; }
.thumbs {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  justify-content: center;
  margin: 8px 0;
}
.thumb {
  position: relative;
  width: 90px;
  height: 90px;
  border-radius: 8px;
  overflow: hidden;
  border: 1px solid #ddd;
}
.thumb img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}
.thumb button {
  position: absolute;
  top: 4px;
  right: 4px;
  background: rgba(0,0,0,.6);
  border: none;
  color: #fff;
  border-radius: 6px;
  padding: 2px 6px;
  font-size: 12px;
}
progress {
  width: 100%;
  height: 20px;
  border: none;
  border-radius: 10px;
  background: #e0e0e0;
}
progress::-webkit-progress-value {
  background: linear-gradient(45deg, #0b5ed7, #0056b3);
  border-radius: 10px;
  transition: width 0.3s ease;
}
#uploadStatus {
  font-size: 14px;
  margin-top: 5px;
  color: #555;
  text-align: center;
}
audio { width: 100%; margin-top: 10px; }
</style>
</head>

<body>
<div class="container">
  <div id="form-page">
    <div class="header">
      <h1>災情回報</h1>
    </div>

    <!-- 相片 -->
    <div class="form-section">
      <div class="row">
        <button onclick="pickCamera()">開相機</button>
        <button onclick="pickGallery()">選相簿</button>
        <div class="thumbs" id="thumbs"></div>
        <input id="fileCamera" type="file" accept="image/*" capture="environment" style="display:none;">
        <input id="fileGallery" type="file" accept="image/*" multiple style="display:none;">
      </div>
    </div>

    <!-- 異常標記 -->
    <div class="form-section">
      <label style="font-size: 16px; display: block;">
        <input type="checkbox" id="isAbnormal" style="margin-right: 8px;">
        標記為異常回報
      </label>
      <p style="font-size: 12px; color: #666;">勾選後系統將自動把語音內容轉換為文字</p>
    </div>

    <!-- 災情類型 -->
    <div class="form-section">
      <label style="font-size:16px; margin-bottom:8px; display:block;">災情類型（可複選，非必填）</label>
      <label><input type="checkbox" name="disasterType" value="水利設施損害"> 水利設施損害</label><br>
      <label><input type="checkbox" name="disasterType" value="環境污染"> 環境污染</label><br>
      <label><input type="checkbox" name="disasterType" value="交通阻斷"> 交通阻斷</label>
    </div>

    <!-- 錄音與備註 -->
    <div class="form-section">
      <h3 style="color:#0b5ed7;">語音與備註</h3>
      <div class="row">
        <button id="recordBtn" onclick="startRecording()">開始錄音</button>
        <button id="stopRecordBtn" onclick="stopRecording()" disabled>停止錄音</button>
        <p id="recordingStatus">準備錄音...</p>
        <audio id="audioPlayback" controls style="display:none;"></audio>
      </div>
      <div class="row">
        <input type="text" id="summary" placeholder="請輸入備註（20字內）" maxlength="20"/>
      </div>
    </div>

    <!-- 進度條 -->
    <div class="form-section">
      <progress id="uploadProgress" value="0" max="100" style="display:none;"></progress>
      <div id="uploadStatus"></div>
    </div>

    <!-- 提交 -->
    <div class="form-section">
      <button id="submitBtn" onclick="submitForm()">提交回報</button>
      <div id="serverStatus" style="font-size:12px;color:#888;">伺服器狀態：檢查中...</div>
    </div>
  </div>
</div>

<script>
const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbyrVfdPQT4fmM4OTxEymk16AsgU_raKynnI7N0Ph1v8YPjiowhtAaPv4fCpKNkHhfs6Kg/exec';

liff.init({ liffId:'2007934728-xN6aOL3D' }).then(async ()=>{
  if(!liff.isLoggedIn()) liff.login();
  try{
    const r = await fetch(WEB_APP_URL);
    if(r.ok){
      document.getElementById('serverStatus').textContent='伺服器狀態：已連線';
      document.getElementById('serverStatus').style.color='#0b5ed7';
    }
  }catch(e){
    document.getElementById('serverStatus').textContent='伺服器狀態：無法連線';
    document.getElementById('serverStatus').style.color='red';
  }
});

const photos=[], thumbs=document.getElementById('thumbs');
const fileCamera=document.getElementById('fileCamera');
const fileGallery=document.getElementById('fileGallery');
function pickCamera(){ fileCamera.click(); }
function pickGallery(){ fileGallery.click(); }
fileCamera.addEventListener('change',()=>{ if(fileCamera.files[0]) addPhotos([fileCamera.files[0]]); fileCamera.value=''; });
fileGallery.addEventListener('change',()=>{ if(fileGallery.files.length) addPhotos([...fileGallery.files]); fileGallery.value=''; });
function addPhotos(files){ files.forEach(f=>{ if(!f.type.startsWith('image/')) return; const url=URL.createObjectURL(f); photos.push({file:f,url});}); renderThumbs(); }
function removePhoto(i){ const p=photos.splice(i,1)[0]; if(p&&p.url) URL.revokeObjectURL(p.url); renderThumbs(); }
function renderThumbs(){ thumbs.innerHTML=''; photos.forEach((p,i)=>{ const d=document.createElement('div'); d.className='thumb'; d.innerHTML=`<img src="${p.url}"><button onclick="removePhoto(${i})">刪除</button>`; thumbs.appendChild(d); }); }

let mediaRecorder=null,audioChunks=[],audioBlob=null;
async function startRecording(){
  try{
    const stream=await navigator.mediaDevices.getUserMedia({audio:true});
    const type=MediaRecorder.isTypeSupported('audio/webm;codecs=opus')?'audio/webm;codecs=opus':'audio/mp4';
    mediaRecorder=new MediaRecorder(stream,{mimeType:type});
    audioChunks=[];
    mediaRecorder.ondataavailable=e=>{ if(e.data.size>0) audioChunks.push(e.data); };
    mediaRecorder.onstop=()=>{
      audioBlob=new Blob(audioChunks,{type:audioChunks[0]?.type||'audio/webm'});
      const url=URL.createObjectURL(audioBlob);
      const p=document.getElementById('audioPlayback');
      p.src=url; p.style.display='block';
      document.getElementById('recordingStatus').textContent='錄音完成';
      document.getElementById('recordingStatus').style.color='#0b5ed7';
      stream.getTracks().forEach(t=>t.stop());
    };
    mediaRecorder.start();
    document.getElementById('recordingStatus').textContent='錄音中...';
    document.getElementById('recordingStatus').style.color='red';
    document.getElementById('recordBtn').disabled=true;
    document.getElementById('stopRecordBtn').disabled=false;
  }catch(err){ alert('無法使用麥克風'); }
}
function stopRecording(){
  if(mediaRecorder&&mediaRecorder.state==='recording'){
    mediaRecorder.stop();
    document.getElementById('recordBtn').disabled=false;
    document.getElementById('stopRecordBtn').disabled=true;
  }
}

async function compressImage(file){
  return new Promise(res=>{
    const img=new Image();
    img.onload=()=>{
      const c=document.createElement('canvas');
      const maxW=1280,scale=Math.min(1,maxW/img.width);
      c.width=img.width*scale; c.height=img.height*scale;
      c.getContext('2d').drawImage(img,0,0,c.width,c.height);
      c.toBlob(b=>res(new File([b],'photo.jpg',{type:'image/jpeg'})),'image/jpeg',0.7);
    };
    img.src=URL.createObjectURL(file);
  });
}

async function uploadToFirebase(file,path){
  const {ref,uploadBytesResumable,getDownloadURL}=window.firebaseStorage;
  const storageRef=ref(window.firebaseStorage.storage,path);
  const task=uploadBytesResumable(storageRef,file);
  return new Promise((res,rej)=>{
    task.on('state_changed',snap=>{
      const p=(snap.bytesTransferred/snap.totalBytes)*100;
      document.getElementById('uploadProgress').style.display='block';
      document.getElementById('uploadProgress').value=p;
      document.getElementById('uploadStatus').textContent=`上傳中 ${Math.round(p)}%`;
    },err=>rej(err),async()=>{
      res(await getDownloadURL(task.snapshot.ref));
    });
  });
}

async function transcribeAudio(blob,reportId){
  const buf=await blob.arrayBuffer();
  const arr=new Uint8Array(buf);
  let str=''; for(let i=0;i<arr.length;i++) str+=String.fromCharCode(arr[i]);
  const base64=btoa(str);
  const formData=new FormData();
  formData.append('action','transcribe');
  formData.append('audioData',base64);
  formData.append('reportId',reportId);
  const r=await fetch(WEB_APP_URL,{method:'POST',body:formData});
  const t=await r.text();
  try{
    const j=JSON.parse(t);
    if(j.result==='success'){
      const txt=j.transcription||'';
      return txt;
    }
  }catch(e){ return ''; }
  return '';
}

async function submitForm(){
  const summary=document.getElementById('summary').value.trim();
  const isAbnormal=document.getElementById('isAbnormal').checked;
  const types=Array.from(document.querySelectorAll('input[name="disasterType"]:checked')).map(el=>el.value).join(',');
  if(!summary){ alert('請輸入備註'); return; }
  document.getElementById('submitBtn').disabled=true;
  const ts=Date.now(),reportId=`report_${ts}`,photoUrls=[],progress=document.getElementById('uploadProgress');
  try{
    for(let i=0;i<photos.length;i++){
      const comp=await compressImage(photos[i].file);
      const url=await uploadToFirebase(comp,`reports/${reportId}/photo_${i}.jpg`);
      photoUrls.push(url);
    }
    let audioUrl='',transcription='';
    if(audioBlob){
      audioUrl=await uploadToFirebase(audioBlob,`reports/${reportId}/recording.webm`);
      if(isAbnormal) transcription=await transcribeAudio(audioBlob,reportId);
    }
    const formData=new FormData();
    formData.append('summary',document.getElementById('summary').value);
    formData.append('disasterType',types);
    formData.append('photoUrl',photoUrls.join(','));
    if(audioUrl) formData.append('audioUrl',audioUrl);
    formData.append('timestamp',ts.toString());
    formData.append('reportId',reportId);
    const res=await fetch(WEB_APP_URL,{method:'POST',body:formData});
    const rj=await res.json();
    if(rj.result==='success'){
      progress.value=100;
      alert('回報提交成功');
      document.getElementById('summary').value='';
      document.getElementById('uploadProgress').style.display='none';
      document.getElementById('uploadStatus').textContent='';
    }else alert('提交失敗');
  }catch(e){ alert('錯誤:'+e.message); }
  document.getElementById('submitBtn').disabled=false;
}
window.pickCamera=pickCamera;
window.pickGallery=pickGallery;
window.removePhoto=removePhoto;
window.startRecording=startRecording;
window.stopRecording=stopRecording;
window.submitForm=submitForm;
</script>
</body>
</html>
