<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>災情回報 - 問題解決方案</title>
    <script src="https://static.line-scdn.net/liff/edge/versions/2.22.3/sdk.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            text-align: center;
            max-width: 500px;
            margin: 0 auto;
            background-color: #f8f9fa;
            color: #333;
        }
        .container {
            background-color: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            margin-top: 20px;
        }
        h1 {
            color: #06c755;
            margin-bottom: 25px;
        }
        h2 {
            color: #ff4b4b;
            font-size: 20px;
            margin-top: 30px;
        }
        .problem-section, .solution-section {
            text-align: left;
            margin: 20px 0;
            padding: 15px;
            border-radius: 8px;
        }
        .problem-section {
            background-color: #ffeaea;
            border-left: 4px solid #ff4b4b;
        }
        .solution-section {
            background-color: #eaffea;
            border-left: 4px solid #06c755;
        }
        code {
            background-color: #f1f1f1;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: monospace;
        }
        pre {
            background-color: #2d2d2d;
            color: #f8f8f2;
            padding: 15px;
            border-radius: 8px;
            overflow-x: auto;
            text-align: left;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        .code-title {
            font-weight: bold;
            margin-top: 15px;
            text-align: left;
            color: #555;
        }
        .button {
            display: inline-block;
            padding: 12px 20px;
            margin: 10px 5px;
            background-color: #06c755;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            text-decoration: none;
        }
        .button-secondary {
            background-color: #4b7bec;
        }
        .steps {
            text-align: left;
            margin: 20px 0;
            padding-left: 20px;
        }
        .steps li {
            margin-bottom: 10px;
        }
        .code-container {
            max-height: 300px;
            overflow-y: auto;
            margin: 15px 0;
        }
    </style>
</head>
<body>
    <h1>災情回報系統問題解決方案</h1>
    
    <div class="container">
        <div class="problem-section">
            <h2>問題分析</h2>
            <p>您的語音消息無法上傳到Google雲端硬碟，主要原因有兩個：</p>
            <ol>
                <li>LIFF應用發送的是FormData格式，但Google Apps Script沒有正確處理multipart/form-data</li>
                <li><code>e.postData.contents</code>不是正確的訪問方式，需要解析multipart數據</li>
            </ol>
        </div>
        
        <div class="solution-section">
            <h2>解決方案</h2>
            <p>您需要更新Google Apps Script代碼，添加multipart/form-data解析功能：</p>
            
            <div class="code-title">更新後的Google Apps Script代碼：</div>
            <div class="code-container">
                <pre>function doPost(e) {
  try {
    const sheet = SpreadsheetApp.getActiveSheet();
    let summary = '';
    let voiceFileUrl = '';
    
    // 檢查是否為multipart/form-data格式
    const contentType = e.postData.type || '';
    
    if (contentType.includes('multipart/form-data')) {
      // 解析multipart/form-data
      const boundary = contentType.split('boundary=')[1];
      const parts = parseMultipart(e.postData.contents, boundary);
      
      // 處理各部分數據
      for (const part of parts) {
        if (part.headers['content-disposition'].includes('name="summary"')) {
          summary = part.body.toString().trim();
        } else if (part.headers['content-disposition'].includes('name="audio"')) {
          // 處理音頻文件
          try {
            const voiceFileName = 'audio_recording_' + new Date().getTime() + '.webm';
            const audioBlob = Utilities.newBlob(part.body, 'audio/webm', voiceFileName);
            
            // 將文件保存到Google Drive
            const folder = DriveApp.getRootFolder();
            const file = folder.createFile(audioBlob);
            file.setSharing(DriveApp.Access.ANYONE_WITH_LINK, DriveApp.Permission.VIEW);
            voiceFileUrl = file.getUrl();
          } catch (fileError) {
            console.error('文件處理錯誤:', fileError.toString());
          }
        }
      }
    } else {
      // 回退到原始處理方式（非multipart）
      summary = e.parameter.summary || '';
    }
    
    // 將數據寫入Google Sheets
    sheet.appendRow([
      new Date(),                     // 時間戳
      '',                             // location (預留位置)
      '',                             // disasterType (預留位置)
      '',                             // urgency (預留位置)
      voiceFileUrl,                   // 錄音檔網址
      '',                             // photoUrl (預留位置)
      '',                             // reporter (預留位置)
      summary                         // 志工自錄文字摘要
    ]);
    
    // 回傳成功消息給LIFF
    return ContentService.createTextOutput(JSON.stringify({
      result: 'success',
      message: '資料已成功儲存',
      audioFile: voiceFileUrl ? '已上傳' : '無錄音'
    })).setMimeType(ContentService.MimeType.JSON);
    
  } catch (error) {
    // 錯誤處理
    console.error('處理錯誤:', error.toString());
    
    return ContentService.createTextOutput(JSON.stringify({
      result: 'error',
      message: '處理失敗: ' + error.toString()
    })).setMimeType(ContentService.MimeType.JSON);
  }
}

// 解析multipart/form-data的輔助函數
function parseMultipart(body, boundary) {
  const parts = [];
  const lines = body.split('\r\n');
  let currentPart = null;
  
  for (let i = 0; i < lines.length; i++) {
    const line = lines[i];
    
    if (line.includes('--' + boundary)) {
      if (currentPart) {
        parts.push(currentPart);
      }
      currentPart = { headers: {}, body: [] };
      i++; // 跳過邊界行
      
      // 讀取頭部
      while (i < lines.length && lines[i] !== '') {
        const headerLine = lines[i];
        const separatorIndex = headerLine.indexOf(':');
        if (separatorIndex !== -1) {
          const key = headerLine.substring(0, separatorIndex).trim().toLowerCase();
          const value = headerLine.substring(separatorIndex + 1).trim();
          currentPart.headers[key] = value;
        }
        i++;
      }
      i++; // 跳過空行
    } else if (currentPart && line !== '--' + boundary + '--') {
      // 添加到正文
      currentPart.body.push(line);
    }
  }
  
  // 處理每個部分的正文
  for (const part of parts) {
    part.body = Utilities.newBlob(part.body.join('\r\n')).getBytes();
  }
  
  return parts;
}

// 添加doGet函數以避免錯誤
function doGet() {
  return ContentService.createTextOutput(JSON.stringify({
    result: 'error',
    message: '請使用POST方法提交數據'
  })).setMimeType(ContentService.MimeType.JSON);
}</pre>
            </div>
            
            <div class="code-title">LIFF應用的小修改：</div>
            <div class="code-container">
                <pre>// 提交表單
async function submitForm() {
  const summary = document.getElementById('summary').value.trim();
  
  if (!summary) {
    alert('請輸入災情摘要');
    return;
  }
  
  // 創建FormData來發送數據
  const formData = new FormData();
  formData.append('summary', summary);
  
  // 如果有錄音，添加錄音文件
  if (audioBlob) {
    formData.append('audio', audioBlob, 'recording.webm');
  }
  
  try {
    // 顯示加載中狀態
    const submitBtn = document.querySelector('button[onclick="submitForm()"]');
    const originalText = submitBtn.textContent;
    submitBtn.textContent = '提交中...';
    submitBtn.disabled = true;
    
    // 發送到 Google Apps Script
    const response = await fetch('https://script.google.com/macros/s/AKfycbyTwAMyU5DXtQuh0tfwwTBNTrX30E_zi0eD7RE0LjHkvgj1oCN3gKsdM9CF5bbuC7LdsQ/exec', {
      method: 'POST',
      body: formData
    });
    
    const result = await response.json();
    console.log('提交成功:', result);
    
    if (result.result === 'success') {
      alert('回報成功！');
      liff.closeWindow();
    } else {
      alert('回報失敗: ' + result.message);
      submitBtn.textContent = originalText;
      submitBtn.disabled = false;
    }
    
  } catch (error) {
    console.error('提交失敗:', error);
    alert('回報失敗，請重試');
    
    // 恢復按鈕狀態
    const submitBtn = document.querySelector('button[onclick="submitForm()"]');
    submitBtn.textContent = '📤 提交回報';
    submitBtn.disabled = false;
  }
}</pre>
            </div>
        </div>
        
        <h2>部署步驟</h2>
        <ol class="steps">
            <li>將上面的Google Apps Script代碼替換您原有的代碼</li>
            <li>在LIFF代碼中使用正確的Google Apps Script URL</li>
            <li>確保您的Google Apps Script已部署為"Web應用"，執行權限設置為"任何人，甚至匿名"</li>
            <li>確保您的Google Drive有足夠的存儲空間</li>
        </ol>
        
        <p>這個修復方案應該能解決語音消息無法上傳到Google雲端硬碟的問題。</p>
        
        <a href="#" class="button" onclick="window.location.reload()">刷新頁面</a>
        <a href="https://script.google.com/home" class="button button-secondary" target="_blank">打開Google Apps Script</a>
    </div>

    <script>
        // 初始化LIFF
        liff.init({ liffId: '2007934728-xN6aOL3D' })
            .then(() => {
                console.log('LIFF 初始化成功');
                if (!liff.isLoggedIn()) {
                    liff.login();
                }
            })
            .catch((err) => {
                console.error('LIFF 初始化失敗:', err);
            });
    </script>
</body>
</html>