<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç½æƒ…å›å ± - å•é¡Œè§£æ±ºæ–¹æ¡ˆ</title>
    <script src="https://static.line-scdn.net/liff/edge/versions/2.22.3/sdk.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            text-align: center;
            max-width: 500px;
            margin: 0 auto;
            background-color: #f8f9fa;
            color: #333;
        }
        .container {
            background-color: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            margin-top: 20px;
        }
        h1 {
            color: #06c755;
            margin-bottom: 25px;
        }
        h2 {
            color: #ff4b4b;
            font-size: 20px;
            margin-top: 30px;
        }
        .problem-section, .solution-section {
            text-align: left;
            margin: 20px 0;
            padding: 15px;
            border-radius: 8px;
        }
        .problem-section {
            background-color: #ffeaea;
            border-left: 4px solid #ff4b4b;
        }
        .solution-section {
            background-color: #eaffea;
            border-left: 4px solid #06c755;
        }
        code {
            background-color: #f1f1f1;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: monospace;
        }
        pre {
            background-color: #2d2d2d;
            color: #f8f8f2;
            padding: 15px;
            border-radius: 8px;
            overflow-x: auto;
            text-align: left;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        .code-title {
            font-weight: bold;
            margin-top: 15px;
            text-align: left;
            color: #555;
        }
        .button {
            display: inline-block;
            padding: 12px 20px;
            margin: 10px 5px;
            background-color: #06c755;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            text-decoration: none;
        }
        .button-secondary {
            background-color: #4b7bec;
        }
        .steps {
            text-align: left;
            margin: 20px 0;
            padding-left: 20px;
        }
        .steps li {
            margin-bottom: 10px;
        }
        .code-container {
            max-height: 300px;
            overflow-y: auto;
            margin: 15px 0;
        }
    </style>
</head>
<body>
    <h1>ç½æƒ…å›å ±ç³»çµ±å•é¡Œè§£æ±ºæ–¹æ¡ˆ</h1>
    
    <div class="container">
        <div class="problem-section">
            <h2>å•é¡Œåˆ†æ</h2>
            <p>æ‚¨çš„èªéŸ³æ¶ˆæ¯ç„¡æ³•ä¸Šå‚³åˆ°Googleé›²ç«¯ç¡¬ç¢Ÿï¼Œä¸»è¦åŸå› æœ‰å…©å€‹ï¼š</p>
            <ol>
                <li>LIFFæ‡‰ç”¨ç™¼é€çš„æ˜¯FormDataæ ¼å¼ï¼Œä½†Google Apps Scriptæ²’æœ‰æ­£ç¢ºè™•ç†multipart/form-data</li>
                <li><code>e.postData.contents</code>ä¸æ˜¯æ­£ç¢ºçš„è¨ªå•æ–¹å¼ï¼Œéœ€è¦è§£æmultipartæ•¸æ“š</li>
            </ol>
        </div>
        
        <div class="solution-section">
            <h2>è§£æ±ºæ–¹æ¡ˆ</h2>
            <p>æ‚¨éœ€è¦æ›´æ–°Google Apps Scriptä»£ç¢¼ï¼Œæ·»åŠ multipart/form-dataè§£æåŠŸèƒ½ï¼š</p>
            
            <div class="code-title">æ›´æ–°å¾Œçš„Google Apps Scriptä»£ç¢¼ï¼š</div>
            <div class="code-container">
                <pre>function doPost(e) {
  try {
    const sheet = SpreadsheetApp.getActiveSheet();
    let summary = '';
    let voiceFileUrl = '';
    
    // æª¢æŸ¥æ˜¯å¦ç‚ºmultipart/form-dataæ ¼å¼
    const contentType = e.postData.type || '';
    
    if (contentType.includes('multipart/form-data')) {
      // è§£æmultipart/form-data
      const boundary = contentType.split('boundary=')[1];
      const parts = parseMultipart(e.postData.contents, boundary);
      
      // è™•ç†å„éƒ¨åˆ†æ•¸æ“š
      for (const part of parts) {
        if (part.headers['content-disposition'].includes('name="summary"')) {
          summary = part.body.toString().trim();
        } else if (part.headers['content-disposition'].includes('name="audio"')) {
          // è™•ç†éŸ³é »æ–‡ä»¶
          try {
            const voiceFileName = 'audio_recording_' + new Date().getTime() + '.webm';
            const audioBlob = Utilities.newBlob(part.body, 'audio/webm', voiceFileName);
            
            // å°‡æ–‡ä»¶ä¿å­˜åˆ°Google Drive
            const folder = DriveApp.getRootFolder();
            const file = folder.createFile(audioBlob);
            file.setSharing(DriveApp.Access.ANYONE_WITH_LINK, DriveApp.Permission.VIEW);
            voiceFileUrl = file.getUrl();
          } catch (fileError) {
            console.error('æ–‡ä»¶è™•ç†éŒ¯èª¤:', fileError.toString());
          }
        }
      }
    } else {
      // å›é€€åˆ°åŸå§‹è™•ç†æ–¹å¼ï¼ˆémultipartï¼‰
      summary = e.parameter.summary || '';
    }
    
    // å°‡æ•¸æ“šå¯«å…¥Google Sheets
    sheet.appendRow([
      new Date(),                     // æ™‚é–“æˆ³
      '',                             // location (é ç•™ä½ç½®)
      '',                             // disasterType (é ç•™ä½ç½®)
      '',                             // urgency (é ç•™ä½ç½®)
      voiceFileUrl,                   // éŒ„éŸ³æª”ç¶²å€
      '',                             // photoUrl (é ç•™ä½ç½®)
      '',                             // reporter (é ç•™ä½ç½®)
      summary                         // å¿—å·¥è‡ªéŒ„æ–‡å­—æ‘˜è¦
    ]);
    
    // å›å‚³æˆåŠŸæ¶ˆæ¯çµ¦LIFF
    return ContentService.createTextOutput(JSON.stringify({
      result: 'success',
      message: 'è³‡æ–™å·²æˆåŠŸå„²å­˜',
      audioFile: voiceFileUrl ? 'å·²ä¸Šå‚³' : 'ç„¡éŒ„éŸ³'
    })).setMimeType(ContentService.MimeType.JSON);
    
  } catch (error) {
    // éŒ¯èª¤è™•ç†
    console.error('è™•ç†éŒ¯èª¤:', error.toString());
    
    return ContentService.createTextOutput(JSON.stringify({
      result: 'error',
      message: 'è™•ç†å¤±æ•—: ' + error.toString()
    })).setMimeType(ContentService.MimeType.JSON);
  }
}

// è§£æmultipart/form-dataçš„è¼”åŠ©å‡½æ•¸
function parseMultipart(body, boundary) {
  const parts = [];
  const lines = body.split('\r\n');
  let currentPart = null;
  
  for (let i = 0; i < lines.length; i++) {
    const line = lines[i];
    
    if (line.includes('--' + boundary)) {
      if (currentPart) {
        parts.push(currentPart);
      }
      currentPart = { headers: {}, body: [] };
      i++; // è·³éé‚Šç•Œè¡Œ
      
      // è®€å–é ­éƒ¨
      while (i < lines.length && lines[i] !== '') {
        const headerLine = lines[i];
        const separatorIndex = headerLine.indexOf(':');
        if (separatorIndex !== -1) {
          const key = headerLine.substring(0, separatorIndex).trim().toLowerCase();
          const value = headerLine.substring(separatorIndex + 1).trim();
          currentPart.headers[key] = value;
        }
        i++;
      }
      i++; // è·³éç©ºè¡Œ
    } else if (currentPart && line !== '--' + boundary + '--') {
      // æ·»åŠ åˆ°æ­£æ–‡
      currentPart.body.push(line);
    }
  }
  
  // è™•ç†æ¯å€‹éƒ¨åˆ†çš„æ­£æ–‡
  for (const part of parts) {
    part.body = Utilities.newBlob(part.body.join('\r\n')).getBytes();
  }
  
  return parts;
}

// æ·»åŠ doGetå‡½æ•¸ä»¥é¿å…éŒ¯èª¤
function doGet() {
  return ContentService.createTextOutput(JSON.stringify({
    result: 'error',
    message: 'è«‹ä½¿ç”¨POSTæ–¹æ³•æäº¤æ•¸æ“š'
  })).setMimeType(ContentService.MimeType.JSON);
}</pre>
            </div>
            
            <div class="code-title">LIFFæ‡‰ç”¨çš„å°ä¿®æ”¹ï¼š</div>
            <div class="code-container">
                <pre>// æäº¤è¡¨å–®
async function submitForm() {
  const summary = document.getElementById('summary').value.trim();
  
  if (!summary) {
    alert('è«‹è¼¸å…¥ç½æƒ…æ‘˜è¦');
    return;
  }
  
  // å‰µå»ºFormDataä¾†ç™¼é€æ•¸æ“š
  const formData = new FormData();
  formData.append('summary', summary);
  
  // å¦‚æœæœ‰éŒ„éŸ³ï¼Œæ·»åŠ éŒ„éŸ³æ–‡ä»¶
  if (audioBlob) {
    formData.append('audio', audioBlob, 'recording.webm');
  }
  
  try {
    // é¡¯ç¤ºåŠ è¼‰ä¸­ç‹€æ…‹
    const submitBtn = document.querySelector('button[onclick="submitForm()"]');
    const originalText = submitBtn.textContent;
    submitBtn.textContent = 'æäº¤ä¸­...';
    submitBtn.disabled = true;
    
    // ç™¼é€åˆ° Google Apps Script
    const response = await fetch('https://script.google.com/macros/s/AKfycbyTwAMyU5DXtQuh0tfwwTBNTrX30E_zi0eD7RE0LjHkvgj1oCN3gKsdM9CF5bbuC7LdsQ/exec', {
      method: 'POST',
      body: formData
    });
    
    const result = await response.json();
    console.log('æäº¤æˆåŠŸ:', result);
    
    if (result.result === 'success') {
      alert('å›å ±æˆåŠŸï¼');
      liff.closeWindow();
    } else {
      alert('å›å ±å¤±æ•—: ' + result.message);
      submitBtn.textContent = originalText;
      submitBtn.disabled = false;
    }
    
  } catch (error) {
    console.error('æäº¤å¤±æ•—:', error);
    alert('å›å ±å¤±æ•—ï¼Œè«‹é‡è©¦');
    
    // æ¢å¾©æŒ‰éˆ•ç‹€æ…‹
    const submitBtn = document.querySelector('button[onclick="submitForm()"]');
    submitBtn.textContent = 'ğŸ“¤ æäº¤å›å ±';
    submitBtn.disabled = false;
  }
}</pre>
            </div>
        </div>
        
        <h2>éƒ¨ç½²æ­¥é©Ÿ</h2>
        <ol class="steps">
            <li>å°‡ä¸Šé¢çš„Google Apps Scriptä»£ç¢¼æ›¿æ›æ‚¨åŸæœ‰çš„ä»£ç¢¼</li>
            <li>åœ¨LIFFä»£ç¢¼ä¸­ä½¿ç”¨æ­£ç¢ºçš„Google Apps Script URL</li>
            <li>ç¢ºä¿æ‚¨çš„Google Apps Scriptå·²éƒ¨ç½²ç‚º"Webæ‡‰ç”¨"ï¼ŒåŸ·è¡Œæ¬Šé™è¨­ç½®ç‚º"ä»»ä½•äººï¼Œç”šè‡³åŒ¿å"</li>
            <li>ç¢ºä¿æ‚¨çš„Google Driveæœ‰è¶³å¤ çš„å­˜å„²ç©ºé–“</li>
        </ol>
        
        <p>é€™å€‹ä¿®å¾©æ–¹æ¡ˆæ‡‰è©²èƒ½è§£æ±ºèªéŸ³æ¶ˆæ¯ç„¡æ³•ä¸Šå‚³åˆ°Googleé›²ç«¯ç¡¬ç¢Ÿçš„å•é¡Œã€‚</p>
        
        <a href="#" class="button" onclick="window.location.reload()">åˆ·æ–°é é¢</a>
        <a href="https://script.google.com/home" class="button button-secondary" target="_blank">æ‰“é–‹Google Apps Script</a>
    </div>

    <script>
        // åˆå§‹åŒ–LIFF
        liff.init({ liffId: '2007934728-xN6aOL3D' })
            .then(() => {
                console.log('LIFF åˆå§‹åŒ–æˆåŠŸ');
                if (!liff.isLoggedIn()) {
                    liff.login();
                }
            })
            .catch((err) => {
                console.error('LIFF åˆå§‹åŒ–å¤±æ•—:', err);
            });
    </script>
</body>
</html>