<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ç½æƒ…å›å ±</title>
  <script src="https://static.line-scdn.net/liff/edge/versions/2.22.3/sdk.js"></script>
  <style>
    body{font-family:Arial,sans-serif;padding:20px;text-align:center;max-width:400px;margin:0 auto;}
    button{padding:12px 20px;margin:10px 5px;background:#06c755;color:#fff;border:none;border-radius:8px;cursor:pointer;font-size:16px;}
    #stopRecordBtn{background:#ff4b4b;}
    input{padding:12px;margin:15px 0;width:90%;border:1px solid #ccc;border-radius:8px;font-size:16px;}
    #recordingStatus{margin:15px 0;color:#666;font-style:italic;}
    #audioPlayback{margin:15px 0;width:100%;}
    #serverStatus{font-size:12px;color:#888;margin-top:8px;}
  </style>
</head>
<body>
  <h1>ç½æƒ…å›å ±</h1>

  <button id="recordBtn" onclick="startRecording()">ğŸ¤ é–‹å§‹éŒ„éŸ³</button>
  <button id="stopRecordBtn" onclick="stopRecording()" disabled>â¹ï¸ åœæ­¢éŒ„éŸ³</button>
  <p id="recordingStatus">æº–å‚™éŒ„éŸ³...</p>
  <audio id="audioPlayback" controls style="display:none;"></audio>

  <input type="text" id="summary" placeholder="è«‹è¼¸å…¥ç½æƒ…æ‘˜è¦ï¼ˆ20å­—å…§ï¼‰" maxlength="20"/>
  <br/>
  <button id="submitBtn" onclick="submitForm()">ğŸ“¤ æäº¤å›å ±</button>
  <div id="serverStatus">ä¼ºæœå™¨ç‹€æ…‹ï¼šæª¢æŸ¥ä¸­...</div>

  <script>
  // æ›æˆä½ ã€Œå·²å¯ä¿å­˜æ‘˜è¦ã€çš„æœ€æ–° /exec URL
  const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbzLBB3V1ZmBtzRPPVow2BjKkOryAO3UUnljimcwDenmIEo0rE0Fvn1DjkmI1VH5gnxypg/exec';

  let mediaRecorder = null;
  let audioChunks = [];
  let audioBlob = null;

  const $ = s => document.querySelector(s);
  const setBusy = b => { const btn=$('#submitBtn'); btn.disabled=b; btn.textContent=b?'â³ é€å‡ºä¸­â€¦':'ğŸ“¤ æäº¤å›å ±'; };

  liff.init({ liffId: '2007934728-xN6aOL3D' })
    .then(async () => {
      if (!liff.isLoggedIn()) liff.login();
      // å¥åº·æª¢æŸ¥ï¼ˆå¯é¸ï¼‰
      try {
        const r = await fetch(WEB_APP_URL, { method: 'GET', cache: 'no-store' });
        console.log('PING /exec:', await r.text());
      } catch (e) {
        console.warn('PING å¤±æ•—ï¼š', e);
      }
    })
    .catch(err => {
      console.error('LIFF åˆå§‹åŒ–å¤±æ•—:', err);
      alert('åˆå§‹åŒ–å¤±æ•—ï¼Œè«‹é‡æ–°é–‹å•Ÿ');
    });

  async function startRecording() {
    try {
      const stream = await navigator.mediaDevices.getUserMedia({ audio:{ echoCancellation:true, noiseSuppression:true } });
      mediaRecorder = new MediaRecorder(stream); // ä¸å¼·åˆ¶ mimeType æå‡ç›¸å®¹æ€§
      audioChunks = [];
      mediaRecorder.ondataavailable = e => { if (e.data && e.data.size > 0) audioChunks.push(e.data); };
      mediaRecorder.onstop = () => {
        audioBlob = new Blob(audioChunks, { type: audioChunks[0]?.type || 'audio/webm' });
        console.log('audioBlob type:', audioBlob.type, 'size:', audioBlob.size);
        const url = URL.createObjectURL(audioBlob);
        const p = $('#audioPlayback'); p.src = url; p.style.display = 'block';
        $('#recordingStatus').textContent = 'éŒ„éŸ³å®Œæˆï¼æ‚¨å¯ä»¥æ’­æ”¾é è¦½ã€‚';
        $('#recordingStatus').style.color = 'green';
        stream.getTracks().forEach(t => t.stop());
      };
      mediaRecorder.start();
      $('#recordingStatus').textContent = 'éŒ„éŸ³ä¸­...'; $('#recordingStatus').style.color = 'red';
      $('#recordBtn').disabled = true; $('#stopRecordBtn').disabled = false;
    } catch (err) {
      console.error('éŒ„éŸ³å¤±æ•—:', err);
      alert('ç„¡æ³•å­˜å–éº¥å…‹é¢¨ï¼Œè«‹ç¢ºèªæ¬Šé™è¨­å®š');
    }
  }
  function stopRecording() {
    if (mediaRecorder && mediaRecorder.state === 'recording') {
      mediaRecorder.stop();
      $('#recordBtn').disabled = false; $('#stopRecordBtn').disabled = true;
    }
  }

  // å°‡ Blob è½‰æˆ base64ï¼ˆå‚™æ´ç”¨ï¼‰
  async function blobToBase64(blob) {
    const buf = await blob.arrayBuffer();
    const bytes = new Uint8Array(buf);
    let bin = '';
    for (let i = 0; i < bytes.byteLength; i++) bin += String.fromCharCode(bytes[i]);
    return btoa(bin);
  }

  // é€å‡ºï¼šFormData + base64 å‚™æ´
  async function submitForm() {
    const summary = $('#summary').value.trim();
    if (!summary) { alert('è«‹è¼¸å…¥ç½æƒ…æ‘˜è¦'); return; }

    if (audioBlob && audioBlob.size === 0) {
      console.warn('éŸ³æª” size=0ï¼Œç•¥éä¸Šå‚³');
      audioBlob = null;
    }

    const formData = new FormData();
    formData.append('summary', summary);

    if (audioBlob) {
      // 1) æ­£å¸¸çš„æª”æ¡ˆæ¬„ä½ï¼ˆä¸»è¦è·¯å¾‘ï¼‰
      formData.append('audio', audioBlob, 'recording');

      // 2) å‚™æ´ï¼šåŒæ™‚é™„ä¸Š base64 + metadataï¼ˆè‹¥å¾Œç«¯æ”¶ä¸åˆ° e.filesï¼Œæœƒæ”¹ç”¨é€™çµ„ï¼‰
      try {
        const b64 = await blobToBase64(audioBlob);
        formData.append('audio_b64', b64);
        formData.append('audio_ct', audioBlob.type || 'audio/webm');
        formData.append('audio_name', 'recording');
      } catch (e) {
        console.warn('è½‰ base64 å¤±æ•—ï¼Œç•¥éå‚™æ´æ¬„ä½ï¼š', e);
      }
    }

    setBusy(true);
    try {
      const resp = await fetch(WEB_APP_URL, { method: 'POST', body: formData }); // åˆ‡è¨˜ï¼šä¸è¦è‡ªè¨­ Content-Type
      if (!resp.ok) {
        const t = await resp.text().catch(()=> '');
        console.error('HTTP é 2xxï¼š', resp.status, t);
        alert(`æäº¤å¤±æ•—ï¼ˆHTTP ${resp.status}ï¼‰ã€‚`);
        setBusy(false); return;
      }
      let result;
      try { result = await resp.json(); }
      catch { const t = await resp.text(); console.warn('å›æ‡‰é JSONï¼š', t); alert('ä¼ºæœå™¨å›æ‡‰é JSONï¼Œè«‹çœ‹æ—¥èªŒ'); setBusy(false); return; }

      console.log('æäº¤å›å‚³:', result);
      const extras =
        (result.textFileUrl ? `\næ–‡å­—æª”ï¼š${result.textFileUrl}` : '') +
        (result.audioFileUrl ? `\néŸ³æª”ï¼š${result.audioFileUrl}` : '');
      alert((result.message || 'å®Œæˆ') + extras);

      // liff.closeWindow(); // ç¢ºèªç©©å®šå¾Œå†æ‰“é–‹
    } catch (err) {
      console.error('æäº¤éŒ¯èª¤ï¼š', err);
      alert('æäº¤å¤±æ•—ï¼šç„¡æ³•é€£ç·šåˆ°ä¼ºæœå™¨ï¼ˆè«‹ç¢ºèª /exec URL èˆ‡éƒ¨ç½²æ¬Šé™ï¼‰ã€‚');
    } finally {
      setBusy(false);
    }
  }

  window.startRecording = startRecording;
  window.stopRecording = stopRecording;
  window.submitForm = submitForm;
</script>

</body>
</html>
