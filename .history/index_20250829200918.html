<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>災情回報</title>
  <script src="https://static.line-scdn.net/liff/edge/versions/2.22.3/sdk.js"></script>
  <style>
    body{font-family:Arial,sans-serif;padding:20px;text-align:center;max-width:400px;margin:0 auto;}
    button{padding:12px 20px;margin:10px 5px;background:#06c755;color:#fff;border:none;border-radius:8px;cursor:pointer;font-size:16px;}
    #stopRecordBtn{background:#ff4b4b;}
    input{padding:12px;margin:15px 0;width:90%;border:1px solid #ccc;border-radius:8px;font-size:16px;}
    #recordingStatus{margin:15px 0;color:#666;font-style:italic;}
    #audioPlayback{margin:15px 0;width:100%;}
    #serverStatus{font-size:12px;color:#888;margin-top:8px;}
  </style>
</head>
<body>
  <h1>災情回報</h1>

  <button id="recordBtn" onclick="startRecording()">🎤 開始錄音</button>
  <button id="stopRecordBtn" onclick="stopRecording()" disabled>⏹️ 停止錄音</button>
  <p id="recordingStatus">準備錄音...</p>
  <audio id="audioPlayback" controls style="display:none;"></audio>

  <input type="text" id="summary" placeholder="請輸入災情摘要（20字內）" maxlength="20"/>
  <br/>
  <button id="submitBtn" onclick="submitForm()">📤 提交回報</button>
  <div id="serverStatus">伺服器狀態：檢查中...</div>

  <script>
  // 換成你「已可保存摘要」的最新 /exec URL
  const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbzLBB3V1ZmBtzRPPVow2BjKkOryAO3UUnljimcwDenmIEo0rE0Fvn1DjkmI1VH5gnxypg/exec';

  let mediaRecorder = null;
  let audioChunks = [];
  let audioBlob = null;

  const $ = s => document.querySelector(s);
  const setBusy = b => { const btn=$('#submitBtn'); btn.disabled=b; btn.textContent=b?'⏳ 送出中…':'📤 提交回報'; };

  liff.init({ liffId: '2007934728-xN6aOL3D' })
    .then(async () => {
      if (!liff.isLoggedIn()) liff.login();
      // 健康檢查（可選）
      try {
        const r = await fetch(WEB_APP_URL, { method: 'GET', cache: 'no-store' });
        console.log('PING /exec:', await r.text());
      } catch (e) {
        console.warn('PING 失敗：', e);
      }
    })
    .catch(err => {
      console.error('LIFF 初始化失敗:', err);
      alert('初始化失敗，請重新開啟');
    });

  async function startRecording() {
    try {
      const stream = await navigator.mediaDevices.getUserMedia({ audio:{ echoCancellation:true, noiseSuppression:true } });
      mediaRecorder = new MediaRecorder(stream); // 不強制 mimeType 提升相容性
      audioChunks = [];
      mediaRecorder.ondataavailable = e => { if (e.data && e.data.size > 0) audioChunks.push(e.data); };
      mediaRecorder.onstop = () => {
        audioBlob = new Blob(audioChunks, { type: audioChunks[0]?.type || 'audio/webm' });
        console.log('audioBlob type:', audioBlob.type, 'size:', audioBlob.size);
        const url = URL.createObjectURL(audioBlob);
        const p = $('#audioPlayback'); p.src = url; p.style.display = 'block';
        $('#recordingStatus').textContent = '錄音完成！您可以播放預覽。';
        $('#recordingStatus').style.color = 'green';
        stream.getTracks().forEach(t => t.stop());
      };
      mediaRecorder.start();
      $('#recordingStatus').textContent = '錄音中...'; $('#recordingStatus').style.color = 'red';
      $('#recordBtn').disabled = true; $('#stopRecordBtn').disabled = false;
    } catch (err) {
      console.error('錄音失敗:', err);
      alert('無法存取麥克風，請確認權限設定');
    }
  }
  function stopRecording() {
    if (mediaRecorder && mediaRecorder.state === 'recording') {
      mediaRecorder.stop();
      $('#recordBtn').disabled = false; $('#stopRecordBtn').disabled = true;
    }
  }

  // 將 Blob 轉成 base64（備援用）
  async function blobToBase64(blob) {
    const buf = await blob.arrayBuffer();
    const bytes = new Uint8Array(buf);
    let bin = '';
    for (let i = 0; i < bytes.byteLength; i++) bin += String.fromCharCode(bytes[i]);
    return btoa(bin);
  }

  // 送出：FormData + base64 備援
  async function submitForm() {
    const summary = $('#summary').value.trim();
    if (!summary) { alert('請輸入災情摘要'); return; }

    if (audioBlob && audioBlob.size === 0) {
      console.warn('音檔 size=0，略過上傳');
      audioBlob = null;
    }

    const formData = new FormData();
    formData.append('summary', summary);

    if (audioBlob) {
      // 1) 正常的檔案欄位（主要路徑）
      formData.append('audio', audioBlob, 'recording');

      // 2) 備援：同時附上 base64 + metadata（若後端收不到 e.files，會改用這組）
      try {
        const b64 = await blobToBase64(audioBlob);
        formData.append('audio_b64', b64);
        formData.append('audio_ct', audioBlob.type || 'audio/webm');
        formData.append('audio_name', 'recording');
      } catch (e) {
        console.warn('轉 base64 失敗，略過備援欄位：', e);
      }
    }

    setBusy(true);
    try {
      const resp = await fetch(WEB_APP_URL, { method: 'POST', body: formData }); // 切記：不要自設 Content-Type
      if (!resp.ok) {
        const t = await resp.text().catch(()=> '');
        console.error('HTTP 非 2xx：', resp.status, t);
        alert(`提交失敗（HTTP ${resp.status}）。`);
        setBusy(false); return;
      }
      let result;
      try { result = await resp.json(); }
      catch { const t = await resp.text(); console.warn('回應非 JSON：', t); alert('伺服器回應非 JSON，請看日誌'); setBusy(false); return; }

      console.log('提交回傳:', result);
      const extras =
        (result.textFileUrl ? `\n文字檔：${result.textFileUrl}` : '') +
        (result.audioFileUrl ? `\n音檔：${result.audioFileUrl}` : '');
      alert((result.message || '完成') + extras);

      // liff.closeWindow(); // 確認穩定後再打開
    } catch (err) {
      console.error('提交錯誤：', err);
      alert('提交失敗：無法連線到伺服器（請確認 /exec URL 與部署權限）。');
    } finally {
      setBusy(false);
    }
  }

  window.startRecording = startRecording;
  window.stopRecording = stopRecording;
  window.submitForm = submitForm;
</script>

</body>
</html>
