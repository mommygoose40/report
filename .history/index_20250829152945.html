<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ç½æƒ…å›å ±</title>
  <script src="https://static.line-scdn.net/liff/edge/versions/2.22.3/sdk.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; text-align: center; max-width: 400px; margin: 0 auto; }
    button { padding: 12px 20px; margin: 10px 5px; background-color: #06c755; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; }
    #stopRecordBtn { background-color: #ff4b4b; }
    input { padding: 12px; margin: 15px 0; width: 90%; border: 1px solid #ccc; border-radius: 8px; font-size: 16px; }
    #recordingStatus { margin: 15px 0; color: #666; font-style: italic; }
    #audioPlayback { margin: 15px 0; width: 100%; }
    #serverStatus { font-size: 12px; color: #888; margin-top: 8px; }
  </style>
</head>
<body>
  <h1>ç½æƒ…å›å ±</h1>

  <!-- éŒ„éŸ³å€å¡Š -->
  <button id="recordBtn" onclick="startRecording()">ğŸ¤ é–‹å§‹éŒ„éŸ³</button>
  <button id="stopRecordBtn" onclick="stopRecording()" disabled>â¹ï¸ åœæ­¢éŒ„éŸ³</button>

  <p id="recordingStatus">æº–å‚™éŒ„éŸ³...</p>
  <audio id="audioPlayback" controls style="display:none;"></audio>

  <!-- æ–‡å­—æ‘˜è¦ -->
  <input type="text" id="summary" placeholder="è«‹è¼¸å…¥ç½æƒ…æ‘˜è¦ï¼ˆ20å­—å…§ï¼‰" maxlength="20" />
  <br/>

  <!-- æäº¤ -->
  <button id="submitBtn" onclick="submitForm()">ğŸ“¤ æäº¤å›å ±</button>
  <div id="serverStatus">ä¼ºæœå™¨ç‹€æ…‹ï¼šæª¢æŸ¥ä¸­...</div>

  <script>
    // ======== æ›æˆä½ ã€Œæœ€æ–°ã€Web App URLï¼ˆ/execï¼‰ ========
    const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbyTTNTKmHDIdBI7fB1gS9AQBpwSxTcYCRip4KBH-qhmB14n4xNTQyZsuhxXoEu5Ope-lg/exec';
    // ====================================================

    // éŒ„éŸ³è®Šæ•¸
    let mediaRecorder = null;
    let audioChunks = [];
    let audioBlob = null;

    // å°å·¥å…·
    const $ = (sel) => document.querySelector(sel);
    const setBusy = (busy) => {
      const btn = $('#submitBtn');
      btn.disabled = busy;
      btn.textContent = busy ? 'â³ é€å‡ºä¸­â€¦' : 'ğŸ“¤ æäº¤å›å ±';
    };

    // åˆå§‹åŒ– LIFF & æª¢æŸ¥ä¼ºæœå™¨
    liff.init({ liffId: '2007934728-xN6aOL3D' })
      .then(async () => {
        console.log('LIFF åˆå§‹åŒ–æˆåŠŸ');
        if (!liff.isLoggedIn()) liff.login();

        // PING /execï¼ˆéœ€å¾Œç«¯æœ‰ doGetï¼‰
        try {
          const r = await fetch(WEB_APP_URL, { method: 'GET', cache: 'no-store' });
          const t = await r.text();
          console.log('PING /exec:', t);
          $('#serverStatus').textContent = 'ä¼ºæœå™¨ç‹€æ…‹ï¼šå·²é€£ç·š';
          $('#serverStatus').style.color = '#06c755';
        } catch (e) {
          console.error('PING å¤±æ•—ï¼š', e);
          $('#serverStatus').textContent = 'ä¼ºæœå™¨ç‹€æ…‹ï¼šç„¡æ³•é€£ç·šï¼ˆè«‹æª¢æŸ¥éƒ¨ç½²/æ¬Šé™/URLï¼‰';
          $('#serverStatus').style.color = '#ff4b4b';
        }
      })
      .catch(err => {
        console.error('LIFF åˆå§‹åŒ–å¤±æ•—:', err);
        alert('åˆå§‹åŒ–å¤±æ•—ï¼Œè«‹é‡æ–°é–‹å•Ÿ');
      });

    // é–‹å§‹éŒ„éŸ³
    async function startRecording() {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({
          audio: { echoCancellation: true, noiseSuppression: true }
        });

        // ä¸å¼·åˆ¶æŒ‡å®š mimeTypeï¼Œè®“è£ç½®è‡ªè¡Œæ±ºå®šä»¥å¢åŠ ç›¸å®¹æ€§
        mediaRecorder = new MediaRecorder(stream);
        audioChunks = [];

        mediaRecorder.ondataavailable = (evt) => {
          if (evt.data && evt.data.size > 0) audioChunks.push(evt.data);
        };

        mediaRecorder.onstop = () => {
          audioBlob = new Blob(audioChunks, { type: audioChunks[0]?.type || 'audio/webm' });
          console.log('audioBlob type:', audioBlob.type, 'size:', audioBlob.size);

          const audioUrl = URL.createObjectURL(audioBlob);
          const audioPlayback = $('#audioPlayback');
          audioPlayback.src = audioUrl;
          audioPlayback.style.display = 'block';

          $('#recordingStatus').textContent = 'éŒ„éŸ³å®Œæˆï¼æ‚¨å¯ä»¥æ’­æ”¾é è¦½ã€‚';
          $('#recordingStatus').style.color = 'green';

          stream.getTracks().forEach(t => t.stop());
        };

        mediaRecorder.start();

        $('#recordingStatus').textContent = 'éŒ„éŸ³ä¸­...';
        $('#recordingStatus').style.color = 'red';
        $('#recordBtn').disabled = true;
        $('#stopRecordBtn').disabled = false;

      } catch (err) {
        console.error('éŒ„éŸ³å¤±æ•—:', err);
        alert('ç„¡æ³•å­˜å–éº¥å…‹é¢¨ï¼Œè«‹ç¢ºèªæ¬Šé™è¨­å®š');
      }
    }

    // åœæ­¢éŒ„éŸ³
    function stopRecording() {
      if (mediaRecorder && mediaRecorder.state === 'recording') {
        mediaRecorder.stop();
        $('#recordBtn').disabled = false;
        $('#stopRecordBtn').disabled = true;
      }
    }

    // Blob -> Base64
    async function blobToBase64(blob) {
      const buf = await blob.arrayBuffer();
      const bytes = new Uint8Array(buf);
      let bin = '';
      for (let i = 0; i < bytes.byteLength; i++) bin += String.fromCharCode(bytes[i]);
      return btoa(bin);
    }

    // æäº¤
    async function submitForm() {
      const summary = $('#summary').value.trim();
      if (!summary) {
        alert('è«‹è¼¸å…¥ç½æƒ…æ‘˜è¦');
        return;
      }

      // è‹¥éŸ³æª”ç‚ºç©ºï¼Œè¦–åŒæ²’æœ‰
      if (audioBlob && audioBlob.size === 0) {
        console.warn('éŸ³æª”å¤§å°ç‚º 0ï¼Œå°‡ä¸é™„åŠ éŸ³æª”');
        audioBlob = null;
      }

      let audioBase64 = null;
      let contentType = null;
      let fileName = 'recording';

      if (audioBlob) {
        try {
          audioBase64 = await blobToBase64(audioBlob);
          contentType = audioBlob.type || 'audio/webm';
        } catch (e) {
          console.error('è½‰ Base64 å¤±æ•—ï¼š', e);
          audioBase64 = null;
        }
      }

      const payload = { summary, audioBase64, contentType, fileName };

      setBusy(true);
      try {
        const resp = await fetch(WEB_APP_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        if (!resp.ok) {
          const t = await resp.text().catch(() => '');
          console.error('HTTP é 2xxï¼š', resp.status, t);
          alert(`æäº¤å¤±æ•—ï¼ˆHTTP ${resp.status}ï¼‰ã€‚è«‹æª¢æŸ¥éƒ¨ç½²æ¬Šé™èˆ‡ URL æ˜¯å¦æ­£ç¢ºã€‚`);
          setBusy(false);
          return;
        }

        let result;
        try {
          result = await resp.json();
        } catch {
          const t = await resp.text();
          console.warn('å›æ‡‰é JSONï¼ŒåŸæ–‡ï¼š', t);
          alert('ä¼ºæœå™¨å›æ‡‰é JSONï¼Œè«‹æŸ¥çœ‹ Apps Script æ—¥èªŒã€‚');
          setBusy(false);
          return;
        }

        console.log('æäº¤å›å‚³:', result);

        const extras =
          (result.textFileUrl ? `\næ–‡å­—æª”ï¼š${result.textFileUrl}` : '') +
          (result.audioFileUrl ? `\néŸ³æª”ï¼š${result.audioFileUrl}` : '');

        alert((result.message || 'å®Œæˆ') + extras);

        // è‹¥ä½ ç¢ºèªä¸€åˆ‡æ­£å¸¸ï¼Œå†é–‹å•Ÿé€™è¡Œè®“è¦–çª—è‡ªå‹•é—œé–‰
        // liff.closeWindow();

      } catch (err) {
        console.error('æäº¤éŒ¯èª¤ï¼š', err);
        alert('æäº¤å¤±æ•—ï¼šç„¡æ³•é€£ç·šåˆ°ä¼ºæœå™¨ã€‚è«‹ç¢ºèª /exec URL æ˜¯å¦ç‚ºæœ€æ–°ã€éƒ¨ç½²ç‚ºã€Œä»»ä½•äººå¯å­˜å–ã€ã€‚');
      } finally {
        setBusy(false);
      }
    }

    // æš´éœ²çµ¦ HTML æŒ‰éˆ•
    window.startRecording = startRecording;
    window.stopRecording = stopRecording;
    window.submitForm = submitForm;
  </script>
</body>
</html>
