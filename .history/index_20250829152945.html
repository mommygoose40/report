<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>災情回報</title>
  <script src="https://static.line-scdn.net/liff/edge/versions/2.22.3/sdk.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; text-align: center; max-width: 400px; margin: 0 auto; }
    button { padding: 12px 20px; margin: 10px 5px; background-color: #06c755; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; }
    #stopRecordBtn { background-color: #ff4b4b; }
    input { padding: 12px; margin: 15px 0; width: 90%; border: 1px solid #ccc; border-radius: 8px; font-size: 16px; }
    #recordingStatus { margin: 15px 0; color: #666; font-style: italic; }
    #audioPlayback { margin: 15px 0; width: 100%; }
    #serverStatus { font-size: 12px; color: #888; margin-top: 8px; }
  </style>
</head>
<body>
  <h1>災情回報</h1>

  <!-- 錄音區塊 -->
  <button id="recordBtn" onclick="startRecording()">🎤 開始錄音</button>
  <button id="stopRecordBtn" onclick="stopRecording()" disabled>⏹️ 停止錄音</button>

  <p id="recordingStatus">準備錄音...</p>
  <audio id="audioPlayback" controls style="display:none;"></audio>

  <!-- 文字摘要 -->
  <input type="text" id="summary" placeholder="請輸入災情摘要（20字內）" maxlength="20" />
  <br/>

  <!-- 提交 -->
  <button id="submitBtn" onclick="submitForm()">📤 提交回報</button>
  <div id="serverStatus">伺服器狀態：檢查中...</div>

  <script>
    // ======== 換成你「最新」Web App URL（/exec） ========
    const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbyTTNTKmHDIdBI7fB1gS9AQBpwSxTcYCRip4KBH-qhmB14n4xNTQyZsuhxXoEu5Ope-lg/exec';
    // ====================================================

    // 錄音變數
    let mediaRecorder = null;
    let audioChunks = [];
    let audioBlob = null;

    // 小工具
    const $ = (sel) => document.querySelector(sel);
    const setBusy = (busy) => {
      const btn = $('#submitBtn');
      btn.disabled = busy;
      btn.textContent = busy ? '⏳ 送出中…' : '📤 提交回報';
    };

    // 初始化 LIFF & 檢查伺服器
    liff.init({ liffId: '2007934728-xN6aOL3D' })
      .then(async () => {
        console.log('LIFF 初始化成功');
        if (!liff.isLoggedIn()) liff.login();

        // PING /exec（需後端有 doGet）
        try {
          const r = await fetch(WEB_APP_URL, { method: 'GET', cache: 'no-store' });
          const t = await r.text();
          console.log('PING /exec:', t);
          $('#serverStatus').textContent = '伺服器狀態：已連線';
          $('#serverStatus').style.color = '#06c755';
        } catch (e) {
          console.error('PING 失敗：', e);
          $('#serverStatus').textContent = '伺服器狀態：無法連線（請檢查部署/權限/URL）';
          $('#serverStatus').style.color = '#ff4b4b';
        }
      })
      .catch(err => {
        console.error('LIFF 初始化失敗:', err);
        alert('初始化失敗，請重新開啟');
      });

    // 開始錄音
    async function startRecording() {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({
          audio: { echoCancellation: true, noiseSuppression: true }
        });

        // 不強制指定 mimeType，讓裝置自行決定以增加相容性
        mediaRecorder = new MediaRecorder(stream);
        audioChunks = [];

        mediaRecorder.ondataavailable = (evt) => {
          if (evt.data && evt.data.size > 0) audioChunks.push(evt.data);
        };

        mediaRecorder.onstop = () => {
          audioBlob = new Blob(audioChunks, { type: audioChunks[0]?.type || 'audio/webm' });
          console.log('audioBlob type:', audioBlob.type, 'size:', audioBlob.size);

          const audioUrl = URL.createObjectURL(audioBlob);
          const audioPlayback = $('#audioPlayback');
          audioPlayback.src = audioUrl;
          audioPlayback.style.display = 'block';

          $('#recordingStatus').textContent = '錄音完成！您可以播放預覽。';
          $('#recordingStatus').style.color = 'green';

          stream.getTracks().forEach(t => t.stop());
        };

        mediaRecorder.start();

        $('#recordingStatus').textContent = '錄音中...';
        $('#recordingStatus').style.color = 'red';
        $('#recordBtn').disabled = true;
        $('#stopRecordBtn').disabled = false;

      } catch (err) {
        console.error('錄音失敗:', err);
        alert('無法存取麥克風，請確認權限設定');
      }
    }

    // 停止錄音
    function stopRecording() {
      if (mediaRecorder && mediaRecorder.state === 'recording') {
        mediaRecorder.stop();
        $('#recordBtn').disabled = false;
        $('#stopRecordBtn').disabled = true;
      }
    }

    // Blob -> Base64
    async function blobToBase64(blob) {
      const buf = await blob.arrayBuffer();
      const bytes = new Uint8Array(buf);
      let bin = '';
      for (let i = 0; i < bytes.byteLength; i++) bin += String.fromCharCode(bytes[i]);
      return btoa(bin);
    }

    // 提交
    async function submitForm() {
      const summary = $('#summary').value.trim();
      if (!summary) {
        alert('請輸入災情摘要');
        return;
      }

      // 若音檔為空，視同沒有
      if (audioBlob && audioBlob.size === 0) {
        console.warn('音檔大小為 0，將不附加音檔');
        audioBlob = null;
      }

      let audioBase64 = null;
      let contentType = null;
      let fileName = 'recording';

      if (audioBlob) {
        try {
          audioBase64 = await blobToBase64(audioBlob);
          contentType = audioBlob.type || 'audio/webm';
        } catch (e) {
          console.error('轉 Base64 失敗：', e);
          audioBase64 = null;
        }
      }

      const payload = { summary, audioBase64, contentType, fileName };

      setBusy(true);
      try {
        const resp = await fetch(WEB_APP_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        if (!resp.ok) {
          const t = await resp.text().catch(() => '');
          console.error('HTTP 非 2xx：', resp.status, t);
          alert(`提交失敗（HTTP ${resp.status}）。請檢查部署權限與 URL 是否正確。`);
          setBusy(false);
          return;
        }

        let result;
        try {
          result = await resp.json();
        } catch {
          const t = await resp.text();
          console.warn('回應非 JSON，原文：', t);
          alert('伺服器回應非 JSON，請查看 Apps Script 日誌。');
          setBusy(false);
          return;
        }

        console.log('提交回傳:', result);

        const extras =
          (result.textFileUrl ? `\n文字檔：${result.textFileUrl}` : '') +
          (result.audioFileUrl ? `\n音檔：${result.audioFileUrl}` : '');

        alert((result.message || '完成') + extras);

        // 若你確認一切正常，再開啟這行讓視窗自動關閉
        // liff.closeWindow();

      } catch (err) {
        console.error('提交錯誤：', err);
        alert('提交失敗：無法連線到伺服器。請確認 /exec URL 是否為最新、部署為「任何人可存取」。');
      } finally {
        setBusy(false);
      }
    }

    // 暴露給 HTML 按鈕
    window.startRecording = startRecording;
    window.stopRecording = stopRecording;
    window.submitForm = submitForm;
  </script>
</body>
</html>
