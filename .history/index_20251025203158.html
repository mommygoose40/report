<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>災情回報系統</title>
<script src="https://static.line-scdn.net/liff/edge/versions/2.22.3/sdk.js"></script>
<!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-analytics.js";
    import { getStorage, ref, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-storage.js";

    // Firebase 設定
    const firebaseConfig = {
      apiKey: "AIzaSyA4IZ6yZxlOuIjarWmUtIHGyLk84056K2Q",
      authDomain: "reportsystem-c5fc7.firebaseapp.com",
      projectId: "reportsystem-c5fc7",
      storageBucket: "reportsystem-c5fc7.firebasestorage.app",
      messagingSenderId: "845064058181",
      appId: "1:845064058181:web:31d2f0fa6dfed084befa2c",
      measurementId: "G-EDQM0LWQWH"
    };

    // 初始化 Firebase
    const app = initializeApp(firebaseConfig);
    const analytics = getAnalytics(app);
    const storage = getStorage(app);

    // 將 Firebase 功能暴露給全局使用
    window.firebaseStorage = { getStorage, ref, uploadBytesResumable, getDownloadURL, storage };
  </script>
<style>
/* === 通用設定 === */
body {
  font-family: Arial, sans-serif;
  background-color: #f5f8ff;
  color: #000;
  margin: 0;
  padding: 0;
}
.container {
  max-width: 800px;
  margin: 0 auto;
  padding: 20px;
}
.header {
  text-align: center;
  color: #000;
  border-bottom: 2px solid #0b5ed7;
  padding-bottom: 10px;
  margin-bottom: 20px;
}
.step-title {
  font-weight: 700;
  font-size: 22px;
  color: #000;
  margin-bottom: 14px;
}
.form-section {
  background: white;
  border-radius: 8px;
  border: 2px solid #d0d7e2;
  padding: 20px;
  margin-bottom: 20px;
}

/* 移除預設觸控高亮 */
button, .nav-btn, .add-photo, #closeModalBtn {
  -webkit-tap-highlight-color: transparent;
  user-select: none;
}

/* === 通用按鈕 === */
button {
  padding: 10px 18px;
  margin: 6px 4px;
  background: #0b5ed7;
  color: #fff;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  font-size: 15px;
  transition: filter 0.1s ease, background 0.1s ease;
}
button:hover { background: #144b9c; }
button:active { background: #26344d; }
button.temp-active { filter: brightness(0.7); }

/* 紅色刪除類 */
.delete-btn-modal,
.thumb .delete-btn {
  background: #dc3545 !important;
  color: #fff !important;
  border: none;
  cursor: pointer;
  transition: filter 0.1s ease, background 0.1s ease;
}
.delete-btn-modal:hover,
.thumb .delete-btn:hover {
  background: #b52b38 !important;
}
.delete-btn-modal:active,
.thumb .delete-btn:active {
  background: #7b1f29 !important;
}
.delete-btn-modal.temp-active,
.thumb .delete-btn.temp-active {
  filter: brightness(0.7);
}

/* === 縮圖 === */
.thumbs {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
  margin-top: 10px;
  align-items: flex-start;
}
.thumb {
  position: relative;
  width: 90px;
  height: 90px;
  flex: 0 0 auto;
  border-radius: 6px;
  overflow: hidden;
  border: 1px solid #ccc;
  background: #f9f9f9;
}
.thumb img {
  width: 100%;
  height: 100%;
  object-fit: cover;
  display: block;
  opacity: 0;
  transition: opacity 0.3s ease;
}
.thumb img.loaded { opacity: 1; }
.thumb .delete-btn {
  position: absolute;
  top: 4px;
  right: 4px;
  background: rgba(220, 53, 69, 0.9);
  color: #fff;
  border: none;
  border-radius: 50%;
  font-size: 16px;
  width: 24px;
  height: 24px;
  line-height: 20px;
  text-align: center;
  cursor: pointer;
  padding: 0;
}

/* 加號按鈕 */
.add-photo {
  width: 90px;
  height: 90px;
  flex: 0 0 auto;
  border: 2px dashed #9bb4e9;
  border-radius: 6px;
  display: flex;
  align-items: center;
  justify-content: center;
  color: #0b5ed7;
  font-size: 36px;
  cursor: pointer;
  background: #f0f4ff;
  transition: filter 0.1s ease, background 0.1s ease;
}
.add-photo:hover { background: #d9e5ff; }
.add-photo:active { background: #c0d2ff; }
.add-photo.temp-active { filter: brightness(0.7); }

/* 預覽照片按鈕 */
.preview-all-btn {
  background: #60748f !important;
  color: #fff !important;
  margin-top: 12px;
  transition: filter 0.1s ease, background 0.1s ease;
}
.preview-all-btn:hover { background: #4e607a !important; }
.preview-all-btn:active { background: #384a60 !important; }
.preview-all-btn.temp-active { filter: brightness(0.7); }

/* === Modal === */
.modal {
  display: none;
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: rgba(0,0,0,0.7);
  justify-content: center;
  align-items: center;
  z-index: 2000;
}
.modal-content {
  background: #fff;
  border-radius: 8px;
  padding: 20px;
  width: 90%;
  max-width: 500px;
  max-height: 85vh;
  position: relative;
  overflow: hidden;
  text-align: center;
}
.header-line {
  display: flex;
  align-items: center;
  justify-content: center;
  position: relative;
  width: 100%;
  margin-bottom: 10px;
}
#modalTitle {
  font-size: 22px;
  font-weight: bold;
  color: #000;
  flex: 1;
  text-align: center;
}
#closeModalBtn {
  position: absolute;
  right: 10px;
  top: 50%;
  transform: translateY(-50%);
  font-size: 40px;
  background: none;
  border: none;
  color: #000;
  cursor: pointer;
  transition: filter 0.1s ease, color 0.1s ease;
}
#closeModalBtn:hover { color: #444; }
#closeModalBtn:active { color: #888; }
#closeModalBtn.temp-active { filter: brightness(0.7); }

.preview-image-container {
  position: relative;
  display: flex;
  justify-content: center;
  align-items: center;
  margin: 15px 0;
  min-height: 300px;
}
.preview-image {
  max-width: 100%;
  max-height: 60vh;
  border-radius: 6px;
  opacity: 0;
  transition: opacity 0.3s ease;
}
.preview-image.loaded { opacity: 1; }

.nav-btn {
  position: absolute;
  top: 50%;
  transform: translateY(-50%);
  background: rgba(0,0,0,0.45);
  border: none;
  color: #fff;
  font-size: 28px;
  padding: 10px 16px;
  cursor: pointer;
  border-radius: 8px;
  transition: filter 0.1s ease, background 0.1s ease;
}
.nav-btn:hover { background: rgba(0,0,0,0.6); }
.nav-btn:active { background: rgba(0,0,0,0.35); }
.nav-btn.temp-active { filter: brightness(0.7); }
.nav-btn.disabled { opacity: 0.35; pointer-events: none; }
.nav-left { left: 10px; }
.nav-right { right: 10px; }

body.modal-open { overflow: hidden; }
</style>

<script>
window.addEventListener("DOMContentLoaded", () => {
  function addTempFeedback(el, callback) {
    el.classList.add("temp-active");
    setTimeout(() => {
      el.classList.remove("temp-active");
      if (callback) callback();
    }, 120);
  }

  function delayed(action) {
    requestAnimationFrame(() => setTimeout(action, 80));
  }

  const photos = [];
  const thumbs = document.getElementById("thumbs");
  const imgModal = document.getElementById("imgModal");
  const fileCamera = document.getElementById("fileCamera");
  const fileGallery = document.getElementById("fileGallery");

  let previewMode = "";
  let previewFiles = [];
  let previewIndex = 0;

  function openCamera() {
    const btn = event.currentTarget;
    addTempFeedback(btn, () => fileCamera.click());
  }

  function openGallery() {
    const btn = event.currentTarget;
    addTempFeedback(btn, () => fileGallery.click());
  }

  fileCamera.addEventListener("change", () => {
    if (fileCamera.files[0]) confirmUpload([fileCamera.files[0]]);
  });
  fileGallery.addEventListener("change", () => {
    if (fileGallery.files.length) confirmUpload([...fileGallery.files]);
    fileGallery.value = "";
  });

  function renderThumbs() {
    thumbs.innerHTML = "";
    photos.forEach((p, i) => {
      const div = document.createElement("div");
      div.className = "thumb";
      const img = document.createElement("img");
      img.onload = () => img.classList.add("loaded");
      img.src = p.url;
      const del = document.createElement("button");
      del.className = "delete-btn";
      del.textContent = "×";
      del.onclick = (e) =>
        addTempFeedback(e.currentTarget, () => removePhoto(i));
      div.append(img, del);
      thumbs.appendChild(div);
    });

    const addBtn = document.createElement("div");
    addBtn.className = "add-photo";
    addBtn.innerHTML = "+";
    addBtn.onclick = (e) => addTempFeedback(e.currentTarget, openGallery);
    thumbs.appendChild(addBtn);

    if (photos.length > 0) {
      const row = document.createElement("div");
      row.style.textAlign = "center";
      row.style.width = "100%";
      const previewBtn = document.createElement("button");
      previewBtn.className = "preview-all-btn";
      previewBtn.textContent = "預覽照片";
      previewBtn.onclick = (e) =>
        addTempFeedback(e.currentTarget, () => showImage(0));
      row.appendChild(previewBtn);
      thumbs.appendChild(row);
    }
  }

  function removePhoto(index) {
    if (!confirm("確認要刪除這張照片？")) return;
    URL.revokeObjectURL(photos[index].url);
    photos.splice(index, 1);
    renderThumbs();
  }

  function confirmUpload(files) {
    if (!files || files.length === 0) return;
    previewMode = "confirm";
    previewFiles = files.map((f) => ({
      file: f,
      url: URL.createObjectURL(f),
    }));
    previewIndex = 0;
    setupPreviewModal();
    showPreviewModal();
  }

  function showImage(index = 0) {
    if (photos.length === 0) return;
    previewMode = "preview";
    previewFiles = photos.map((p) => ({ file: p.file, url: p.url }));
    previewIndex = index;
    setupPreviewModal();
    showPreviewModal();
  }

  function setupPreviewModal() {
    const closeBtn = document.getElementById("closeModalBtn");
    const leftBtn = document.getElementById("navLeft");
    const rightBtn = document.getElementById("navRight");
    const confirmBtn = document.getElementById("confirmBtn");
    const deleteBtn = document.getElementById("deleteCurrentBtn");

    closeBtn.onclick = (e) =>
      addTempFeedback(e.currentTarget, closePreviewModal);
    leftBtn.onclick = (e) =>
      addTempFeedback(e.currentTarget, () => changePreview(-1));
    rightBtn.onclick = (e) =>
      addTempFeedback(e.currentTarget, () => changePreview(1));
    confirmBtn.onclick = (e) =>
      addTempFeedback(e.currentTarget, handleConfirm);
    deleteBtn.onclick = (e) =>
      addTempFeedback(e.currentTarget, deletePreviewPhoto);
    document.body.style.overflow = "hidden";
  }

  function showPreviewModal() {
    updatePreviewImage();
    imgModal.style.display = "flex";
  }

  function closePreviewModal() {
    imgModal.style.display = "none";
    previewFiles = [];
    previewIndex = 0;
    document.body.style.overflow = "auto";
  }

  function updatePreviewImage() {
    const img = document.getElementById("previewImage");
    const title = document.getElementById("modalTitle");
    const leftBtn = document.getElementById("navLeft");
    const rightBtn = document.getElementById("navRight");
    if (previewFiles.length === 0) return;

    const total = previewFiles.length;
    const current = previewIndex + 1;
    title.textContent =
      previewMode === "confirm"
        ? `請確認照片 (${current}/${total})`
        : `預覽照片 (${current}/${total})`;

    const newSrc = previewFiles[previewIndex].url;
    if (img.dataset.currentSrc !== newSrc) {
      img.dataset.currentSrc = newSrc;
      img.classList.remove("loaded");
      const temp = new Image();
      temp.onload = () => {
        img.src = newSrc;
        requestAnimationFrame(() => img.classList.add("loaded"));
      };
      temp.src = newSrc;
    }

    const confirmBtn = document.getElementById("confirmBtn");
    confirmBtn.style.display =
      previewMode === "confirm" ? "inline-block" : "none";

    leftBtn.classList.toggle("disabled", previewIndex === 0);
    rightBtn.classList.toggle("disabled", previewIndex === total - 1);
  }

  function changePreview(dir) {
    const next = previewIndex + dir;
    if (next < 0 || next >= previewFiles.length) return;
    previewIndex = next;
    updatePreviewImage();
  }

  function handleConfirm() {
    if (previewMode === "confirm") {
      previewFiles.forEach((p) => {
        if (!photos.find((x) => x.url === p.url)) {
          photos.push({ file: p.file, url: p.url });
        }
      });
      renderThumbs();
    }
    closePreviewModal();
  }

  function deletePreviewPhoto() {
    if (!confirm("確認要刪除這張照片？")) return;
    const removed = previewFiles.splice(previewIndex, 1)[0];
    if (removed.url && removed.url.startsWith("blob:"))
      URL.revokeObjectURL(removed.url);
    if (previewMode === "preview") {
      const idx = photos.findIndex((x) => x.url === removed.url);
      if (idx >= 0) photos.splice(idx, 1);
      renderThumbs();
    }
    if (previewFiles.length === 0) closePreviewModal();
    else {
      if (previewIndex >= previewFiles.length)
        previewIndex = previewFiles.length - 1;
      updatePreviewImage();
    }
  }
});

/* === 錄音 === */
let mediaRecorder=null,audioChunks=[],audioBlob=null;
async function startRecording(){
  try{
    const stream=await navigator.mediaDevices.getUserMedia({audio:true});
    mediaRecorder=new MediaRecorder(stream);
    audioChunks=[];
    mediaRecorder.ondataavailable=e=>{if(e.data.size>0)audioChunks.push(e.data);};
    mediaRecorder.onstop=()=>{
      stream.getTracks().forEach(t=>t.stop());
      audioBlob=new Blob(audioChunks,{type:'audio/webm'});
      showPlaybackModal();
    };
    recordModal.innerHTML=`
      <div class="modal-content">
        <div class="red-text">錄音中</div>
        <button onclick="stopRecording()">停止錄音</button>
      </div>`;
    recordModal.style.display='flex';
    mediaRecorder.start();
  }catch(e){alert('無法使用麥克風');}
}
function stopRecording(){
  if(mediaRecorder&&mediaRecorder.state==='recording')mediaRecorder.stop();
}
function showPlaybackModal(){
  const url=URL.createObjectURL(audioBlob);
  recordModal.innerHTML=`
    <div class="modal-content">
      <div style="margin-bottom:10px;">請確認是否使用這段錄音</div>
      <audio controls src="${url}" style="width:100%;max-width:400px;"></audio>
      <div style="margin-top:15px;display:flex;justify-content:center;gap:20px;">
        <button style="background:#007bff;" onclick="redoAudio()">重錄</button>
        <button style="background:#0b5ed7;" onclick="confirmAudio()">確定</button>
      </div>
    </div>`;
}
function confirmAudio(){
  recordModal.style.display='none';
  document.getElementById('audioPlayback').src=URL.createObjectURL(audioBlob);
  document.getElementById('audioPlayback').style.display='block';
}
function redoAudio(){
  recordModal.style.display='none';
  audioBlob=null;
  startRecording();
}

/* === 災情選擇 === */
function toggleDisasterTypes(){
  const abnormal=document.querySelector('input[name="disaster"]:checked').value==='異常';
  document.getElementById('disasterTypes').style.display=abnormal?'block':'none';
}

/* === Firebase 上傳 === */
async function compressImage(file){
  return new Promise(res=>{
    const img=new Image();
    img.onload=()=>{
      const c=document.createElement('canvas');
      const scale=Math.min(1,1280/img.width);
      c.width=img.width*scale;c.height=img.height*scale;
      c.getContext('2d').drawImage(img,0,0,c.width,c.height);
      c.toBlob(b=>res(new File([b],'photo.jpg',{type:'image/jpeg'})),'image/jpeg',0.7);
    };
    img.src=URL.createObjectURL(file);
  });
}

async function uploadToFirebase(file,path){
  const {ref,uploadBytesResumable,getDownloadURL}=window.firebaseStorage;
  const storageRef=ref(window.firebaseStorage.storage,path);
  const task=uploadBytesResumable(storageRef,file);
  return new Promise((res,rej)=>{
    task.on('state_changed',snap=>{
      const p=(snap.bytesTransferred/snap.totalBytes)*100;
      document.getElementById('uploadProgress').style.display='block';
      document.getElementById('uploadProgress').value=p;
      document.getElementById('uploadStatus').textContent=`上傳中 ${Math.round(p)}%`;
    },rej,async()=>res(await getDownloadURL(task.snapshot.ref)));
  });
}

async function transcribeAudio(blob,reportId){
  const buf=await blob.arrayBuffer();
  const arr=new Uint8Array(buf);
  let s='';for(let i=0;i<arr.length;i++)s+=String.fromCharCode(arr[i]);
  const b64=btoa(s);
  const fd=new FormData();
  fd.append('action','transcribe');
  fd.append('audioData',b64);
  fd.append('reportId',reportId);
  const r=await fetch(WEB_APP_URL,{method:'POST',body:fd});
  const t=await r.text();try{const j=JSON.parse(t);return j.transcription||'';}catch{return'';}
}

/* === 提交表單 === */
async function submitForm(){
  const summary=document.getElementById('summary').value.trim();
  const abnormal=document.querySelector('input[name="disaster"]:checked').value==='異常';
  const types=Array.from(document.querySelectorAll('input[name="disasterType"]:checked')).map(e=>e.value).join(',');
  document.getElementById('submitBtn').disabled=true;
  const ts=Date.now(),rid=`report_${ts}`,photoUrls=[];
  try{
    for(let i=0;i<photos.length;i++){
      const comp=await compressImage(photos[i].file);
      const url=await uploadToFirebase(comp,`reports/${rid}/photo_${i}.jpg`);
      photoUrls.push(url);
    }
    let audioUrl='',txt='';
    if(audioBlob){
      audioUrl=await uploadToFirebase(audioBlob,`reports/${rid}/recording.webm`);
      if(abnormal)txt=await transcribeAudio(audioBlob,rid);
    }
    const fd=new FormData();
    fd.append('summary',summary);
    fd.append('disasterType',types);
    fd.append('photoUrl',photoUrls.join(','));
    if(audioUrl)fd.append('audioUrl',audioUrl);
    fd.append('timestamp',ts.toString());
    fd.append('reportId',rid);
    const res=await fetch(WEB_APP_URL,{method:'POST',body:fd});
    const rj=await res.json();
    if(rj.result==='success'){alert('回報提交成功');location.reload();}
    else alert('提交失敗');
  }catch(e){alert('錯誤: '+e.message);}
  document.getElementById('submitBtn').disabled=false;
}
</script>
</body>
</html>