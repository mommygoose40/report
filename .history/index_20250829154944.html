<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ç½æƒ…å›å ±</title>
  <script src="https://static.line-scdn.net/liff/edge/versions/2.22.3/sdk.js"></script>
  <style>
    body{font-family:Arial,sans-serif;padding:20px;text-align:center;max-width:400px;margin:0 auto;}
    button{padding:12px 20px;margin:10px 5px;background:#06c755;color:#fff;border:none;border-radius:8px;cursor:pointer;font-size:16px;}
    #stopRecordBtn{background:#ff4b4b;}
    input{padding:12px;margin:15px 0;width:90%;border:1px solid #ccc;border-radius:8px;font-size:16px;}
    #recordingStatus{margin:15px 0;color:#666;font-style:italic;}
    #audioPlayback{margin:15px 0;width:100%;}
    #serverStatus{font-size:12px;color:#888;margin-top:8px;}
  </style>
</head>
<body>
  <h1>ç½æƒ…å›å ±</h1>

  <button id="recordBtn" onclick="startRecording()">ğŸ¤ é–‹å§‹éŒ„éŸ³</button>
  <button id="stopRecordBtn" onclick="stopRecording()" disabled>â¹ï¸ åœæ­¢éŒ„éŸ³</button>
  <p id="recordingStatus">æº–å‚™éŒ„éŸ³...</p>
  <audio id="audioPlayback" controls style="display:none;"></audio>

  <input type="text" id="summary" placeholder="è«‹è¼¸å…¥ç½æƒ…æ‘˜è¦ï¼ˆ20å­—å…§ï¼‰" maxlength="20"/>
  <br/>
  <button id="submitBtn" onclick="submitForm()">ğŸ“¤ æäº¤å›å ±</button>
  <div id="serverStatus">ä¼ºæœå™¨ç‹€æ…‹ï¼šæª¢æŸ¥ä¸­...</div>

  <script>
    // æ›æˆä½ çš„æœ€æ–° /exec URL
    const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbx4Jum9X1xtDnAysCo3WI6En9hzm25aYomXZWCaWrdn2Veynl0mzA_6jiMuKWsDg5sB7w/exec';

    let mediaRecorder=null, audioChunks=[], audioBlob=null;

    const $ = s => document.querySelector(s);
    const setBusy = b => { const btn=$('#submitBtn'); btn.disabled=b; btn.textContent=b?'â³ é€å‡ºä¸­â€¦':'ğŸ“¤ æäº¤å›å ±'; };

    liff.init({ liffId:'2007934728-xN6aOL3D' }).then(async ()=>{
      if(!liff.isLoggedIn()) liff.login();
      // å¥åº·æª¢æŸ¥ï¼ˆéœ€è¦å¾Œç«¯æœ‰ doGetï¼‰
      try{
        const r = await fetch(WEB_APP_URL, { method:'GET', cache:'no-store' });
        const t = await r.text();
        console.log('PING /exec:', t);
        $('#serverStatus').textContent='ä¼ºæœå™¨ç‹€æ…‹ï¼šå·²é€£ç·š';
        $('#serverStatus').style.color='#06c755';
      }catch(e){
        console.error('PING å¤±æ•—ï¼š', e);
        $('#serverStatus').textContent='ä¼ºæœå™¨ç‹€æ…‹ï¼šç„¡æ³•é€£ç·šï¼ˆè«‹æª¢æŸ¥éƒ¨ç½²/æ¬Šé™/URLï¼‰';
        $('#serverStatus').style.color='#ff4b4b';
      }
    }).catch(err=>{
      console.error('LIFF åˆå§‹åŒ–å¤±æ•—:', err);
      alert('åˆå§‹åŒ–å¤±æ•—ï¼Œè«‹é‡æ–°é–‹å•Ÿ');
    });

    async function startRecording(){
      try{
        const stream = await navigator.mediaDevices.getUserMedia({ audio:{ echoCancellation:true, noiseSuppression:true } });
        mediaRecorder = new MediaRecorder(stream); // ä¸å¼·åˆ¶ mimeTypeï¼Œæå‡ç›¸å®¹æ€§
        audioChunks = [];
        mediaRecorder.ondataavailable = e => { if(e.data && e.data.size>0) audioChunks.push(e.data); };
        mediaRecorder.onstop = ()=>{
          audioBlob = new Blob(audioChunks, { type: audioChunks[0]?.type || 'audio/webm' });
          console.log('audioBlob type:', audioBlob.type, 'size:', audioBlob.size);
          const url = URL.createObjectURL(audioBlob);
          const p = $('#audioPlayback'); p.src=url; p.style.display='block';
          $('#recordingStatus').textContent='éŒ„éŸ³å®Œæˆï¼æ‚¨å¯ä»¥æ’­æ”¾é è¦½ã€‚'; $('#recordingStatus').style.color='green';
          stream.getTracks().forEach(t=>t.stop());
        };
        mediaRecorder.start();
        $('#recordingStatus').textContent='éŒ„éŸ³ä¸­...'; $('#recordingStatus').style.color='red';
        $('#recordBtn').disabled=true; $('#stopRecordBtn').disabled=false;
      }catch(err){
        console.error('éŒ„éŸ³å¤±æ•—:', err);
        alert('ç„¡æ³•å­˜å–éº¥å…‹é¢¨ï¼Œè«‹ç¢ºèªæ¬Šé™è¨­å®š');
      }
    }
    function stopRecording(){
      if(mediaRecorder && mediaRecorder.state==='recording'){
        mediaRecorder.stop();
        $('#recordBtn').disabled=false; $('#stopRecordBtn').disabled=true;
      }
    }

    async function submitForm(){
      const summary = $('#summary').value.trim();
      if(!summary){ alert('è«‹è¼¸å…¥ç½æƒ…æ‘˜è¦'); return; }

      if(audioBlob && audioBlob.size===0){ console.warn('éŸ³æª”ç‚º 0ï¼Œç•¥é'); audioBlob=null; }

      const formData = new FormData();
      formData.append('summary', summary);
      if(audioBlob){ formData.append('audio', audioBlob, 'recording'); } // ä¸è¦è‡ªè¡Œè¨­å®š Content-Type

      setBusy(true);
      try{
        const resp = await fetch(WEB_APP_URL, { method:'POST', body: formData });
        if(!resp.ok){
          const t = await resp.text().catch(()=> '');
          console.error('HTTP é 2xxï¼š', resp.status, t);
          alert(`æäº¤å¤±æ•—ï¼ˆHTTP ${resp.status}ï¼‰ã€‚`);
          setBusy(false); return;
        }
        let result;
        try { result = await resp.json(); }
        catch { const t = await resp.text(); console.warn('å›æ‡‰é JSONï¼š', t); alert('ä¼ºæœå™¨å›æ‡‰é JSONï¼Œè«‹çœ‹æ—¥èªŒ'); setBusy(false); return; }

        console.log('æäº¤å›å‚³:', result);
        const extras =
          (result.textFileUrl ? `\næ–‡å­—æª”ï¼š${result.textFileUrl}` : '') +
          (result.audioFileUrl ? `\néŸ³æª”ï¼š${result.audioFileUrl}` : '');
        alert((result.message || 'å®Œæˆ') + extras);
        // liff.closeWindow(); // ç­‰ä½ ç¢ºèªç©©å®šå†æ‰“é–‹
      }catch(err){
        console.error('æäº¤éŒ¯èª¤ï¼š', err);
        alert('æäº¤å¤±æ•—ï¼šç„¡æ³•é€£ç·šåˆ°ä¼ºæœå™¨ï¼ˆè«‹ç¢ºèª /exec URL èˆ‡éƒ¨ç½²æ¬Šé™ï¼‰ã€‚');
      }finally{
        setBusy(false);
      }
    }

    // æš´éœ²çµ¦ HTML æŒ‰éˆ•
    window.startRecording=startRecording;
    window.stopRecording=stopRecording;
    window.submitForm=submitForm;
  </script>
</body>
</html>
