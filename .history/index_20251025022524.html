<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>災情回報系統</title>
<script src="https://static.line-scdn.net/liff/edge/versions/2.22.3/sdk.js"></script>

<!-- Firebase SDK -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-analytics.js";
import { getStorage, ref, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-storage.js";

const firebaseConfig = {
  apiKey: "AIzaSyA4IZ6yZxlOuIjarWmUtIHGyLk84056K2Q",
  authDomain: "reportsystem-c5fc7.firebaseapp.com",
  projectId: "reportsystem-c5fc7",
  storageBucket: "reportsystem-c5fc7.firebasestorage.app",
  messagingSenderId: "845064058181",
  appId: "1:845064058181:web:31d2f0fa6dfed084befa2c",
  measurementId: "G-EDQM0LWQWH"
};

const app = initializeApp(firebaseConfig);
const analytics = getAnalytics(app);
const storage = getStorage(app);
window.firebaseStorage = { getStorage, ref, uploadBytesResumable, getDownloadURL, storage };
</script>

<style>
body {
  font-family: Arial, sans-serif;
  background-color: #f5f8ff;
  margin: 0;
  padding: 0;
}
.container {
  max-width: 800px;
  margin: 0 auto;
  padding: 20px;
}
.header {
  text-align: center;
  color: #0b5ed7;
  border-bottom: 2px solid #0b5ed7;
  padding-bottom: 10px;
  margin-bottom: 20px;
}
.step-title {
  font-weight: 700;
  font-size: 20px;
  color: #0b5ed7;
  margin-bottom: 14px;
}
.form-section {
  background: white;
  border-radius: 8px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  padding: 20px;
  margin-bottom: 20px;
}
button {
  padding: 10px 18px;
  margin: 6px 4px;
  background: #0b5ed7;
  color: #fff;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  font-size: 15px;
}
#stopRecordBtn { background: #6c757d; }
input[type="text"] {
  padding: 12px;
  width: 95%;
  border: 2px solid #ccc;
  border-radius: 6px;
  font-size: 15px;
  transition: all 0.2s ease;
}
input[type="text"]:focus {
  border-color: #0b5ed7;
  box-shadow: 0 0 5px rgba(11,94,215,0.4);
  outline: none;
}
.form-section label {
  font-size: 17px;
}
.thumbs {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  margin-top: 10px;
}
.thumb {
  position: relative;
  width: 90px;
  height: 90px;
  border-radius: 6px;
  overflow: hidden;
  border: 1px solid #ccc;
}
.thumb img {
  width: 100%;
  height: 100%;
  object-fit: contain;
  background: #f8f8f8;
}
.thumb button {
  position: absolute;
  top: 2px;
  right: 2px;
  background: rgba(0,0,0,.65);
  color: white;
  border: none;
  border-radius: 50%;
  font-size: 16px;
  padding: 2px 6px;
}
audio {
  width: 100%;
  max-width: 300px;
  margin-top: 15px;
}
progress {
  width: 100%;
  height: 18px;
  border-radius: 6px;
}
progress::-webkit-progress-value {
  background: linear-gradient(45deg, #0b5ed7, #0056b3);
}

/* === Modal 樣式 === */
.modal {
  display: none;
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: rgba(0,0,0,0.6);
  justify-content: center;
  align-items: center;
  z-index: 1000;
}
.modal-content {
  background: #fff;
  border-radius: 8px;
  padding: 20px;
  text-align: center;
  width: 90%;
  max-width: 400px;
  max-height: 80vh;
  overflow-y: auto;
  position: relative;
}
.red-text { color: red; font-weight: bold; margin-bottom: 10px; }
</style>

<!-- === 圖片預覽 Modal === -->
<div id="imgModal" class="modal">
  <div class="modal-content">
    <button onclick="imgModal.style.display='none'" 
      style="position:absolute;top:6px;right:10px;background:none;border:none;font-size:24px;cursor:pointer;color:#666;">×</button>
    <div id="imgCarousel" style="display:flex;overflow-x:auto;scroll-snap-type:x mandatory;gap:10px;">
    </div>
  </div>
</div>

<!-- === 錄音 Modal === -->
<div id="recordModal" class="modal">
  <div class="modal-content" id="recordModalContent">
    <div class="red-text">錄音中</div>
    <button onclick="stopRecording()">停止錄音</button>
  </div>
</div>

<script>
const photos=[],thumbs=document.getElementById('thumbs');
const imgModal=document.getElementById('imgModal');
const imgCarousel=document.getElementById('imgCarousel');
const recordModal=document.getElementById('recordModal');
const fileCamera=document.getElementById('fileCamera');
const fileGallery=document.getElementById('fileGallery');

// === 相簿 ===
function openCamera(){fileCamera.click();}
function openGallery(){fileGallery.click();}
fileCamera.addEventListener('change',()=>{if(fileCamera.files[0])previewPhoto(fileCamera.files[0]);});
fileGallery.addEventListener('change',()=>{
  if(fileGallery.files.length){
    addPhotos([...fileGallery.files]);
    showImage(URL.createObjectURL(fileGallery.files[0]));
    alert('請確認照片');
  }
  fileGallery.value='';
});

function previewPhoto(file){
  const url=URL.createObjectURL(file);
  document.getElementById('cameraPreview').style.display='block';
  document.getElementById('cameraPhoto').src=url;
  fileCamera.dataset.photoFile=file;
}
function confirmPhoto(){
  const f=fileCamera.files[0];
  if(f){photos.push({file:f,url:URL.createObjectURL(f)});renderThumbs();}
  document.getElementById('cameraPreview').style.display='none';
}
function retakePhoto(){
  document.getElementById('cameraPreview').style.display='none';
  fileCamera.click();
}
function cancelPhoto(){
  document.getElementById('cameraPreview').style.display='none';
  fileCamera.value='';
}
function addPhotos(files){
  files.forEach(f=>{
    if(!f.type.startsWith('image/'))return;
    const url=URL.createObjectURL(f);
    photos.push({file:f,url});
  });
  renderThumbs();
}
function removePhoto(i){
  const p=photos.splice(i,1)[0];
  if(p&&p.url)URL.revokeObjectURL(p.url);
  renderThumbs();
}
function renderThumbs(){
  thumbs.innerHTML='';
  photos.forEach((p,i)=>{
    const d=document.createElement('div');
    d.className='thumb';
    d.innerHTML=`
      <img src="${p.url}">
      <div style="position:absolute;bottom:4px;left:4px;">
        <button style="background:#0b5ed7;border:none;color:#fff;font-size:12px;border-radius:4px;padding:2px 6px;" onclick="showImage('${p.url}')">預覽</button>
      </div>
      <button onclick="confirmDelete(${i})">×</button>`;
    thumbs.appendChild(d);
  });
}
function showImage(){
  imgCarousel.innerHTML=photos.map(p=>`
    <img src="${p.url}" style="max-height:70vh;scroll-snap-align:center;border-radius:6px;">
  `).join('');
  imgModal.style.display='flex';
}
function confirmDelete(i){
  if(confirm('確認刪除此照片？')) removePhoto(i);
}

// === 錄音 ===
let mediaRecorder=null,audioChunks=[],audioBlob=null;
async function startRecording(){
  try{
    const stream = await navigator.mediaDevices.getUserMedia({audio:true});
    mediaRecorder = new MediaRecorder(stream);
    audioChunks = [];
    mediaRecorder.ondataavailable = e => { if(e.data.size>0) audioChunks.push(e.data); };
    mediaRecorder.onstop = () => {
      stream.getTracks().forEach(t=>t.stop());
      audioBlob = new Blob(audioChunks, {type:'audio/webm'});
      showPlaybackModal();
    };
    recordModal.innerHTML = `
      <div class="modal-content">
        <div class="red-text">錄音中</div>
        <button onclick="stopRecording()">停止錄音</button>
      </div>`;
    recordModal.style.display = 'flex';
    mediaRecorder.start();
  }catch(e){ alert('無法使用麥克風'); }
}
function stopRecording(){
  if(mediaRecorder && mediaRecorder.state==='recording') mediaRecorder.stop();
}
function showPlaybackModal(){
  const url = URL.createObjectURL(audioBlob);
  recordModal.innerHTML = `
    <div class="modal-content">
      <div style="margin-bottom:10px;">請確認是否使用這段錄音</div>
      <audio controls src="${url}" style="width:100%;max-width:240px;"></audio>
      <div style="margin-top:15px;display:flex;justify-content:center;gap:20px;">
        <button style="background:#999;" onclick="cancelAudio()">取消</button>
        <button style="background:#0b5ed7;" onclick="confirmAudio()">確定</button>
      </div>
    </div>`;
}
function confirmAudio(){
  recordModal.style.display='none';
  document.getElementById('audioPlayback').src = URL.createObjectURL(audioBlob);
  document.getElementById('audioPlayback').style.display = 'block';
}
function cancelAudio(){
  recordModal.style.display='none';
  audioBlob = null;
}
</script>
</body>
</html>
