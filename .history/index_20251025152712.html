<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>災情回報系統</title>
<script src="https://static.line-scdn.net/liff/edge/versions/2.22.3/sdk.js"></script>

<!-- Firebase SDK -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-analytics.js";
import { getStorage, ref, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-storage.js";

const firebaseConfig = {
  apiKey: "AIzaSyA4IZ6yZxlOuIjarWmUtIHGyLk84056K2Q",
  authDomain: "reportsystem-c5fc7.firebaseapp.com",
  projectId: "reportsystem-c5fc7",
  storageBucket: "reportsystem-c5fc7.firebasestorage.app",
  messagingSenderId: "845064058181",
  appId: "1:845064058181:web:31d2f0fa6dfed084befa2c",
  measurementId: "G-EDQM0LWQWH"
};

const app = initializeApp(firebaseConfig);
const analytics = getAnalytics(app);
const storage = getStorage(app);
window.firebaseStorage = { getStorage, ref, uploadBytesResumable, getDownloadURL, storage };
</script>

<style>
body {
  font-family: Arial, sans-serif;
  background-color: #f5f8ff;
  color: #000;
  margin: 0;
  padding: 0;
}
.container {
  max-width: 800px;
  margin: 0 auto;
  padding: 20px;
}
.header {
  text-align: center;
  color: #000;
  border-bottom: 2px solid #0b5ed7;
  padding-bottom: 10px;
  margin-bottom: 20px;
}
.step-title {
  font-weight: 700;
  font-size: 22px;
  color: #000;
  margin-bottom: 14px;
}
.form-section {
  background: white;
  border-radius: 8px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  padding: 20px;
  margin-bottom: 20px;
}
button {
  padding: 10px 18px;
  margin: 6px 4px;
  background: #0b5ed7;
  color: #fff;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  font-size: 15px;
}
input[type="text"] {
  padding: 12px;
  width: 95%;
  border: 2px solid #ccc;
  border-radius: 6px;
  font-size: 16px;
  transition: all 0.2s ease;
  color: #000;
}
input[type="text"]:focus {
  border-color: #0b5ed7;
  box-shadow: 0 0 5px rgba(11,94,215,0.4);
  outline: none;
}
.form-section label {
  font-size: 21px;
  margin-bottom: 6px;
  display: inline-block;
}
.thumbs {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
  margin-top: 10px;
}
.thumb {
  position: relative;
  width: 90px;
  height: 90px;
  border-radius: 6px;
  overflow: hidden;
  border: 1px solid #ccc;
}
.thumb img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}
.thumb button {
  position: absolute;
  top: 4px;
  right: 4px;
  background: rgba(0,0,0,0.65);
  color: #fff;
  border: none;
  border-radius: 12px; /* 改為橢圓 */
  font-size: 15px;
  width: 26px;
  height: 18px;
  line-height: 16px;
  text-align: center;
  cursor: pointer;
}
.thumb .preview-btn {
  position: absolute;
  bottom: 4px;
  left: 4px;
  background: #0b5ed7;
  border: none;
  color: #fff;
  font-size: 12px;
  border-radius: 4px;
  padding: 2px 6px;
}

/* === Modal === */
.modal {
  display: none;
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: rgba(0,0,0,0.7);
  justify-content: center;
  align-items: center;
  z-index: 2000; /* 提升層級 */
  overflow: hidden;
}
.modal-content {
  background: #fff;
  border-radius: 8px;
  padding: 20px;
  text-align: center;
  width: 90%;
  max-width: 400px;
  max-height: 85vh;
  overflow-y: auto; /* 允許上下滾動 */
  position: relative;
}
.confirm-text {
  font-size: 22px;
  font-weight: bold;
  color: #000;
  margin-bottom: 15px;
}
.carousel {
  display: flex;
  overflow-x: auto;
  scroll-snap-type: x mandatory;
}
.carousel div {
  min-width: 100%;
  scroll-snap-align: center;
  display: flex;
  justify-content: center;
  align-items: center;
  position: relative;
}
.carousel img {
  max-height: 70vh;
  width: auto;
  border-radius: 6px;
}
/* 左右箭頭統一 */
.nav-btn {
  position: absolute;
  top: 50%;
  transform: translateY(-50%);
  background: rgba(0,0,0,0.5);
  border: none;
  color: white;
  font-size: 26px;
  padding: 10px 18px;
  cursor: pointer;
  border-radius: 6px;
  z-index: 10;
}
.nav-left { left: 10px; }
.nav-right { right: 10px; }

/* 預覽視窗內的操作按鈕（確認、刪除）統一樣式 */
.modal-content .action-buttons {
  margin-top: 15px;
  display: flex;
  justify-content: center;
  gap: 15px;
}
.modal-content .action-buttons button {
  background: #0b5ed7;
  color: #fff;
  border: none;
  border-radius: 6px;
  padding: 10px 18px;
  font-size: 15px;
  cursor: pointer;
}
.modal-content .action-buttons .delete-btn {
  background: #6c757d;
}
</style>
</head>

<body>
<!-- 預覽 Modal -->
<div id="imgModal" class="modal">
  <div class="modal-content">
    <div class="confirm-text" id="confirmText">請確認照片</div>
    <button onclick="imgModal.style.display='none'" 
      style="position:absolute;top:6px;right:10px;background:none;border:none;font-size:28px;cursor:pointer;color:#000;">×</button>
    <div id="imgCarousel" class="carousel"></div>
  </div>
</div>

<!-- 錄音 Modal -->
<div id="recordModal" class="modal">
  <div class="modal-content" id="recordModalContent">
    <div class="red-text">錄音中</div>
    <button onclick="stopRecording()">停止錄音</button>
  </div>
</div>

<div class="container">
  <div class="header"><h1>通報平台</h1></div>

  <!-- Step 1 -->
  <div class="form-section">
    <div class="step-title">① 上傳照片</div>
    <button onclick="openCamera()">開相機</button>
    <button onclick="openGallery()">開相簿</button>
    <div class="thumbs" id="thumbs"></div>
    <input id="fileCamera" type="file" accept="image/*" capture="environment" style="display:none;">
    <input id="fileGallery" type="file" accept="image/*" multiple style="display:none;">
  </div>
  <!-- Step 2 -->
  <div class="form-section">
    <div class="step-title">② 照片說明（可錄音）</div>
    <button id="recordBtn" onclick="startRecording()">開始錄音</button>
    <audio id="audioPlayback" controls style="display:none;width:100%;max-width:400px;"></audio>
    <div style="margin-top:20px;">
      <input type="text" id="summary" placeholder="可補充照片說明（非必填）" maxlength="50"/>
    </div>
  </div>

  <!-- Step 3 -->
  <div class="form-section">
    <div class="step-title">③ 是否有災情或異常情況？</div>
    <label><input type="radio" name="disaster" value="正常" checked onchange="toggleDisasterTypes()"> 正常</label>
    <label style="margin-left:25px;"><input type="radio" name="disaster" value="異常" onchange="toggleDisasterTypes()"> 異常</label>
    <div id="disasterTypes" style="display:none; margin-top:12px; line-height:2;">
      <label><input type="checkbox" name="disasterType" value="水利設施損害"> 水利設施損害</label><br>
      <label><input type="checkbox" name="disasterType" value="環境污染"> 環境污染</label><br>
      <label><input type="checkbox" name="disasterType" value="交通阻斷"> 交通阻斷</label>
    </div>
  </div>

  <!-- Submit -->
  <div class="form-section" style="text-align:center;">
    <button id="submitBtn" onclick="submitForm()">提交回報</button>
    <progress id="uploadProgress" value="0" max="100" style="display:none;margin-top:10px;"></progress>
    <div id="uploadStatus"></div>
    <div id="serverStatus">伺服器狀態：檢查中...</div>
  </div>
</div>

<script>
const WEB_APP_URL='https://script.google.com/macros/s/AKfycbyrVfdPQT4fmM4OTxEymk16AsgU_raKynnI7N0Ph1v8YPjiowhtAaPv4fCpKNkHhfs6Kg/exec';

liff.init({liffId:'2007934728-xN6aOL3D'}).then(async()=>{
  if(!liff.isLoggedIn()) liff.login();
  try{
    const r=await fetch(WEB_APP_URL);
    if(r.ok){
      document.getElementById('serverStatus').textContent='伺服器狀態：已連線';
      document.getElementById('serverStatus').style.color='#0b5ed7';
    }
  }catch{document.getElementById('serverStatus').textContent='伺服器狀態：無法連線';}
});

const photos=[],thumbs=document.getElementById('thumbs');
const imgModal=document.getElementById('imgModal');
const imgCarousel=document.getElementById('imgCarousel');
const recordModal=document.getElementById('recordModal');
const fileCamera=document.getElementById('fileCamera');
const fileGallery=document.getElementById('fileGallery');

function openCamera(){fileCamera.click();}
function openGallery(){fileGallery.click();}

fileCamera.addEventListener('change',()=>{if(fileCamera.files[0])confirmUpload([fileCamera.files[0]]);});
fileGallery.addEventListener('change',()=>{if(fileGallery.files.length)confirmUpload([...fileGallery.files]);fileGallery.value='';});

let blobCache = []; // 快取目前預覽中用到的 blob URL

function openPreview(type, filesOrPhotos, startIndex = 0) {
  let currentIndex = startIndex;
  const isConfirm = type === "confirm";
  const list = [...filesOrPhotos];
  clearBlobCache();

  // 建立快取一次性 URL
  blobCache = list.map((item) =>
    isConfirm ? URL.createObjectURL(item) : item.url
  );

  function setPhoto() {
    const imgEl = document.getElementById("modal-photo");
    imgEl.src = blobCache[currentIndex];
  }

  imgModal.innerHTML = `
    <div class="modal-content" style="text-align:center;position:relative;">
      <button id="closePreviewBtn"
        style="position:absolute;top:8px;right:15px;background:none;border:none;font-size:30px;cursor:pointer;color:#000;">×</button>
      <div class="confirm-text">${isConfirm ? "請確認照片" : "預覽照片"}</div>
      <img id="modal-photo" style="max-width:90%;max-height:65vh;border-radius:6px;">
      <div class="action-buttons">
        ${
          isConfirm
            ? `<button id="confirmAddBtn">確定</button>`
            : `<button id="confirmKeepBtn">確認</button>`
        }
        <button class="delete-btn" id="deleteBtn">刪除此張</button>
      </div>
      <button class="nav-btn nav-left" id="navLeft">&#10094;</button>
      <button class="nav-btn nav-right" id="navRight">&#10095;</button>
    </div>`;
  imgModal.style.display = "flex";
  setPhoto();

  // 綁定事件
  document.getElementById("navLeft").onclick = () => navigate(-1);
  document.getElementById("navRight").onclick = () => navigate(1);
  document.getElementById("closePreviewBtn").onclick = () => closePreview();
  document.getElementById("deleteBtn").onclick = () => deleteCurrent();
  if (isConfirm) {
    document.getElementById("confirmAddBtn").onclick = () => addPhotosFromConfirm();
  } else {
    document.getElementById("confirmKeepBtn").o

/* === 錄音 === */
let mediaRecorder=null,audioChunks=[],audioBlob=null;
async function startRecording(){
  try{
    const stream=await navigator.mediaDevices.getUserMedia({audio:true});
    mediaRecorder=new MediaRecorder(stream);
    audioChunks=[];
    mediaRecorder.ondataavailable=e=>{if(e.data.size>0)audioChunks.push(e.data);};
    mediaRecorder.onstop=()=>{
      stream.getTracks().forEach(t=>t.stop());
      audioBlob=new Blob(audioChunks,{type:'audio/webm'});
      showPlaybackModal();
    };
    recordModal.innerHTML=`
      <div class="modal-content">
        <div class="red-text">錄音中</div>
        <button onclick="stopRecording()">停止錄音</button>
      </div>`;
    recordModal.style.display='flex';
    mediaRecorder.start();
  }catch(e){alert('無法使用麥克風');}
}
function stopRecording(){
  if(mediaRecorder&&mediaRecorder.state==='recording')mediaRecorder.stop();
}
function showPlaybackModal(){
  const url=URL.createObjectURL(audioBlob);
  recordModal.innerHTML=`
    <div class="modal-content">
      <div style="margin-bottom:10px;">請確認是否使用這段錄音</div>
      <audio controls src="${url}" style="width:100%;max-width:400px;"></audio>
      <div style="margin-top:15px;display:flex;justify-content:center;gap:20px;">
        <button style="background:#007bff;" onclick="redoAudio()">重錄</button>
        <button style="background:#0b5ed7;" onclick="confirmAudio()">確定</button>
      </div>
    </div>`;
}
function confirmAudio(){
  recordModal.style.display='none';
  document.getElementById('audioPlayback').src=URL.createObjectURL(audioBlob);
  document.getElementById('audioPlayback').style.display='block';
}
function redoAudio(){
  recordModal.style.display='none';
  audioBlob=null;
  startRecording();
}

/* === 災情選擇 === */
function toggleDisasterTypes(){
  const abnormal=document.querySelector('input[name="disaster"]:checked').value==='異常';
  document.getElementById('disasterTypes').style.display=abnormal?'block':'none';
}

/* === Firebase 上傳 === */
async function compressImage(file){
  return new Promise(res=>{
    const img=new Image();
    img.onload=()=>{
      const c=document.createElement('canvas');
      const scale=Math.min(1,1280/img.width);
      c.width=img.width*scale;c.height=img.height*scale;
      c.getContext('2d').drawImage(img,0,0,c.width,c.height);
      c.toBlob(b=>res(new File([b],'photo.jpg',{type:'image/jpeg'})),'image/jpeg',0.7);
    };
    img.src=URL.createObjectURL(file);
  });
}

async function uploadToFirebase(file,path){
  const {ref,uploadBytesResumable,getDownloadURL}=window.firebaseStorage;
  const storageRef=ref(window.firebaseStorage.storage,path);
  const task=uploadBytesResumable(storageRef,file);
  return new Promise((res,rej)=>{
    task.on('state_changed',snap=>{
      const p=(snap.bytesTransferred/snap.totalBytes)*100;
      document.getElementById('uploadProgress').style.display='block';
      document.getElementById('uploadProgress').value=p;
      document.getElementById('uploadStatus').textContent=`上傳中 ${Math.round(p)}%`;
    },rej,async()=>res(await getDownloadURL(task.snapshot.ref)));
  });
}

async function transcribeAudio(blob,reportId){
  const buf=await blob.arrayBuffer();
  const arr=new Uint8Array(buf);
  let s='';for(let i=0;i<arr.length;i++)s+=String.fromCharCode(arr[i]);
  const b64=btoa(s);
  const fd=new FormData();
  fd.append('action','transcribe');
  fd.append('audioData',b64);
  fd.append('reportId',reportId);
  const r=await fetch(WEB_APP_URL,{method:'POST',body:fd});
  const t=await r.text();try{const j=JSON.parse(t);return j.transcription||'';}catch{return'';}
}

/* === 提交表單 === */
async function submitForm(){
  const summary=document.getElementById('summary').value.trim();
  const abnormal=document.querySelector('input[name="disaster"]:checked').value==='異常';
  const types=Array.from(document.querySelectorAll('input[name="disasterType"]:checked')).map(e=>e.value).join(',');
  document.getElementById('submitBtn').disabled=true;
  const ts=Date.now(),rid=`report_${ts}`,photoUrls=[];
  try{
    for(let i=0;i<photos.length;i++){
      const comp=await compressImage(photos[i].file);
      const url=await uploadToFirebase(comp,`reports/${rid}/photo_${i}.jpg`);
      photoUrls.push(url);
    }
    let audioUrl='',txt='';
    if(audioBlob){
      audioUrl=await uploadToFirebase(audioBlob,`reports/${rid}/recording.webm`);
      if(abnormal)txt=await transcribeAudio(audioBlob,rid);
    }
    const fd=new FormData();
    fd.append('summary',summary);
    fd.append('disasterType',types);
    fd.append('photoUrl',photoUrls.join(','));
    if(audioUrl)fd.append('audioUrl',audioUrl);
    fd.append('timestamp',ts.toString());
    fd.append('reportId',rid);
    const res=await fetch(WEB_APP_URL,{method:'POST',body:fd});
    const rj=await res.json();
    if(rj.result==='success'){alert('回報提交成功');location.reload();}
    else alert('提交失敗');
  }catch(e){alert('錯誤: '+e.message);}
  document.getElementById('submitBtn').disabled=false;
}
</script>
</body>
</html>
