<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>災情回報系統</title>
<script src="https://static.line-scdn.net/liff/edge/versions/2.22.3/sdk.js"></script>
<!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-analytics.js";
    import { getStorage, ref, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-storage.js";

    // Firebase 設定
    const firebaseConfig = {
      apiKey: "AIzaSyA4IZ6yZxlOuIjarWmUtIHGyLk84056K2Q",
      authDomain: "reportsystem-c5fc7.firebaseapp.com",
      projectId: "reportsystem-c5fc7",
      storageBucket: "reportsystem-c5fc7.firebasestorage.app",
      messagingSenderId: "845064058181",
      appId: "1:845064058181:web:31d2f0fa6dfed084befa2c",
      measurementId: "G-EDQM0LWQWH"
    };

    // 初始化 Firebase
    const app = initializeApp(firebaseConfig);
    const storage = getStorage(app);

    // 將 Firebase 功能暴露給全局使用
    window.firebaseStorage = { getStorage, ref, uploadBytesResumable, getDownloadURL, storage };
  </script>
<style>
/* === 基本排版設定 === */
body {
  font-family: Arial, sans-serif;
  background-color: #f5f8ff;  /* 背景顏色 */
  color: #000;                /* 文字顏色 */
  margin: 0;
  padding: 0;
}

/* 內容區域的最大寬度 */
.container {
  max-width: 800px;
  margin: 0 auto;   /* 居中 */
  padding: 20px;
}

/* 頁面標題樣式 */
.header {
  text-align: center;
  color: #000;
  border-bottom: 2px solid #0b5ed7; /* 底部藍色邊框 */
  padding-bottom: 10px;
  margin-bottom: 20px;
}

/* 步驟標題樣式 */
.step-title {
  font-weight: 700;
  font-size: 22px;
  color: #000;
  margin-bottom: 14px;
}

/* 表單區塊樣式 */
.form-section {
  background: white;
  border-radius: 8px;
  border: 2px solid #d0d7e2;  /* 輕灰色邊框 */
  padding: 20px;
  margin-bottom: 20px;
}

/* === 按鈕樣式統一設定 === */
.ui-btn {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  padding: 10px 18px;          /* 與相機/相簿按鈕一致的間距 */
  margin: 6px 4px;             /* 按鈕外邊距 */
  background: #0b5ed7;         /* 按鈕背景顏色 */
  color: #fff;                 /* 文字顏色 */
  border: none;                /* 去除邊框 */
  border-radius: 6px;          /* 圓角設計 */
  font-size: 21px;             /* 字體大小 */
  line-height: 1.2;            /* 行高設置，避免字太擠 */
  text-align: center;          /* 文字居中 */
  cursor: pointer;
  
  /* 用於觸控設備的優化 */
  -webkit-tap-highlight-color: transparent; 
  -webkit-user-select: none;  /* 禁止文字選擇 */
  user-select: none;          /* 禁止文字選擇 */
  
  /* 保證和整體頁面一致 */
  font-family: inherit;  
  box-sizing: border-box;     /* 保證邊框和內邊距不會影響尺寸計算 */
}

/* --- 可選：按鈕的其他狀態樣式 --- */
.ui-btn:active {
  filter: brightness(0.7);  /* 按鈕被按下時的亮度變暗效果 */
}

/* 紅色型 */
.ui-btn.red {
  background: #dc3545;
}

/* 灰色型 */
.ui-btn.gray {
  background: #60748f !important;
}

/* 藍色型 */
.ui-btn.blue {
  background: #0b5ed7;
}

/* === 縮圖 === */
.thumbs {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
  margin-top: 10px;
  align-items: flex-start;
}
.thumb {
  position: relative;
  width: 90px;
  height: 90px;
  flex: 0 0 auto;
  border-radius: 6px;
  overflow: hidden;
  border: 1px solid #ccc;
  background: #f9f9f9;
}
.thumb img {
  width: 100%;
  height: 100%;
  object-fit: cover;
  display: block;
}

/* 縮圖小叉叉 */
.thumb .delete-btn {
  position: absolute;
  top: 4px;
  right: 4px;
  background: rgba(220, 53, 69, 0.9);
  color: #fff;
  border: none;
  border-radius: 50%;
  font-size: 16px;
  width: 24px;
  height: 24px;
  line-height: 20px;
  text-align: center;
  cursor: pointer;
  padding: 0;
  -webkit-tap-highlight-color: transparent;
  transition: none;
  display: flex;
  align-items: center;
  justify-content: center;
}

/* 加號按鈕 */
.add-photo {
  width: 90px;
  height: 90px;
  flex: 0 0 auto;
  border: 2px dashed #9bb4e9;
  border-radius: 6px;
  display: flex;
  align-items: center;
  justify-content: center;
  color: #0b5ed7;
  font-size: 36px;
  cursor: pointer;
  background: #f0f4ff;
  transition: none;
}
.add-photo:active {
  background: #c0d2ff;
  filter: brightness(0.7);
}

/* === Modal === */
.modal {
  display: none;
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: rgba(0,0,0,0.7);
  justify-content: center;
  align-items: center;
  z-index: 2000;
}

/* Modal內容 */
.modal-content {
  background: #fff;
  border-radius: 8px;
  padding: 20px;
  width: 90%;
  max-width: 500px;
  max-height: 85vh;
  position: relative;
  overflow: hidden;
  text-align: center;
}

/* 標題與叉叉水平對齊 */
.header-line {
  display: flex;
  align-items: center;
  justify-content: center;
  position: relative;
  width: 100%;
  margin-bottom: 10px;
}
#modalTitle {
  font-size: 22px;
  font-weight: bold;
  color: #000;
  flex: 1;
  text-align: center;
}

/* 關閉叉叉 */
#closeModalBtn {
  position: absolute;
  right: 10px;
  top: 50%;
  transform: translateY(-50%);
  font-size: 40px;
  background: none;
  border: none;
  color: #000;
  cursor: pointer;
  -webkit-tap-highlight-color: transparent;
  transition: none;
  width: 40px;
  height: 40px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 50%;
}

/* === 預覽圖片自適應＋灰底＋邊框 === */
.preview-image-container {
  position: relative;
  display: flex;
  justify-content: center;
  align-items: center;
  width: 100%;
  max-width: 90vw;
  height: 70vh;
  margin: 15px auto;
  background: #f0f0f0;    /* 灰底 */
  border: 2px solid #d0d7e2; /* 淺灰邊框 */
  border-radius: 8px;
  overflow: hidden;
}

/* 圖片完整顯示、置中不裁切 */
.preview-image {
  max-width: 100%;
  max-height: 100%;
  width: auto;
  height: auto;
  object-fit: contain;
  display: block;
  margin: 0 auto;
  /*transition: opacity 0.3s ease;*/
}

/* 左右箭頭 */
.nav-btn {
  position: absolute;
  top: 50%;
  transform: translateY(-50%);
  background: rgba(0,0,0,0.45);
  border: none;
  color: #fff;
  font-size: 28px;
  padding: 10px 16px;
  cursor: pointer;
  border-radius: 8px;
  -webkit-tap-highlight-color: transparent;
  transition: none;
}
.nav-btn:active {
  background: rgba(0,0,0,0.35);
  filter: brightness(0.7);
}
.nav-btn.disabled {
  opacity: 0.35;
  pointer-events: none;
}
.nav-left { left: 10px; }
.nav-right { right: 10px; }

/* 固定背景 */
body.modal-open {
  overflow: hidden;
}

/* 操作按鈕區域 */
.action-buttons {
  margin-top: 15px;
  display: flex;
  justify-content: center;
  gap: 15px;
}

.action-buttons button {
  min-width: 100px;
  font-size: 21px;
}



/* === 統一互動灰暗回饋 === */

/* 確保所有按鈕都有相同的互動效果 */
button,
label.ui-btn,
.add-photo,
.nav-btn,
#closeModalBtn,
.thumb .delete-btn {
  -webkit-tap-highlight-color: transparent;
  -webkit-user-select: none;
  user-select: none;
  transition: none !important;
}

/* 移除 hover 效果，只保留 active 效果 */
button:hover,
label.ui-btn:hover,
.add-photo:hover,
.nav-btn:hover,
#closeModalBtn:hover,
.thumb .delete-btn:hover {
  filter: none !important;
}

/* 即時灰暗效果（所有互動元素共用） */
.temp-active {
  filter: brightness(0.7) !important;
  transition: none !important;
}

/* 其他表單元素 */
input[type="text"] {
  padding: 12px;
  width: 95%;
  border: 2px solid #ccc;
  border-radius: 6px;
  font-size: 16px;
  transition: all 0.2s ease;
  color: #000;
}
input[type="text"]:focus {
  border-color: #0b5ed7;
  box-shadow: 0 0 5px rgba(11,94,215,0.4);
  outline: none;
}
.form-section label {
  font-size: 21px;
  margin-bottom: 6px;
  display: inline-block;
}
/* === 載入圈樣式 === */
.spinner-circle {
  border: 5px solid #d0d7e2;
  border-top: 5px solid #0b5ed7;
  border-radius: 50%;
  width: 50px;
  height: 50px;
  animation: spin 1s linear infinite;
  margin: 0 auto 10px auto;
}
.spinner-text {
  color: #666;
  font-size: 18px;
}
@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}
@keyframes fadeOut {
  0% { opacity: 1; }
  80% { opacity: 1; }
  100% { opacity: 0; }
}
</style>
</head>

<body>
<!-- 預覽 Modal -->
<div id="imgModal" class="modal">
  <div class="modal-content">
    <div class="header-line">
      <div id="modalTitle">請確認照片</div>
      <label id="closeModalBtn" class="ui-btn" onclick="closePreviewModal()">×</label>
    </div>

    <div class="preview-image-container">
      <img id="previewImage" class="preview-image" src="">
      <label class="ui-btn nav-btn nav-left" id="navLeft" onclick="changePreview(-1)">&#10094;</label>
      <label class="ui-btn nav-btn nav-right" id="navRight" onclick="changePreview(1)">&#10095;</label>
    </div>

    <div class="action-buttons">
      <label id="deleteCurrentBtn" class="ui-btn red" onclick="deletePreviewPhoto()">刪除這張</label>
      <label id="confirmBtn" class="ui-btn blue" onclick="handleConfirm()">確認完成</label>
    </div>
  </div>
</div>

<div class="container">
  <div class="header"><h1>通報平台</h1></div>

  <!-- Step 1 -->
  <div class="form-section">
    <div class="step-title">① 新增照片（1~20 張）</div>

    <label id="openCameraBtn" class="ui-btn" onclick="openCamera()">開相機</label>
<input id="fileCamera" type="file" accept="image/*" capture="environment" style="display:none;">

<label id="openGalleryBtn" class="ui-btn" onclick="openGallery()">開相簿</label>
<input id="fileGallery" type="file" accept="image/*" multiple style="display:none;">

    <div class="thumbs" id="thumbs"></div>
  </div>

  <!-- Step 2 -->

  <div class="form-section">
    <div class="step-title">② 照片說明（可錄音）</div>
    <label id="recordBtn" class="ui-btn" onclick="startRecording()">開始錄音</label>
    <audio id="audioPlayback" controls style="display:none;width:100%;max-width:400px;"></audio>
    <div style="margin-top:20px;">
      <input type="text" id="summary" placeholder="可補充照片說明（非必填）" maxlength="50"/>
    </div>
  </div>

  <!-- Step 3 -->
  <div class="form-section">
    <div class="step-title">③ 是否有災情或異常情況？</div>
    <label><input type="radio" name="disaster" value="正常" checked onchange="toggleDisasterTypes()"> 正常</label>
    <label style="margin-left:25px;"><input type="radio" name="disaster" value="異常" onchange="toggleDisasterTypes()"> 異常</label>
    <div id="disasterTypes" style="display:none; margin-top:12px; line-height:2;">
      <label><input type="checkbox" name="disasterType" value="水利設施損害"> 水利設施損害</label><br>
      <label><input type="checkbox" name="disasterType" value="環境污染"> 環境污染</label><br>
      <label><input type="checkbox" name="disasterType" value="交通阻斷"> 交通阻斷</label>
    </div>
  </div>

  <!-- Submit -->
  <div class="form-section" style="text-align:center;">
    <label id="submitBtn" class="ui-btn" onclick="submitForm()">提交回報</label>
    <div id="serverStatus">伺服器狀態：檢查中...</div>
  </div>
</div>

<script>
const WEB_APP_URL='https://script.google.com/macros/s/AKfycbyrVfdPQT4fmM4OTxEymk16AsgU_raKynnI7N0Ph1v8YPjiowhtAaPv4fCpKNkHhfs6Kg/exec';

// 初始化 LIFF
liff.init({liffId:'2007934728-xN6aOL3D'}).then(async()=>{
  if(!liff.isLoggedIn()) liff.login();
  try{
    const r=await fetch(WEB_APP_URL);
    if(r.ok){
      document.getElementById('serverStatus').textContent='伺服器狀態：已連線';
      document.getElementById('serverStatus').style.color='#0b5ed7';
    }
  }catch{
    document.getElementById('serverStatus').textContent='伺服器狀態：無法連線';
  }
});

// === 照片變數 ===
const photos = [];
const thumbs = document.getElementById("thumbs");
const imgModal = document.getElementById("imgModal");
const fileCamera = document.getElementById("fileCamera");
const fileGallery = document.getElementById("fileGallery");
const MAX_TOTAL = 20;
const MAX_PER_BATCH = 20;
// 偵測 iPhone 裝置
const isiPhone = /iPhone|iPad|iPod/i.test(navigator.userAgent);

// === 預覽狀態 ===
let previewMode = ""; // confirm | preview
let previewFiles = [];
let previewIndex = 0;
let skipNextAddTip = false; // ← 新增變數
let isSelectingSource = false; // iPhone 選擇來源中標記

async function makePreviewURLs(files) {
  const urls = [];
  for (const f of files) {
    const reader = new FileReader();
    const url = await new Promise(res => {
      reader.onload = () => res(reader.result);
      reader.readAsDataURL(f);
    });
    urls.push({ file: f, url });
  }
  return urls;
}

function safeCreateURL(file) {
  try {
    return URL.createObjectURL(file);
  } catch {
    const reader = new FileReader();
    return new Promise(resolve => {
      reader.onload = () => resolve(reader.result);
      reader.readAsDataURL(file);
    });
  }
}

function disableAddButtons() {
  document.querySelectorAll(".add-photo, #openCameraBtn, #openGalleryBtn").forEach(btn => {
    if (!btn) return;

    // 保持可點，但變淡
    btn.style.opacity = "0.4";
    btn.style.filter = "grayscale(50%)";
    btn.style.pointerEvents = ""; // 不禁用，仍可觸發提示
    btn.onclick = () => showMessage("無法新增，已達 20 張上限");
  });

  fileCamera.disabled = false;
  fileGallery.disabled = false;
}

function enableAddButtons() {
  document.querySelectorAll(".add-photo, #openCameraBtn, #openGalleryBtn").forEach(btn => {
    if (!btn) return;

    // 恢復正常樣式
    btn.style.opacity = "1";
    btn.style.filter = "none";
    btn.style.pointerEvents = "";

    // 重新綁回原有行為
    if (btn.classList.contains("add-photo")) {
      btn.onclick = () => showAddLimitMessage(() => fileGallery.click());
    } else if (btn.id === "openCameraBtn") {
      btn.onclick = openCamera;
    } else if (btn.id === "openGalleryBtn") {
      btn.onclick = openGallery;
    }
  });

  fileCamera.disabled = false;
  fileGallery.disabled = false;
}

function showAddLimitMessage(openAction) {
  if (photos.length >= MAX_TOTAL) {
    showMessage("無法新增，已達 20 張上限");
    return;
  }

  // iPhone：直接開選單，選完後再跳提示
  if (isiPhone) {
    fileGallery.click();

    const handleBlur = () => {
      fileGallery.removeEventListener("blur", handleBlur);
      setTimeout(() => {
        const remainAfter = MAX_TOTAL - photos.length;
        if (remainAfter <= 0) return;
        if (remainAfter < MAX_TOTAL)
          showMessage(`您還可以新增 <b>${remainAfter}</b> 張照片`);
      }, 400);
    };
    fileGallery.addEventListener("blur", handleBlur);
    return;
  }

  // 其他裝置維持原本行為
  if (skipNextAddTip) {
    skipNextAddTip = false;
    if (typeof openAction === "function") openAction();
    return;
  }

  const remain = MAX_TOTAL - photos.length;
  showMessage(`您還可以新增 <b>${remain}</b> 張照片`, openAction);
}

function openGallery() {
  const remain = MAX_TOTAL - photos.length;
  if (remain <= 0) {
    showMessage("無法新增，已達 20 張上限");
    return;
  }

  // iPhone：先開選單，選完再跳提示
  if (isiPhone) {
    fileGallery.click();

    const handleBlur = () => {
      fileGallery.removeEventListener("blur", handleBlur);
      setTimeout(() => {
        const remainAfter = MAX_TOTAL - photos.length;
        if (remainAfter <= 0) return;
        if (remainAfter < MAX_TOTAL)
          showMessage(`您還可以新增 <b>${remainAfter}</b> 張照片`);
      }, 400);
    };
    fileGallery.addEventListener("blur", handleBlur);
    return;
  }

  // 其他裝置：維持舊邏輯
  if (skipNextAddTip) {
    skipNextAddTip = false;
    fileGallery.click();
    return;
  }

  if (remain === MAX_TOTAL) {
    fileGallery.click();
    return;
  }

  showMessage(`您還可以新增 <b>${remain}</b> 張照片`, () => {
    fileGallery.click();
  });
}

function openCamera() {
  const remain = MAX_TOTAL - photos.length;
  if (remain <= 0) {
    showMessage("無法新增，已達 20 張上限");
    return;
  }
  fileCamera.click();
}

fileCamera.addEventListener("change", () => {
  if (fileCamera.files[0]) confirmUpload([fileCamera.files[0]]);
  fileCamera.value = "";
});

fileGallery.addEventListener("change", () => {
  document.getElementById("customModal")?.remove(); // ← 開相簿後回來時移除舊提示
  if (!fileGallery.files.length) return;

  const remaining = MAX_TOTAL - photos.length;
  const selected = fileGallery.files.length;

  if (selected > MAX_PER_BATCH) {
  showMessage(
    `超過 <span style="color:red;font-weight:bold;">${MAX_PER_BATCH}</span> 張上限，請重新選擇`
  );
  fileGallery.value = "";
  return;
}

  if (selected > remaining) {
  showMessage(
    `只能新增 <span style="color:red;font-weight:bold;">${remaining}</span> 張，請重新選擇`
  );
  skipNextAddTip = true; // 下一次開相簿不跳提示

  // 延遲清空避免閃爍
  setTimeout(() => {
    fileGallery.value = "";
  }, 300);
  return;
}

  confirmUpload([...fileGallery.files]);
  fileGallery.value = "";
});

// === iPhone: 選單彈出後顯示提示窗（視覺同步） ===
fileGallery.addEventListener("focus", () => {
  if (!isiPhone) return;

  const remain = MAX_TOTAL - photos.length;
  if (remain <= 0) {
    fileGallery.blur();
    showMessage("無法新增，已達 20 張上限");
    return;
  }

  // 等 iOS 選單彈出後再顯示提示（不搶焦點）
  setTimeout(() => {
    const active = document.activeElement === fileGallery;
    if (active) {
      showMessage(`您還可以新增 <b>${remain}</b> 張照片`);
    }
  }, 600); // 0.6 秒延遲最自然
});

function renderThumbs() {
  thumbs.innerHTML = "";  // 清空縮圖區域

  // 渲染所有照片縮圖
  photos.forEach((p, i) => {
    const div = createThumbnail(p.url, i);  // 生成縮圖
    thumbs.appendChild(div);
  });

  // 預加載圖片（懶加載）
  lazyLoadImages();

  // 如果還有空間，顯示新增照片按鈕
  if (photos.length < MAX_TOTAL) {
    const addBtn = createAddPhotoButton();
    thumbs.appendChild(addBtn);
    enableAddButtons();
  } else {
    disableAddButtons();
  }

  // 顯示已上傳的照片數量以及預覽按鈕
  if (photos.length > 0) {
    const row = createPhotoCountRow();
    thumbs.appendChild(row);
  }
}

// 創建單張圖片縮圖
function createThumbnail(url, index) {
  const div = document.createElement("div");
  div.className = "thumb";

  const img = document.createElement("img");
  img.dataset.src = url;
  img.onerror = () => handleImageError(img);  // 圖片錯誤處理

  div.appendChild(img);
  const del = createDeleteButton(index);  // 創建刪除按鈕
  div.appendChild(del);

  return div;
}

// 圖片錯誤處理：替換圖片為錯誤訊息
function handleImageError(img) {
  img.replaceWith(Object.assign(document.createElement("div"), {
    textContent: "⚠️",
    style: "color:#d32f2f;font-size:18px;text-align:center;padding:10px;"
  }));
}

// 創建刪除按鈕
function createDeleteButton(index) {
  const del = document.createElement("button");
  del.className = "delete-btn";
  del.textContent = "×";
  del.onclick = () => showConfirmDialog("確定要刪除這張照片？", () => removePhoto(index));
  return del;
}

// 懶加載圖片：使用 IntersectionObserver
function lazyLoadImages() {
  const imgs = thumbs.querySelectorAll("img[data-src]");
  const observer = new IntersectionObserver(
    entries => {
      entries.forEach(entry => {
        if (entry.isIntersecting) {
          const img = entry.target;
          img.src = img.dataset.src;  // 設定圖片源
          observer.unobserve(img);  // 停止監控已顯示的圖片
        }
      });
    },
    { rootMargin: "200px" }  // 預加載的範圍設為 200px
  );
  imgs.forEach(img => observer.observe(img));  // 開始監控圖片
}

// 創建新增照片按鈕
function createAddPhotoButton() {
  const addBtn = document.createElement("div");
  addBtn.className = "add-photo";
  addBtn.innerHTML = "+";
  addBtn.onclick = () => showAddLimitMessage(() => fileGallery.click());
  return addBtn;
}

// 顯示已上傳的照片數量、分隔線和預覽按鈕
function createPhotoCountRow() {
  const row = document.createElement("div");
  row.style.textAlign = "center";
  row.style.width = "100%";

  const hr = createDivider();  // 創建分隔線
  row.appendChild(hr);

  const countInfo = createPhotoCountInfo();  // 顯示照片數量信息
  row.appendChild(countInfo);

  const previewBtn = createPreviewButton();  // 預覽按鈕
  row.appendChild(previewBtn);

  return row;
}

// 創建分隔線
function createDivider() {
  const hr = document.createElement("div");
  Object.assign(hr.style, {
    width: "90%",
    height: "1px",
    background: "#ccc",
    margin: "16px auto 12px auto",
    border: "none",
  });
  return hr;
}

// 顯示照片數量的訊息
function createPhotoCountInfo() {
  const countInfo = document.createElement("div");
  countInfo.id = "photoCountInfo";
  countInfo.style.marginBottom = "8px";
  countInfo.style.fontSize = "20px";
  countInfo.style.color = "#555";

  const remain = MAX_TOTAL - photos.length;
  countInfo.innerHTML = `目前共 <b>${photos.length}</b> 張，可再新增 <b>${remain}</b> 張`;

  return countInfo;
}

// 創建預覽按鈕
function createPreviewButton() {
  const previewBtn = document.createElement("button");
  previewBtn.className = "preview-all-btn ui-btn gray";
  previewBtn.textContent = "預覽照片";
  previewBtn.onclick = () => showImage(0);  // 預覽照片的第一張
  return previewBtn;
}

function removePhoto(index) {
  URL.revokeObjectURL(photos[index].url);
  photos.splice(index, 1);
  renderThumbs();
  enableAddButtons(); // ← 加這行
}

async function confirmUpload(files) {
  if (!files?.length) return;
  if (photos.length + files.length > MAX_TOTAL) {
    showMessage("超過上限 20 張，請重新上傳");
    return;
  }

  const img = document.getElementById("previewImage");
  const title = document.getElementById("modalTitle");
  const container = document.querySelector(".preview-image-container");
  const deleteBtn = document.getElementById("deleteCurrentBtn");
  const confirmBtn = document.getElementById("confirmBtn");

  // 1️⃣ 立即顯示載入中畫面
  title.textContent = "請確認照片";
  imgModal.style.display = "flex";
  document.body.style.overflow = "hidden";
  img.removeAttribute("src");
  img.style.opacity = "0";

  const overlay = document.createElement("div");
  overlay.id = "loadingSpinner";
  overlay.innerHTML = `
    <div class="spinner-circle"></div>
    <div class="spinner-text" style="font-size:22px;">照片載入中...</div>
  `;
  Object.assign(overlay.style, {
    display: "flex",
    flexDirection: "column",
    alignItems: "center",
    justifyContent: "center",
    position: "absolute",
    inset: "0",
    background: "rgba(255,255,255,0.95)",
    zIndex: "10",
    borderRadius: "8px"
  });
  container.appendChild(overlay);

  // 2️⃣ 給瀏覽器一幀時間把畫面畫出
  await new Promise(r => setTimeout(r, 50));

  // 3️⃣ 再啟動壓縮，放進下一幀執行，避免卡 UI
  requestAnimationFrame(async () => {
    previewMode = "confirm";

    // 並行壓縮所有圖片
    previewFiles = await Promise.all(
      files.map(async f => {
        const small = await compressImage(f);
        return { file: small, url: URL.createObjectURL(small) };
      })
    );

    overlay.remove();
    setupPreviewModal();
    updatePreviewImage();
    updateNavButtons();

    [deleteBtn, confirmBtn].forEach(btn => {
      btn.classList.remove("disabled");
      btn.style.pointerEvents = "";
      btn.style.opacity = "1";
      btn.style.filter = "none";
    });

    img.onload = () => {
      img.style.transition = "opacity 0.3s ease";
      img.style.opacity = "1";
    };
  });
}

function updateNavButtons() {
  const leftBtn = document.getElementById("navLeft");
  const rightBtn = document.getElementById("navRight");
  const total = previewFiles.length;
  leftBtn.classList.toggle("disabled", previewIndex <= 0);
  rightBtn.classList.toggle("disabled", previewIndex >= total - 1);
  leftBtn.style.pointerEvents = leftBtn.classList.contains("disabled") ? "none" : "";
  rightBtn.style.pointerEvents = rightBtn.classList.contains("disabled") ? "none" : "";
}

function setupPreviewModal() {
  document.getElementById("closeModalBtn").onclick = closePreviewModal;
  document.getElementById("navLeft").onclick = () => changePreview(-1);
  document.getElementById("navRight").onclick = () => changePreview(1);
  document.getElementById("confirmBtn").onclick = handleConfirm;
  document.getElementById("deleteCurrentBtn").onclick = deletePreviewPhoto;
  document.body.style.overflow = "hidden";
}

function showImage(index = 0) {
  if (photos.length === 0) return;
  const img = document.getElementById("previewImage");
  const leftBtn = document.getElementById("navLeft");
  const rightBtn = document.getElementById("navRight");
  const deleteBtn = document.getElementById("deleteCurrentBtn");
  const confirmBtn = document.getElementById("confirmBtn");

  previewMode = "preview";
  previewFiles = photos.map(p => ({ file: p.file, url: p.url }));
  previewIndex = index;

  img.removeAttribute("src");
  img.style.opacity = "0";
  imgModal.style.display = "flex";
  document.body.style.overflow = "hidden";

  setupPreviewModal();
  updatePreviewImage();
  updateNavButtons();

  [deleteBtn, confirmBtn].forEach(btn => {
    btn.classList.remove("disabled");
    btn.style.pointerEvents = "";
  });

  confirmBtn.style.display = "none";

  img.onload = () => {
    img.style.transition = "opacity 0.3s ease";
    img.style.opacity = "1";
  };
}

function closePreviewModal() {
  imgModal.style.display = "none";
  previewFiles = [];
  previewIndex = 0;
  document.body.style.overflow = "auto";
}

function updatePreviewImage() {
  const img = document.getElementById("previewImage");
  const title = document.getElementById("modalTitle");
  const container = document.querySelector(".preview-image-container");
  const leftBtn = document.getElementById("navLeft");
  const rightBtn = document.getElementById("navRight");

  document.getElementById("errorMessage")?.remove();
  if (previewFiles.length === 0) return;

  const total = previewFiles.length;
  const current = previewIndex + 1;
  title.textContent =
    previewMode === "confirm"
      ? `請確認照片 (${current}/${total})`
      : `預覽照片 (${current}/${total})`;

  const newSrc = previewFiles[previewIndex].url;
  img.onerror = () => {
    img.removeAttribute("src");
    showPhotoError(container);
  };
  img.style.opacity = "0";
  img.src = newSrc;
  requestAnimationFrame(() => {
    img.style.transition = "opacity 0.3s ease";
    img.style.opacity = "1";
  });

  const confirmBtn = document.getElementById("confirmBtn");
  confirmBtn.style.display = previewMode === "confirm" ? "inline-block" : "none";
  if (previewMode === "confirm") confirmBtn.textContent = "確認完成";

  document.getElementById("deleteCurrentBtn").textContent = "刪除這張";
  leftBtn.classList.toggle("disabled", previewIndex === 0);
  rightBtn.classList.toggle("disabled", previewIndex === total - 1);
}

function showPhotoError(container) {
  if (document.getElementById("errorMessage")) return;

  const errBox = document.createElement("div");
  errBox.id = "errorMessage";
  errBox.innerHTML = `
    <div style="font-size:48px;line-height:1;color:#d32f2f;">⚠️</div>
    <div style="color:#d32f2f;font-size:22px;font-weight:600;margin-top:10px;">
      錯誤，請重新上傳這張照片
    </div>
  `;

  Object.assign(errBox.style, {
    position: "absolute",
    top: "50%",
    left: "50%",
    transform: "translate(-50%, -50%)",
    background: "rgba(255,255,255,0.92)",
    border: "2px solid #d32f2f",
    borderRadius: "10px",
    padding: "20px 28px",
    textAlign: "center",
    zIndex: "15",
    pointerEvents: "none",
    boxShadow: "0 2px 8px rgba(0,0,0,0.25)"
  });

  container.appendChild(errBox);
}

function deletePreviewPhoto() {
  showConfirmDialog("確定要刪除這張照片？", () => {
    const removed = previewFiles.splice(previewIndex, 1)[0];
    if (removed.url?.startsWith("blob:")) URL.revokeObjectURL(removed.url);

    if (previewMode === "preview") {
      const idx = photos.findIndex(x => x.url === removed.url);
      if (idx >= 0) photos.splice(idx, 1);
      renderThumbs();
      enableAddButtons(); // ← 加這行
    }

    if (previewFiles.length === 0) {
      closePreviewModal();
    } else {
      if (previewIndex >= previewFiles.length) previewIndex = previewFiles.length - 1;
      updatePreviewImage();
      updateNavButtons();
    }
  });
}

// === 通用自訂確認提示窗 ===
function showConfirmDialog(message, onConfirm) {
  document.getElementById("confirmDialog")?.remove();

  const overlay = document.createElement("div");
  overlay.id = "confirmDialog";
  Object.assign(overlay.style, {
    position: "fixed",
    inset: "0",
    background: "rgba(0,0,0,0.6)",
    display: "flex",
    alignItems: "center",
    justifyContent: "center",
    zIndex: "9999",
  });

  const box = document.createElement("div");
  Object.assign(box.style, {
    background: "#fff",
    color: "#000",
    borderRadius: "12px",
    padding: "32px 44px",
    fontSize: "22px",
    textAlign: "center",
    maxWidth: "80%",
    boxShadow: "0 4px 20px rgba(0,0,0,0.3)",
  });
  box.innerHTML = message;

  const btnRow = document.createElement("div");
  Object.assign(btnRow.style, {
    display: "flex",
    justifyContent: "center",
    gap: "30px",
    marginTop: "28px",
  });

  const cancelBtn = document.createElement("button");
  cancelBtn.textContent = "取消";
  Object.assign(cancelBtn.style, {
    padding: "10px 26px",
    fontSize: "20px",
    borderRadius: "8px",
    border: "1px solid #999",
    background: "#eee",
    color: "#333",
  });
  cancelBtn.onclick = () => overlay.remove();

  const confirmBtn = document.createElement("button");
  confirmBtn.textContent = "確定";
  Object.assign(confirmBtn.style, {
    padding: "10px 26px",
    fontSize: "20px",
    borderRadius: "8px",
    border: "none",
    background: "#d32f2f",
    color: "#fff",
  });
  confirmBtn.onclick = () => {
    overlay.remove();
    if (typeof onConfirm === "function") onConfirm();
  };

  btnRow.append(cancelBtn, confirmBtn);
  box.appendChild(btnRow);
  overlay.appendChild(box);
  document.body.appendChild(overlay);
}

function handleConfirm() {
  if (previewMode === "confirm") {
    previewFiles.forEach(p => {
      if (photos.length < MAX_TOTAL) photos.push({ file: p.file, url: p.url });
    });
    renderThumbs();
    enableAddButtons(); // ← 加這行
  }
  closePreviewModal();
  previewFiles.forEach(p => {
    if (p.url?.startsWith("blob:")) URL.revokeObjectURL(p.url);
  });
}

function changePreview(dir) {
  const next = previewIndex + dir;
  if (next < 0 || next >= previewFiles.length) return;
  previewIndex = next;
  updatePreviewImage();
  updateNavButtons();
}

function showMessage(text, onConfirm) {
  document.getElementById("customModal")?.remove();
  const overlay = document.createElement("div");
  overlay.id = "customModal";
  Object.assign(overlay.style, {
    position: "fixed",
    inset: "0",
    background: "rgba(0,0,0,0.6)",
    display: "flex",
    alignItems: "center",
    justifyContent: "center",
    zIndex: "9999",
  });
  const box = document.createElement("div");
  Object.assign(box.style, {
    background: "#fff",
    color: "#000",
    borderRadius: "12px",
    padding: "30px 40px",
    fontSize: "22px",
    textAlign: "center",
    maxWidth: "80%",
    boxShadow: "0 4px 20px rgba(0,0,0,0.3)",
  });
  box.innerHTML = text;

  const btn = document.createElement("button");
  btn.textContent = "確定";
  Object.assign(btn.style, {
    marginTop: "24px",
    fontSize: "20px",
    padding: "10px 28px",
    borderRadius: "8px",
    border: "none",
    background: "#0b5ed7",
    color: "#fff",
  });

  // ← 只改這段：先移除視窗，連續兩次 rAF 確保完成重繪，再執行 onConfirm（開相簿）
  btn.onclick = () => {
    overlay.remove();
    requestAnimationFrame(() => {
      requestAnimationFrame(() => {
        if (typeof onConfirm === "function") onConfirm();
      });
    });
  };

  box.appendChild(document.createElement("br"));
  box.appendChild(btn);
  overlay.appendChild(box);
  document.body.appendChild(overlay);
}

window.addEventListener("beforeunload", () => {
  photos.forEach(p => URL.revokeObjectURL(p.url));
});

async function compressImage(file, maxWidth = 1280, maxHeight = 1280) {
  return new Promise(resolve => {
    const img = new Image();
    img.onload = () => {
      const canvas = document.createElement("canvas");
      let { width, height } = img;
      const ratio = Math.min(maxWidth / width, maxHeight / height, 1);
      canvas.width = width * ratio;
      canvas.height = height * ratio;
      const ctx = canvas.getContext("2d");
      ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
      canvas.toBlob(
        blob => resolve(new File([blob], file.name, { type: "image/jpeg" })),
        "image/jpeg",
        0.8
      );
    };
    img.src = URL.createObjectURL(file);
  });
}

/* === 錄音 === */
let mediaRecorder=null,audioChunks=[],audioBlob=null;
async function startRecording(){
  try{
    const stream=await navigator.mediaDevices.getUserMedia({audio:true});
    mediaRecorder=new MediaRecorder(stream);
    audioChunks=[];
    mediaRecorder.ondataavailable=e=>{if(e.data.size>0)audioChunks.push(e.data);};
    mediaRecorder.onstop=()=>{
      stream.getTracks().forEach(t=>t.stop());
      audioBlob=new Blob(audioChunks,{type:'audio/webm'});
      showPlaybackModal();
    };
    recordModal.innerHTML=`
      <div class="modal-content">
        <div class="red-text">錄音中</div>
        <button onclick="stopRecording()">停止錄音</button>
      </div>`;
    recordModal.style.display='flex';
    mediaRecorder.start();
  }catch(e){alert('無法使用麥克風');}
}
function stopRecording(){
  if(mediaRecorder&&mediaRecorder.state==='recording')mediaRecorder.stop();
}
function showPlaybackModal(){
  const url=URL.createObjectURL(audioBlob);
  recordModal.innerHTML=`
    <div class="modal-content">
      <div style="margin-bottom:10px;">請確認是否使用這段錄音</div>
      <audio controls src="${url}" style="width:100%;max-width:400px;"></audio>
      <div style="margin-top:15px;display:flex;justify-content:center;gap:20px;">
        <button style="background:#007bff;" onclick="redoAudio()">重錄</button>
        <button style="background:#0b5ed7;" onclick="confirmAudio()">確定</button>
      </div>
    </div>`;
}
function confirmAudio(){
  recordModal.style.display='none';
  document.getElementById('audioPlayback').src=URL.createObjectURL(audioBlob);
  document.getElementById('audioPlayback').style.display='block';
}
function redoAudio(){
  recordModal.style.display='none';
  audioBlob=null;
  startRecording();
}

/* === 災情選擇 === */
function toggleDisasterTypes(){
  const abnormal=document.querySelector('input[name="disaster"]:checked').value==='異常';
  document.getElementById('disasterTypes').style.display=abnormal?'block':'none';
}

/* === Firebase 上傳 === */
async function compressImage(file){
  return new Promise(res=>{
    const img=new Image();
    img.onload=()=>{
      const c=document.createElement('canvas');
      const scale=Math.min(1,1280/img.width);
      c.width=img.width*scale;c.height=img.height*scale;
      c.getContext('2d').drawImage(img,0,0,c.width,c.height);
      c.toBlob(b=>res(new File([b],'photo.jpg',{type:'image/jpeg'})),'image/jpeg',0.7);
    };
    img.src=URL.createObjectURL(file);
  });
}

async function uploadToFirebase(file,path){
  const {ref,uploadBytesResumable,getDownloadURL}=window.firebaseStorage;
  const storageRef=ref(window.firebaseStorage.storage,path);
  const task=uploadBytesResumable(storageRef,file);
  return new Promise((res,rej)=>{
    task.on('state_changed',snap=>{
      const p=(snap.bytesTransferred/snap.totalBytes)*100;
      document.getElementById('uploadProgress').style.display='block';
      document.getElementById('uploadProgress').value=p;
      document.getElementById('uploadStatus').textContent=`上傳中 ${Math.round(p)}%`;
    },rej,async()=>res(await getDownloadURL(task.snapshot.ref)));
  });
}

async function transcribeAudio(blob,reportId){
  const buf=await blob.arrayBuffer();
  const arr=new Uint8Array(buf);
  let s='';for(let i=0;i<arr.length;i++)s+=String.fromCharCode(arr[i]);
  const b64=btoa(s);
  const fd=new FormData();
  fd.append('action','transcribe');
  fd.append('audioData',b64);
  fd.append('reportId',reportId);
  const r=await fetch(WEB_APP_URL,{method:'POST',body:fd});
  const t=await r.text();try{const j=JSON.parse(t);return j.transcription||'';}catch{return'';}
}

/* === 提交表單 === */
async function submitForm(){
  const summary=document.getElementById('summary').value.trim();
  const abnormal=document.querySelector('input[name="disaster"]:checked').value==='異常';
  const types=Array.from(document.querySelectorAll('input[name="disasterType"]:checked')).map(e=>e.value).join(',');
  document.getElementById('submitBtn').disabled=true;
  const ts=Date.now(),rid=`report_${ts}`,photoUrls=[];
  try{
    for(let i=0;i<photos.length;i++){
      const comp=await compressImage(photos[i].file);
      const url=await uploadToFirebase(comp,`reports/${rid}/photo_${i}.jpg`);
      photoUrls.push(url);
    }
    let audioUrl='',txt='';
    if(audioBlob){
      audioUrl=await uploadToFirebase(audioBlob,`reports/${rid}/recording.webm`);
      if(abnormal)txt=await transcribeAudio(audioBlob,rid);
    }
    const fd=new FormData();
    fd.append('summary',summary);
    fd.append('disasterType',types);
    fd.append('photoUrl',photoUrls.join(','));
    if(audioUrl)fd.append('audioUrl',audioUrl);
    fd.append('timestamp',ts.toString());
    fd.append('reportId',rid);
    const res=await fetch(WEB_APP_URL,{method:'POST',body:fd});
    const rj=await res.json();
    if(rj.result==='success'){alert('回報提交成功');location.reload();}
    else alert('提交失敗');
  }catch(e){alert('錯誤: '+e.message);}
  document.getElementById('submitBtn').disabled=false;
}
</script>
</body>